<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project_73 - Grid Development [Refactored Step 3]</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK v10 -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, increment, query, where, orderBy, limit, getDocs, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    // Firebase konfigurace
    const firebaseConfig = {
      apiKey: "AIzaSyDdKzUd-QVHEdHMGl3kbuAKk4p6CjgkgzQ",
      authDomain: "central-asset-storage.firebaseapp.com",
      projectId: "central-asset-storage",
      storageBucket: "central-asset-storage.appspot.com",
      messagingSenderId: "907874309868",
      appId: "1:907874309868:web:5354ee69d6212f3d9937c9"
    };

    // Inicializace Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
  // Pou≈æij implicitn√≠ default bucket podle konfigurace (appspot.com) ‚Äì sjednoceno s konvencemi projektu
  const storage = getStorage(app);
    const auth = getAuth(app);

    // Vystaven√≠ Firebase objekt≈Ø glob√°lnƒõ pro snadn√Ω p≈ô√≠stup
    window.firebase = { 
      db, storage, auth, 
      collection, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, increment, addDoc,
      query, where, orderBy, limit, getDocs,
      ref, uploadBytes, getDownloadURL, uploadBytesResumable,
      signInAnonymously, onAuthStateChanged
    };
    
    console.log('üß™ REFACTORED STEP 3 - Firebase SDK loaded and initialized');
  </script>
  
  <style>
    /* Styly z≈Øst√°vaj√≠ stejn√© jako v p≈Øvodn√≠m souboru */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    :root { --cell-min: 133px; }
    body{
      font-family: 'Inter', sans-serif;
      background:#f0f4f8; margin:0; padding:24px; display:flex; flex-direction:column; gap:12px;
    }
    .row{
      display:grid;
      grid-template-columns: repeat(15, minmax(var(--cell-min), 1fr));
      gap: 12px;
      padding: 0 8px;
      overflow-x: auto;
    }
    @supports (-webkit-overflow-scrolling: touch) {
      .row { -webkit-overflow-scrolling: touch; }
    }
    .box{
      height:170px;
      background:#e2e8f0;
      border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      position: relative;
      color:#4b5563;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      transition: transform .2s, box-shadow .2s, background 0.2s;
      text-align:center; white-space:nowrap;
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      background-size: cover;
      background-position: center;
      cursor: grab;
      transform: none !important;
    }
    .box:hover,
    .box:active,
    .box:focus,
    .box.dragging {
      transform: none !important;
      scale: 1 !important;
    }
    .box.dragging {
      opacity: 0.6;
      box-shadow: 0 0 0 4px #2563eb;
      background: linear-gradient(135deg, #e3f2fd 0%, #2563eb 100%);
      z-index: 10;
    }
    .box.dragover {
      box-shadow: 0 0 0 4px #60a5fa;
      background: linear-gradient(135deg, #e0f2fe 0%, #60a5fa 100%);
    }
    .box.loading {
      background: #d1d5db; /* Neutr√°ln√≠ ≈°ed√° */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .box.loading::after {
      content: '';
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.5);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .box-link-badge {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(37,99,235,0.85);
      color: #fff;
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 500;
      pointer-events: auto;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    @media (min-width: 1600px){
      .box{ height:190px; }
    }
    #p73-status-banner { position: fixed; left: 16px; right: 16px; top: 16px; z-index: 9999; display:flex; justify-content:center; pointer-events:none; }
    .p73-banner { pointer-events:auto; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-size:13px; box-shadow: 0 6px 18px rgba(0,0,0,0.2); }
    .p73-banner.error { background: #b91c1c; }
    #sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; transition: left 0.3s ease; overflow-y: auto; padding: 20px; }
    #sidebar.active { left: 0; }
    #sidebar-toggle { position: fixed; left: 20px; top: 20px; z-index: 1001; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    #sidebar-toggle:hover { transform: scale(1.05); box-shadow: 0 2px 15px rgba(0,0,0,0.15); }
    #sidebar-toggle svg { width: 24px; height: 24px; transition: transform 0.3s; }
    #sidebar-toggle.active svg { transform: rotate(180deg); }
    .sidebar-header { font-weight: 600; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
    .sidebar-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .color-palettes { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .color-palette { width: 48px; height: 48px; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
    .color-palette:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .color-palette.active { box-shadow: 0 0 0 3px #3b82f6, 0 4px 8px rgba(0,0,0,0.15); }
    .color-palette-name { position: absolute; bottom: -20px; left: 0; right: 0; text-align: center; font-size: 10px; color: #666; }
    .workspace-panels { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
    .workspace-panel { position: relative; width: 100%; height: 80px; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; }
    .workspace-panel:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .workspace-panel.active { box-shadow: 0 0 0 3px #3b82f6, 0 4px 8px rgba(0,0,0,0.15); }
    .workspace-panel-name { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; font-size: 12px; text-align: center; }
    .workspace-panel-preview { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr); gap: 2px; width: 90%; height: 60px; }
    .preview-box { background: #e2e8f0; border-radius: 2px; }
    #detail-panel { position: fixed; right: -560px; top: 0; width: 560px; height: 100%; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 1000; transition: right 0.3s ease; overflow-y: auto; padding: 20px; }
    #detail-panel.active { right: 0; }
    .detail-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .detail-panel-header h2 { font-weight: 600; font-size: 20px; margin: 0; }
    .detail-panel-close { background: none; border: none; cursor: pointer; padding: 5px; color: #888; transition: color 0.2s; }
    .detail-panel-close:hover { color: #333; }
    .detail-section { margin-bottom: 20px; }
    .detail-preview { width: 100%; height: 200px; border-radius: 8px; margin-bottom: 15px; background-size: cover; background-position: center; background-color: #f0f4f8; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .nav-icons { position: absolute; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; display: flex; gap: 10px; z-index: 100; opacity: 0; transform: scale(0.8); transition: all 0.2s; pointer-events: none; }
    .nav-icons.active { opacity: 1; transform: scale(1); pointer-events: all; }
    .nav-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .nav-icon:hover { background: #e0f2fe; transform: translateY(-2px); }
    .nav-icon svg { width: 20px; height: 20px; color: #444; }
    .workspace-loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .workspace-loading.active { opacity: 1; pointer-events: all; }
    .workspace-loading-spinner { width: 40px; height: 40px; border: 4px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="p73-status-banner"></div>
  
  <button id="sidebar-toggle" aria-label="Otev≈ô√≠t/zav≈ô√≠t menu">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
  </button>
  
  <div id="sidebar">
    <div class="sidebar-header">Project_73 Menu</div>
    
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Pracovn√≠ plochy</h3>
      <p class="text-xs text-gray-500 mb-2">Klikni na plochu a pak na box v m≈ô√≠≈æce</p>
      <div class="workspace-panels">
        <div class="workspace-panel" data-workspace="workspace1" title="Plocha 1"><div class="workspace-panel-preview"><div class="preview-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);"></div><div class="preview-box" style="background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: linear-gradient(135deg, #f1f8e9 0%, #aed581 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);"></div><div class="preview-box" style="background: linear-gradient(135deg, #fce4ec 0%, #f48fb1 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div></div><div class="workspace-panel-name">Plocha 1</div></div>
        <div class="workspace-panel" data-workspace="workspace2" title="Plocha 2"><div class="workspace-panel-preview"><div class="preview-box" style="background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);"></div><div class="preview-box" style="background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: linear-gradient(135deg, #fce4ec 0%, #f48fb1 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: #e2e8f0;"></div></div><div class="workspace-panel-name">Plocha 2</div></div>
        <div class="workspace-panel" data-workspace="workspace3" title="Plocha 3"><div class="workspace-panel-preview"><div class="preview-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);"></div><div class="preview-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);"></div><div class="preview-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);"></div></div><div class="workspace-panel-name">Plocha 3</div></div>
        <div class="workspace-panel" data-workspace="workspace4" title="Plocha 4"><div class="workspace-panel-preview"><div class="preview-box" style="background: linear-gradient(135deg, #f1f8e9 0%, #aed581 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%);"></div><div class="preview-box" style="background: linear-gradient(135deg, #f1f8e9 0%, #aed581 100%);"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%);"></div></div><div class="workspace-panel-name">Plocha 4</div></div>
        <div class="workspace-panel" data-workspace="workspace5" title="Plocha 5"><div class="workspace-panel-preview"><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: #e2e8f0;"></div><div class="preview-box" style="background: #e2e8f0;"></div></div><div class="workspace-panel-name">Vlastn√≠ plocha</div></div>
      </div>
    </div>
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Barevn√© plochy</h3>
      <p class="text-xs text-gray-500 mb-2">Klikni na barvu a pak na box v m≈ô√≠≈æce</p>
      <div class="color-palettes">
        <div class="color-palette" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);" data-color="blue" title="Modr√Ω gradient"><span class="color-palette-name">Modr√°</span></div>
        <div class="color-palette" style="background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%);" data-color="purple" title="Fialov√Ω gradient"><span class="color-palette-name">Fialov√°</span></div>
        <div class="color-palette" style="background: linear-gradient(135deg, #f1f8e9 0%, #aed581 100%);" data-color="green" title="Zelen√Ω gradient"><span class="color-palette-name">Zelen√°</span></div>
        <div class="color-palette" style="background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);" data-color="orange" title="Oran≈æov√Ω gradient"><span class="color-palette-name">Oran≈æov√°</span></div>
        <div class="color-palette" style="background: linear-gradient(135deg, #fce4ec 0%, #f48fb1 100%);" data-color="pink" title="R≈Ø≈æov√Ω gradient"><span class="color-palette-name">R≈Ø≈æov√°</span></div>
      </div>
    </div>
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Nastaven√≠ m≈ô√≠≈æky</h3>
      <div class="flex flex-col gap-2">
  <button id="clear-workspace-btn" class="px-3 py-2 bg-blue-100 hover:bg-blue-200 rounded text-sm">Vyƒçistit v≈°echny boxy</button>
        <button class="px-3 py-2 bg-blue-100 hover:bg-blue-200 rounded text-sm">Export dat</button>
      </div>
    </div>
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Informace o projektu</h3>
      <div class="text-sm"><p>Session ID: <span id="session-id-display">naƒç√≠t√°n√≠...</span></p><p>Firebase status: <span id="firebase-status">naƒç√≠t√°n√≠...</span></p></div>
    </div>
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Statistiky</h3>
      <div class="text-sm"><p>Celkem box≈Ø: <span id="total-boxes">105</span></p><p>Vyplnƒõno: <span id="filled-boxes">0</span></p></div>
    </div>
  </div>
  
  <div id="detail-panel">
    <div class="detail-panel-header">
      <h2>Detail boxu <span id="box-position"></span></h2>
      <button class="detail-panel-close" aria-label="Zav≈ô√≠t detail"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
    </div>
    <div class="detail-section"><div class="detail-preview" id="box-preview"></div></div>
    <div class="detail-section">
      <h3 class="font-medium mb-2">Popis</h3>
      <textarea id="box-description" class="w-full p-3 border border-gray-300 rounded-lg" rows="4" placeholder="Zadejte popis tohoto boxu..."></textarea>
      <button id="save-description" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Ulo≈æit popis</button>
    </div>
    <div class="detail-section">
      <h3 class="font-medium mb-2">Vlastnosti</h3>
      <div class="grid grid-cols-2 gap-2">
        <div class="p-3 bg-gray-100 rounded-lg"><div class="text-xs text-gray-500">Typ</div><div id="box-type">Standardn√≠</div></div>
        <div class="p-3 bg-gray-100 rounded-lg"><div class="text-xs text-gray-500">Vytvo≈ôeno</div><div id="box-created">-</div></div>
        <div class="p-3 bg-gray-100 rounded-lg"><div class="text-xs text-gray-500">Posledn√≠ √∫prava</div><div id="box-updated">-</div></div>
        <div class="p-3 bg-gray-100 rounded-lg"><div class="text-xs text-gray-500">Autor</div><div id="box-author">-</div></div>
      </div>
    </div>
  </div>
  
  <div class="nav-icons" id="nav-icons">
    <div class="nav-icon" data-action="heading" title="P≈ôidat nadpis"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 12h12"></path><path d="M6 6h12"></path><path d="M6 18h12"></path></svg></div>
    <div class="nav-icon" data-action="link" title="P≈ôidat odkaz"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div>
    <div class="nav-icon" data-action="color" title="Zmƒõnit barvu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg></div>
    <div class="nav-icon" data-action="delete" title="Smazat obsah"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></div>
  </div>
  
  <div class="workspace-loading" id="workspace-loading"><div class="workspace-loading-spinner"></div></div>

  <!-- NOV√ù KONTEJNER PRO M≈ò√ç≈ΩKU -->
  <div id="grid-container"></div>
  
  <script>
    // =================================================================================
    // --- 1. KONFIGURACE A GLOB√ÅLN√ç STAV ---
    // =================================================================================
    // Zde jsou v≈°echny promƒõnn√©, kter√© dr≈æ√≠ stav aplikace.
    // This is where all state-holding variables for the application are defined.
    
    let activeBox = null;
    let currentUser = null;
    let isEditingText = false;
    let isFirebaseReady = false;
    let uploadQueue = [];
    let currentBoxDetails = null; // Pro prav√Ω panel s detaily
    let unsubscribeListener = null; 
    let dragSource = null; // Promƒõnn√° pro drag & drop
    
    // Aktu√°ln√≠ stav a reference na Firebase pro dan√Ω workspace
    // Current state and Firebase references for the active workspace
    let currentWorkspace = "workspace1"; 
    let sessionId = null;
    let gridDocRef = null;

    // Konfigurace pro v≈°echny dostupn√© pracovn√≠ plochy
    // Configuration for all available workspaces
    const workspaceConfigs = {
      workspace1: { collection: 'project73-sessions', sessionId: null, gridDocRef: null, name: "Plocha 1" },
      workspace2: { collection: 'project73-workspace2', sessionId: null, gridDocRef: null, name: "Plocha 2" },
      workspace3: { collection: 'project73-workspace3', sessionId: null, gridDocRef: null, name: "Plocha 3" },
      workspace4: { collection: 'project73-workspace4', sessionId: null, gridDocRef: null, name: "Plocha 4" },
      workspace5: { collection: 'project73-workspace5', sessionId: null, gridDocRef: null, name: "Vlastn√≠ plocha" }
    };

    // =================================================================================
    // --- 2. DATOV√â OPERACE (FIREBASE & STORAGE) ---
    // =================================================================================
    // V≈°echny funkce, kter√© p≈ô√≠mo komunikuj√≠ s Firebase (ƒçten√≠, z√°pis, upload).
    // All functions that communicate directly with Firebase (reading, writing, uploading).

    function getBrowserFingerprint() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Browser fingerprint', 2, 2);
      
      const components = [
        navigator.userAgent || '', navigator.language || '',
        screen.width + 'x' + screen.height, screen.colorDepth || '',
        new Date().getTimezoneOffset(), canvas.toDataURL(),
        navigator.platform || '', navigator.cookieEnabled,
        typeof window.localStorage !== 'undefined', typeof window.sessionStorage !== 'undefined'
      ];
      
      const fingerprint = btoa(components.join('|')).replace(/[+=\/]/g, '').substring(0, 16);
      return fingerprint;
    }

    async function findSessionByFingerprint(fingerprint, collectionName) {
      const { db, collection, query, where, limit, getDocs } = window.firebase;
      try {
        const q = query(collection(db, collectionName), where('browserFingerprint', '==', fingerprint), limit(5));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) return null;

        const sessions = querySnapshot.docs.map(d => ({ id: d.id, data: d.data() }));
        let bestSession = null;
        let maxData = -1;

        for (const session of sessions) {
          const dataCount = session.data.gridData ? Object.keys(session.data.gridData).length : 0;
          if (dataCount > maxData) {
            maxData = dataCount;
            bestSession = session;
          }
        }
        return bestSession;
      } catch (error) {
        console.error(`‚ùå Error finding session by fingerprint in ${collectionName}:`, error);
        return null;
      }
    }

    async function createNewSession(workspaceId) {
        const config = workspaceConfigs[workspaceId];
        const { db, doc, setDoc, serverTimestamp } = window.firebase;
        const fingerprint = getBrowserFingerprint();
        const userId = currentUser.uid;
        
        const newSessionId = `${workspaceId}_${Date.now()}_${userId.slice(0, 8)}`;
        config.sessionId = newSessionId;
        config.gridDocRef = doc(db, config.collection, config.sessionId);

        const sessionData = {
            userId, sessionId: newSessionId, workspaceId, browserFingerprint: fingerprint,
            gridData: {},
            stats: { totalBoxes: 105, filledBoxes: 0, emptyBoxes: 105, isActive: true },
            metadata: { version: "1.0", project: "Project_73", workspace: workspaceId, gridSize: "15x7" },
            created: serverTimestamp(),
            lastModified: serverTimestamp(),
            lastAccessed: serverTimestamp()
        };

        await setDoc(config.gridDocRef, sessionData);
        console.log(`‚úÖ Created new session for ${workspaceId}:`, newSessionId);
        return { sessionId: newSessionId, gridDocRef: config.gridDocRef };
    }

    async function updateBoxDataInFirestore(position, dataToSave) {
        if (!gridDocRef) return;
        const { updateDoc, getDoc, serverTimestamp, increment } = window.firebase;
        const docSnap = await getDoc(gridDocRef);
        if (!docSnap.exists()) return;

        const gridData = docSnap.data().gridData || {};
        const existingData = gridData[position] || {};
        const mergedData = { ...existingData, ...dataToSave, updatedAt: serverTimestamp() };
        
        await updateDoc(gridDocRef, {
            [`gridData.${position}`]: mergedData,
            'lastModified': serverTimestamp()
        });
    }

    async function swapBoxDataInFirestore(pos1, pos2) {
        if (!gridDocRef) return false;
        const { getDoc, updateDoc, serverTimestamp } = window.firebase;
        const docSnap = await getDoc(gridDocRef);
        if (!docSnap.exists()) return false;
        
        const gridData = docSnap.data().gridData || {};
        const data1 = gridData[pos1] ? { ...gridData[pos1] } : null;
        const data2 = gridData[pos2] ? { ...gridData[pos2] } : null;

        const updates = {};
        updates[`gridData.${pos1}`] = data2;
        updates[`gridData.${pos2}`] = data1;
        if(updates[`gridData.${pos1}`]) updates[`gridData.${pos1}`].updatedAt = serverTimestamp();
        if(updates[`gridData.${pos2}`]) updates[`gridData.${pos2}`].updatedAt = serverTimestamp();
        updates.lastModified = serverTimestamp();

        await updateDoc(gridDocRef, updates);
        console.log(`‚úÖ Swapped data in Firestore: ${pos1} ‚Üî ${pos2}`);
        return true;
    }

    async function uploadImageToStorage(fileOrBlob, position) {
        const { storage, ref, uploadBytesResumable, getDownloadURL } = window.firebase;
        const mime = (fileOrBlob.type && fileOrBlob.type.startsWith('image/')) ? fileOrBlob.type : 'image/png';
        const imageId = `img_${Date.now()}_${position}`;
        const fileName = `${imageId}_${fileOrBlob.name || 'pasted_image.png'}`;
        const storagePath = `project73-images/${sessionId}/${fileName}`;
        const storageRef = ref(storage, storagePath);

        const uploadTask = uploadBytesResumable(storageRef, fileOrBlob);
        return new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                () => {}, // progress
                (error) => { console.error('‚ùå Upload failed:', error); reject(error); },
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    resolve({ url: downloadURL, id: imageId, fileName });
                }
            );
        });
    }

    async function processUploadQueue() {
        if (!isFirebaseReady || uploadQueue.length === 0) return;
        
        while (uploadQueue.length > 0) {
            const { blob, position, box } = uploadQueue.shift();
            try {
                const imageData = await uploadImageToStorage(blob, position);
                await updateBoxDataInFirestore(position, {
                    hasImage: true, imageUrl: imageData.url, imageId: imageData.id,
                    hasText: false, text: '', hasColor: false
                });
                console.log(`‚úÖ Queued image uploaded and saved for ${position}`);
            } catch (error) {
                console.error(`‚ùå Failed to process upload queue for ${position}:`, error);
                if (box) box.style.outline = '2px solid red';
            }
        }
    }
    
    // =================================================================================
    // --- 3. MANIPULACE S UI (DOM) ---
    // =================================================================================
    // Funkce zodpovƒõdn√© za zmƒõny na str√°nce - vykreslov√°n√≠, skr√Ωv√°n√≠, interakce.
    // Functions responsible for page changes - rendering, hiding, interactions.

    function showBanner(message, type = 'info', timeout = 3000) {
        const container = document.getElementById('p73-status-banner');
        if (!container) return;
        const div = document.createElement('div');
        div.className = 'p73-banner' + (type === 'error' ? ' error' : '');
        div.textContent = message;
        container.innerHTML = '';
        container.appendChild(div);
        setTimeout(() => {
            if (container.contains(div)) container.removeChild(div);
        }, timeout);
    }

    function updateFirebaseStatus(status) {
        const statusEl = document.getElementById('firebase-status');
        if (statusEl) statusEl.textContent = status;
    }
    
    function renderGridData(gridData = {}) {
        document.querySelectorAll('.box').forEach(box => {
            const position = box.dataset.position;
            const boxData = gridData[position];

            box.classList.remove('loading');
            box.innerHTML = '';
            box.style.backgroundImage = 'none';
            box.style.background = '';
            box.dataset.linkUrl = '';
            box.dataset.linkText = '';

            if (boxData) {
                if (boxData.hasImage && boxData.imageUrl) {
                    box.style.backgroundImage = `url(${boxData.imageUrl})`;
                } else if (boxData.hasColor && boxData.colorStyle) {
                    box.style.background = boxData.colorStyle;
                } else if (boxData.hasText && boxData.text) {
                    box.innerHTML = `<span style="color: #333; font-weight: 500; font-size: 14px;">${boxData.text}</span>`;
                    if(!boxData.colorStyle) box.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
                }

                if (boxData.linkUrl) {
                    const linkLabel = boxData.linkText || boxData.linkUrl;
                    box.dataset.linkUrl = boxData.linkUrl;
                    box.dataset.linkText = linkLabel;
                    const badge = document.createElement('div');
                    badge.className = 'box-link-badge';
                    badge.textContent = linkLabel;
                    badge.dataset.linkUrl = boxData.linkUrl;
                    box.appendChild(badge);
                }
            }
        });
        console.log('üìä Grid rendered with new data.');
    }

    async function showBoxDetails(box) {
        const position = box.dataset.position;
        if (!gridDocRef) return;
        
        const snap = await window.firebase.getDoc(gridDocRef);
        if (!snap.exists()) return;

        const gridData = snap.data().gridData || {};
        const boxData = gridData[position] || {};
        currentBoxDetails = { position, data: boxData };

        document.getElementById('box-position').textContent = position;
        const boxPreviewEl = document.getElementById('box-preview');
        // ... (logika pro vyplnƒõn√≠ detail≈Ø z≈Øst√°v√° stejn√°)
        document.getElementById('box-description').value = boxData.description || '';
        document.getElementById('detail-panel').classList.add('active');
    }

    /**
     * Vygeneruje HTML strukturu m≈ô√≠≈æky do kontejneru.
     * Generates the HTML structure for the grid into its container.
     */
    function generateGrid() {
        const gridContainer = document.getElementById('grid-container');
        if (!gridContainer) return;

        for (let r = 1; r <= 7; r++) {
            const row = document.createElement('div');
            row.className = 'row';
            for (let c = 1; c <= 15; c++) {
                const box = document.createElement('div');
                box.className = 'box';
                box.dataset.position = `${r}-${c}`;
                box.setAttribute("draggable", "true"); // Atribut pro drag&drop
                row.appendChild(box);
            }
            gridContainer.appendChild(row);
        }
        console.log('‚úÖ Grid HTML generated.');
    }

    
    // =================================================================================
    // --- 4. APLIKAƒåN√ç LOGIKA (WORKFLOWS) ---
    // =================================================================================
    // Komplexnƒõj≈°√≠ funkce, kter√© orchestr≈Øj√≠ v√≠ce ƒç√°st√≠ aplikace (UI, data, stav).
    // More complex functions that orchestrate multiple parts of the app (UI, data, state).

    async function initializeWorkspace(workspaceId) {
        const config = workspaceConfigs[workspaceId];
        const fingerprint = getBrowserFingerprint();
        
        console.log(`üîç Initializing workspace ${workspaceId}`);
        
        let session = await findSessionByFingerprint(fingerprint, config.collection);

        if (session) {
            config.sessionId = session.id;
            config.gridDocRef = window.firebase.doc(window.firebase.db, config.collection, session.id);
            console.log(`‚úÖ Found existing session for ${workspaceId}:`, session.id);
        } else {
            const newSession = await createNewSession(workspaceId);
            config.sessionId = newSession.sessionId;
            config.gridDocRef = newSession.gridDocRef;
        }
    }

    async function switchWorkspace(workspaceId) {
        if (workspaceId === currentWorkspace || !isFirebaseReady) return;

        console.log(`üîÑ Switching to workspace ${workspaceId}`);
        document.getElementById('workspace-loading').classList.add('active');
        
        currentWorkspace = workspaceId;
        const config = workspaceConfigs[currentWorkspace];

        if (!config.gridDocRef) {
            await initializeWorkspace(currentWorkspace);
        }

        sessionId = config.sessionId;
        gridDocRef = config.gridDocRef;

        const snap = await window.firebase.getDoc(gridDocRef);
        if (snap.exists()) {
            renderGridData(snap.data().gridData);
        }

        // Vizu√°ln√≠ aktualizace
        document.querySelectorAll('.workspace-panel').forEach(p => p.classList.remove('active'));
        document.querySelector(`.workspace-panel[data-workspace="${workspaceId}"]`).classList.add('active');
        
        setupRealtimeListener(); // P≈ôipoj√≠ listener na nov√Ω gridDocRef
        
        showBanner(`P≈ôepnuto na ${config.name}`, 'info');
        document.getElementById('workspace-loading').classList.remove('active');
    }
    
    function setupRealtimeListener() {
        if (unsubscribeListener) unsubscribeListener();
        if (!gridDocRef) return;
        
        console.log('üîÑ Attaching new listener to', gridDocRef.path);
        unsubscribeListener = window.firebase.onSnapshot(gridDocRef, (snap) => {
            if (snap.exists()) {
                console.log('üîÑ Real-time update received.');
                renderGridData(snap.data().gridData);
            }
        }, (err) => console.error('‚ùå onSnapshot error:', err));
    }

    async function onUserSignedIn(user) {
        currentUser = user;
        console.log('‚úÖ User signed in:', user.uid);

        await initializeWorkspace(currentWorkspace);
        
        const config = workspaceConfigs[currentWorkspace];
        sessionId = config.sessionId;
        gridDocRef = config.gridDocRef;

        const snap = await window.firebase.getDoc(gridDocRef);
        if (snap.exists()) {
            renderGridData(snap.data().gridData);
        }
        
        setupRealtimeListener();
        isFirebaseReady = true;
        updateFirebaseStatus(`Ready (${sessionId.substring(0,12)}...)`);
        processUploadQueue();

        document.querySelector('.workspace-panel[data-workspace="workspace1"]').classList.add('active');
    }

    // =================================================================================
    // --- 5. INICIALIZACE APLIKACE A EVENT LISTENERY ---
    // =================================================================================
    // K√≥d, kter√Ω se spust√≠ po naƒçten√≠ str√°nky a nastav√≠ v≈°echny interakce.
    // Code that runs after the page loads and sets up all interactions.
    
    /**
     * Centr√°ln√≠ funkce pro zpracov√°n√≠ v≈°ech interakc√≠ s m≈ô√≠≈ækou.
     * Central function for handling all interactions with the grid.
     */
    function handleGridInteraction(event) {
        const targetBox = event.target.closest('.box');
        if (!targetBox) return; // Kliknuto mimo box

        switch (event.type) {
            case 'mouseenter':
                activeBox = targetBox;
                break;
            case 'mouseleave':
                activeBox = null;
                break;
            case 'dblclick':
                showBoxDetails(targetBox);
                break;
            case 'dragstart':
                dragSource = targetBox;
                targetBox.classList.add("dragging");
                event.dataTransfer.effectAllowed = "move";
                event.dataTransfer.setData("text/plain", targetBox.dataset.position);
                break;
            case 'dragover':
                event.preventDefault();
                targetBox.classList.add("dragover");
                break;
            case 'dragleave':
                targetBox.classList.remove("dragover");
                break;
            case 'drop':
                event.preventDefault();
                targetBox.classList.remove("dragover");
                if (dragSource && dragSource !== targetBox) {
                    swapBoxDataInFirestore(dragSource.dataset.position, targetBox.dataset.position);
                }
                break;
            case 'dragend':
                document.querySelectorAll('.box').forEach(b => b.classList.remove('dragging', 'dragover'));
                dragSource = null;
                break;
        }
    }

    /**
     * P≈ôipoj√≠ v≈°echny pot≈ôebn√© event listenery k element≈Øm na str√°nce.
     * Attaches all necessary event listeners to the elements on the page.
     */
    function initializeEventListeners() {
      // EVENT DELEGATION PRO M≈ò√ç≈ΩKU
      const gridContainer = document.getElementById('grid-container');
      if (gridContainer) {
          ['mouseenter', 'mouseleave', 'dblclick', 'dragstart', 'dragover', 'dragleave', 'drop', 'dragend'].forEach(eventType => {
              gridContainer.addEventListener(eventType, handleGridInteraction, eventType === 'mouseenter' || eventType === 'mouseleave');
          });
          console.log('‚úÖ Event delegation for grid initialized.');
      }

      // Ostatn√≠ listenery
      document.getElementById('sidebar-toggle').addEventListener('click', () => {
          document.getElementById('sidebar').classList.toggle('active');
          document.getElementById('sidebar-toggle').classList.toggle('active');
      });

      document.querySelectorAll('.workspace-panel').forEach(panel => {
          panel.addEventListener('click', () => switchWorkspace(panel.dataset.workspace));
      });
      
      document.querySelector('.detail-panel-close').addEventListener('click', () => {
        document.getElementById('detail-panel').classList.remove('active');
      });
      document.getElementById('save-description').addEventListener('click', async () => {
        if (!currentBoxDetails) return;
        const description = document.getElementById('box-description').value;
        await updateBoxDataInFirestore(currentBoxDetails.position, { description });
        showBanner('Popis ulo≈æen.', 'info');
      });
      
      document.addEventListener('paste', async (event) => {
        if (!activeBox) return;
        const items = (event.clipboardData || window.clipboardData).items;
        for (const item of items) {
          if (item.type.indexOf('image') !== -1) {
            event.preventDefault();
            const blob = item.getAsFile();
            const position = activeBox.dataset.position;
            
            activeBox.classList.add('loading');
            activeBox.innerHTML = '';
            activeBox.style.backgroundImage = 'none';
            
            uploadQueue.push({ blob, position, box: activeBox });
            processUploadQueue();
            return;
          }
        }
      });
    }

    /**
     * Start aplikace po naƒçten√≠ DOM.
     * Application entry point after DOM is loaded.
     */
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ DOM loaded, initializing app...');
        generateGrid();
        initializeEventListeners();

        // Spust√≠ proces autentizace a naƒç√≠t√°n√≠ dat
        const { auth, onAuthStateChanged, signInAnonymously } = window.firebase;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                onUserSignedIn(user);
            } else {
                signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
            }
        });
    });

    // CLEAR CURRENT WORKSPACE (remove all box data)
      async function clearCurrentWorkspace() {
        if (!gridDocRef) return;
        try {
          const snap = await window.firebase.getDoc(gridDocRef);
          if (!snap.exists()) return;
          const data = snap.data();
          const currentGrid = data.gridData || {};
          const hasAny = Object.keys(currentGrid).length > 0;
          if (!hasAny) {
            showBanner('Pracovn√≠ plocha je u≈æ pr√°zdn√°.', 'info');
            return;
          }
          await window.firebase.updateDoc(gridDocRef, {
            gridData: {},
            'stats.filledBoxes': 0,
            'stats.emptyBoxes': 105,
            lastModified: window.firebase.serverTimestamp()
          });
          renderGridData({});
          showBanner('Plocha vyƒçi≈°tƒõna.', 'info');
        } catch (e) {
          console.error('‚ùå clearCurrentWorkspace error', e);
          showBanner('Chyba p≈ôi ƒçi≈°tƒõn√≠.', 'error');
        }
      }

      // Attach listener to the new clear button
      const clearBtn = document.getElementById('clear-workspace-btn');
      if (clearBtn) {
        clearBtn.addEventListener('click', async () => {
          if (!isFirebaseReady || !gridDocRef) {
            showBanner('Firebase je≈°tƒõ nen√≠ p≈ôipraven.', 'error');
            return;
          }
          if (confirm('Opravdu vyƒçistit v≈°echny boxy t√©to pracovn√≠ plochy?')) {
            await clearCurrentWorkspace();
          }
        });
      }
  </script>
</body>
</html>
