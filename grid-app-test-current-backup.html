<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project_73 - Grid Development [v2.0]</title>
  <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
  <link rel="apple-touch-icon" href="../favicon.svg" />
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK bootstrap -->
  <script type="module" src="../shared/firebase.js"></script>
  
  <style>
    /* Styly zůstávají stejné jako v původním souboru */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    :root { --cell-min: 133px; }
    body{
      font-family: 'Inter', sans-serif;
      background:#f0f4f8; margin:0; padding:24px; display:flex; flex-direction:column; gap:12px;
    }
    .row{
      display:grid;
      grid-template-columns: repeat(15, minmax(var(--cell-min), 1fr));
      gap: 12px;
      padding: 0 8px;
      overflow-x: auto;
    }
    @supports (-webkit-overflow-scrolling: touch) {
      .row { -webkit-overflow-scrolling: touch; }
    }
    .box{
      height:170px;
      background:#e2e8f0;
      border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      position: relative;
      color:#4b5563;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      transition: transform .2s, box-shadow .2s, background 0.2s, opacity 0.2s;
      text-align:center; white-space:nowrap;
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      background-size: cover;
      background-position: center;
      cursor: grab;
    }
    /* --- Performance: izolace layoutu/paint + deklarace budoucí transformace --- */
  /* Performance tuning (rev2) */
  /* Box: pouze paint containment (layout containment může fragmentovat grid a zvyšovat náklady) */
  .box { contain: paint; will-change: transform; }
  /* Řádky: virtualizace mimo viewport – prohlížeč může odložit vykreslení */
  .row { content-visibility: auto; contain-intrinsic-size: 1px 190px; }
  body.dnd-active .box:hover { transform: none !important; }
  body.dnd-active .box * { pointer-events: none; }
    /* Třída .box.ghost byla odstraněna, je nahrazena modernějším přístupem */
    .box:hover,
    .box:active,
    .box:focus {
      transform: none !important;
      scale: 1 !important;
    }
    .box.dragging { visibility: hidden; z-index: 10; }
    .box.dragover { outline: 2px solid #60a5fa; outline-offset: -2px; transform:none; }
    .box.loading {
      background: #d1d5db; /* Neutrální šedá */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .box.loading::after {
      content: '';
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.5);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .box-link-badge {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(37,99,235,0.85);
      color: #fff;
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 500;
      pointer-events: auto;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    @media (min-width: 1600px){
      .box{ height:190px; }
    }
    #p73-status-banner { position: fixed; left: 16px; right: 16px; top: 16px; z-index: 9999; display:flex; justify-content:center; pointer-events:none; }
    .p73-banner { pointer-events:auto; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-size:13px; box-shadow: 0 6px 18px rgba(0,0,0,0.2); }
    .p73-banner.error { background: #b91c1c; }
    #sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; transition: left 0.3s ease; overflow-y: auto; padding: 20px; }
    #sidebar.active { left: 0; }
  /* Adjusted to sit below the sticky topbar */
  #sidebar-toggle { position: fixed; left: 20px; top: 74px; z-index: 1001; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    #sidebar-toggle:hover { transform: scale(1.05); box-shadow: 0 2px 15px rgba(0,0,0,0.15); }
    #sidebar-toggle svg { width: 24px; height: 24px; transition: transform 0.3s; }
    #sidebar-toggle.active svg { transform: rotate(180deg); }
    .sidebar-header { font-weight: 600; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
    .sidebar-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .color-palettes { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .color-palette { width: 48px; height: 48px; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
    .color-palette:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .color-palette.active { box-shadow: 0 0 0 3px #3b82f6, 0 4px 8px rgba(0,0,0,0.15); }
    .color-palette-name { position: absolute; bottom: -20px; left: 0; right: 0; text-align: center; font-size: 10px; color: #666; }
    .workspace-panels { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
    .workspace-panel { position: relative; width: 100%; height: 80px; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; }
    .workspace-panel:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .workspace-panel.active { box-shadow: 0 0 0 3px #3b82f6, 0 4px 8px rgba(0,0,0,0.15); }
    .workspace-panel-name { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; font-size: 12px; text-align: center; }
    .workspace-panel-preview { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr); gap: 2px; width: 90%; height: 60px; }
    .preview-box { background: #e2e8f0; border-radius: 2px; }
    #detail-panel { position: fixed; right: -560px; top: 0; width: 560px; height: 100%; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 1000; transition: right 0.3s ease; overflow-y: auto; padding: 20px; }
    #detail-panel.active { right: 0; }
    .detail-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .detail-panel-header h2 { font-weight: 600; font-size: 20px; margin: 0; }
    .detail-panel-close { background: none; border: none; cursor: pointer; padding: 5px; color: #888; transition: color 0.2s; }
    .detail-panel-close:hover { color: #333; }
    .detail-section { margin-bottom: 20px; }
    .detail-preview { width: 100%; height: 200px; border-radius: 8px; margin-bottom: 15px; background-size: cover; background-position: center; background-color: #f0f4f8; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .nav-icons { position: absolute; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; display: flex; gap: 10px; z-index: 100; opacity: 0; transform: scale(0.8); transition: all 0.2s; pointer-events: none; }
    .nav-icons.active { opacity: 1; transform: scale(1); pointer-events: all; }
    .nav-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .nav-icon:hover { background: #e0f2fe; transform: translateY(-2px); }
    .nav-icon svg { width: 20px; height: 20px; color: #444; }
    .workspace-loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .workspace-loading.active { opacity: 1; pointer-events: all; }
    .workspace-loading-spinner { width: 40px; height: 40px; border: 4px solid rgba(59, 130, 246, 0.3); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* ================= Topbar (moved from inline styles) ================= */
    .p73-topbar { position:sticky; top:0; z-index:1200; background:rgba(255,255,255,0.92); backdrop-filter:blur(6px); border:1px solid #e5e7eb; border-left:0; border-right:0; margin:-24px -24px 12px -24px; padding:0 24px; display:flex; align-items:center; gap:28px; height:52px; font-size:14px; }
    .p73-topbar-brand { font-weight:600; letter-spacing:.5px; color:#111827; display:flex; align-items:center; gap:6px; }
    .p73-topbar-brand-dot { color:#6366f1; }
    .p73-topbar-nav { display:flex; gap:18px; }
    .p73-topbar-link { text-decoration:none; color:#4b5563; padding:6px 4px; display:inline-flex; align-items:center; gap:6px; font-weight:500; border-bottom:2px solid transparent; transition:color .15s, border-color .15s; }
    .p73-topbar-link:hover { color:#1f2937; }
    .p73-topbar-link.active { color:#2563eb; font-weight:600; border-color:#2563eb; }
    .p73-topbar-status { margin-left:auto; font-size:11px; color:#6b7280; display:flex; align-items:center; gap:12px; }
    #auth-gate { position:fixed; inset:0; background:rgba(15,23,42,0.65); display:flex; align-items:center; justify-content:center; padding:24px; z-index:2200; }
    #auth-gate.hidden { display:none; }
    .auth-card { background:white; padding:36px 44px; border-radius:18px; max-width:380px; width:100%; text-align:center; box-shadow:0 40px 80px rgba(15,23,42,0.35); display:flex; flex-direction:column; gap:16px; }
    .auth-card h2 { margin:0; font-size:20px; color:#111827; font-weight:600; }
    .auth-card p { margin:0; font-size:14px; color:#4b5563; }
    .auth-btn { margin:12px auto 0; padding:12px 26px; border-radius:9999px; border:none; background:#2563eb; color:white; font-weight:600; font-size:15px; cursor:pointer; box-shadow:0 8px 18px rgba(37,99,235,0.35); transition:transform .15s, box-shadow .15s, background .15s; display:inline-flex; align-items:center; gap:10px; }
    .auth-btn:hover { transform:translateY(-1px); box-shadow:0 12px 22px rgba(37,99,235,0.35); background:#1d4ed8; }
    .auth-btn:disabled { opacity:0.65; cursor:not-allowed; transform:none; box-shadow:none; }
    .auth-error { min-height:18px; font-size:13px; color:#b91c1c; }
    .auth-user-chip { display:flex; flex-direction:column; align-items:flex-end; gap:2px; font-size:12px; color:#111827; }
    .auth-user-name { font-weight:600; }
    .auth-user-email { color:#6b7280; font-weight:500; }
    .auth-signout-btn { border:1px solid #d1d5db; background:white; color:#1f2937; border-radius:9999px; font-size:12px; padding:6px 14px; cursor:pointer; transition:all 0.15s; }
    .auth-signout-btn:hover { background:#2563eb; border-color:#2563eb; color:white; }
    body.auth-locked { overflow:hidden; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    #calendar-section.calendar-focus { animation: calendarPulse 1.2s ease; box-shadow:0 0 0 3px rgba(99,102,241,0.35); border-radius:12px; }
    .calendar-view-wrapper { display:none; margin-left:300px; padding:12px 24px; }
    body.view-calendar .calendar-view-wrapper { display:block; }
    .calendar-view-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    .calendar-view-title { font-size:20px; font-weight:600; color:#1f2937; }
    .calendar-view-list { display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
    .calendar-view-card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; background:white; box-shadow:0 6px 14px rgba(15,23,42,0.05); display:flex; flex-direction:column; gap:8px; }
    .calendar-view-card h4 { margin:0; font-size:15px; color:#111827; font-weight:600; }
    .calendar-view-card time { font-size:13px; color:#4b5563; }
    body.view-calendar #grid-container { display:none; }
    .assets-view-wrapper { display:none; margin-left:300px; padding:12px 24px; }
    body.view-assets .assets-view-wrapper { display:block; }
    .assets-view-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    .assets-view-title { font-size:20px; font-weight:600; color:#1f2937; }
    .assets-view-refresh { padding:6px 14px; border-radius:9999px; border:1px solid #d1d5db; background:white; cursor:pointer; font-size:12px; transition:all 0.15s; }
    .assets-view-refresh:hover { background:#2563eb; color:white; border-color:#2563eb; }
    .assets-view-grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); }
    .assets-view-card { background:white; border-radius:12px; border:1px solid #e5e7eb; box-shadow:0 8px 20px rgba(15,23,42,0.06); padding:16px; display:flex; flex-direction:column; gap:6px; }
    .assets-view-card h4 { margin:0; font-size:15px; font-weight:600; color:#111827; display:flex; align-items:center; gap:6px; }
    .assets-view-card dl { margin:0; display:grid; grid-template-columns:auto 1fr; gap:4px 12px; font-size:12px; color:#4b5563; }
    .assets-view-card dl dt { color:#6b7280; }
    .assets-view-preview { display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:8px; margin-top:8px; }
    .assets-preview-item { border:1px solid #e5e7eb; border-radius:8px; padding:6px; background:#f9fafb; display:flex; flex-direction:column; align-items:center; gap:4px; font-size:11px; color:#4b5563; }
    .assets-preview-thumb { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:6px; background:#e5e7eb; }
    .assets-preview-name { width:100%; text-align:center; word-break:break-word; }
    .assets-modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,0.55); backdrop-filter:blur(6px); display:none; justify-content:center; align-items:center; z-index:4000; padding:24px; }
    .assets-modal-backdrop.active { display:flex; }
    .assets-modal { background:white; border-radius:16px; max-width:960px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 24px 60px rgba(15,23,42,0.35); }
    .assets-modal-header { padding:18px 24px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
    .assets-modal-header h3 { margin:0; font-size:18px; font-weight:600; color:#111827; }
    .assets-modal-close { border:0; background:none; font-size:22px; line-height:1; cursor:pointer; color:#4b5563; }
    .assets-modal-body { padding:20px 24px; overflow:auto; }
    .assets-modal-grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); }
    .assets-modal-item { border:1px solid #e5e7eb; border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; background:#f9fafb; }
    .assets-modal-thumb { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:10px; background:#e5e7eb; }
    .assets-modal-meta { font-size:12px; color:#4b5563; word-break:break-word; }
    body.assets-modal-open { overflow:hidden; }
    .gallery-view-wrapper { display:none; margin-left:300px; padding:12px 24px; }
    body.view-gallery .gallery-view-wrapper { display:block; }
    .gallery-view-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; gap:12px; }
    .gallery-view-title { font-size:20px; font-weight:600; color:#1f2937; }
    .gallery-view-controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .gallery-view-select { padding:6px 12px; border-radius:9999px; border:1px solid #d1d5db; background:white; font-size:12px; color:#1f2937; cursor:pointer; }
    .gallery-view-refresh { padding:6px 14px; border-radius:9999px; border:1px solid #d1d5db; background:white; cursor:pointer; font-size:12px; transition:all 0.15s; }
    .gallery-view-refresh:hover { background:#2563eb; border-color:#2563eb; color:white; }
    .gallery-view-grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
    .gallery-item { background:white; border-radius:14px; border:1px solid #e5e7eb; box-shadow:0 10px 24px rgba(15,23,42,0.08); overflow:hidden; display:flex; flex-direction:column; }
    .gallery-item img { width:100%; height:180px; object-fit:cover; background:#e5e7eb; }
    .gallery-item .meta { padding:10px 14px; font-size:12px; color:#4b5563; display:flex; flex-direction:column; gap:6px; word-break:break-word; }
    .gallery-delete-btn { align-self:flex-start; padding:5px 10px; border-radius:9999px; border:1px solid #dc2626; background:white; color:#dc2626; cursor:pointer; font-size:11px; font-weight:600; transition:all 0.15s; }
    .gallery-delete-btn:hover { background:#dc2626; color:white; }
    .snippet-view-wrapper { display:none; margin-left:300px; padding:12px 24px; }
    body.view-snippets .snippet-view-wrapper { display:block; }
    body.view-snippets #grid-container,
    body.view-snippets #calendar-view,
    body.view-snippets .assets-view-wrapper,
    body.view-snippets .gallery-view-wrapper { display:none; }
    .plan-view-wrapper { display:none; margin-left:300px; padding:12px 24px; }
    body.view-plan .plan-view-wrapper { display:block; }
    body.view-plan #grid-container,
    body.view-plan #calendar-view,
    body.view-plan .assets-view-wrapper,
    body.view-plan .gallery-view-wrapper,
    body.view-plan .snippet-view-wrapper { display:none; }
    body.view-assets #grid-container { display:none; }
    body.view-assets #calendar-view { display:none; }
    body.view-gallery #grid-container { display:none; }
    body.view-gallery #calendar-view { display:none; }
    body.view-gallery .assets-view-wrapper { display:none; }
    .plan-view-header { display:flex; flex-direction:column; gap:8px; margin-bottom:24px; }
    .plan-view-header h2 { font-size:28px; font-weight:700; color:#111827; margin:0; }
    .plan-view-header p { color:#4b5563; font-size:14px; margin:0; max-width:720px; }
    .plan-cards { display:grid; gap:20px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); }
    .plan-card { background:white; border:1px solid #e5e7eb; border-radius:18px; padding:20px; box-shadow:0 12px 32px rgba(15,23,42,0.08); display:flex; flex-direction:column; gap:16px; }
    .plan-card h3 { font-size:18px; font-weight:600; color:#111827; margin:0; display:flex; align-items:center; gap:8px; }
    .plan-card p { color:#4b5563; font-size:13px; margin:0; }
    .plan-links { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; font-size:13px; }
    .plan-links li { display:flex; flex-direction:column; gap:4px; }
    .plan-links a { color:#2563eb; text-decoration:none; font-weight:500; }
    .plan-links a:hover { text-decoration:underline; }
    .plan-snippet { background:#0f172a; color:#e2e8f0; border-radius:14px; padding:16px; font-size:12px; font-family:'JetBrains Mono','Fira Code',monospace; max-height:220px; overflow:auto; white-space:pre-wrap; }
    .plan-meta { font-size:12px; color:#6b7280; display:flex; flex-direction:column; gap:4px; }
    .plan-meta a { color:#2563eb; text-decoration:none; font-weight:500; }
    .plan-meta a:hover { text-decoration:underline; }
    .snippet-header { display:flex; flex-direction:column; gap:8px; margin-bottom:24px; }
    .snippet-header h2 { font-size:28px; font-weight:700; color:#111827; }
    .snippet-header p { color:#4b5563; font-size:14px; margin:0; }
    .snippet-form { background:white; border:1px solid #e5e7eb; border-radius:18px; padding:24px; margin-bottom:24px; box-shadow:0 12px 32px rgba(15,23,42,0.08); display:grid; gap:16px; }
    .snippet-form-grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
    .snippet-form-field { display:flex; flex-direction:column; gap:8px; }
    .snippet-form-field.full { grid-column:1 / -1; }
    .snippet-form-field label { font-size:12px; font-weight:600; color:#4b5563; text-transform:uppercase; letter-spacing:0.05em; }
    .snippet-form-field input,
    .snippet-form-field textarea { border:1px solid #d1d5db; border-radius:12px; padding:10px 12px; font-size:13px; font-family:'Inter', sans-serif; color:#111827; background:white; }
    .snippet-form-field textarea { min-height:120px; resize:vertical; }
    .snippet-form-actions { display:flex; flex-wrap:wrap; gap:12px; justify-content:flex-end; }
    .snippet-button-primary { background:#2563eb; color:white; border:0; padding:10px 20px; border-radius:9999px; font-weight:600; cursor:pointer; transition:background 0.2s; }
    .snippet-button-primary:hover { background:#1d4ed8; }
    .snippet-button-secondary { background:white; color:#4b5563; border:1px solid #d1d5db; padding:10px 20px; border-radius:9999px; font-weight:500; cursor:pointer; transition:all 0.2s; }
    .snippet-button-secondary:hover { background:#f3f4f6; }
    .snippet-list-header { display:flex; flex-direction:column; gap:12px; margin-bottom:16px; }
    .snippet-list-header-top { display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; }
    .snippet-list-title { font-size:20px; font-weight:700; color:#111827; margin:0; }
    .snippet-list-count { font-size:14px; color:#6b7280; }
    .snippet-search { width:100%; max-width:320px; border:1px solid #d1d5db; border-radius:9999px; padding:10px 16px; font-size:13px; color:#111827; background:white; }
    .snippet-list { display:grid; gap:20px; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); }
    .snippet-card { background:white; border:1px solid #e5e7eb; border-radius:20px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 16px 34px rgba(15,23,42,0.08); }
    .snippet-card-thumb { background:#e5e7eb; aspect-ratio:16/9; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:36px; }
    .snippet-card-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .snippet-card-body { padding:20px; display:flex; flex-direction:column; gap:16px; }
    .snippet-card-title { font-size:18px; font-weight:700; color:#111827; margin:0; }
    .snippet-card-description { font-size:13px; color:#4b5563; margin:0; }
    .snippet-card-meta { font-size:11px; color:#9ca3af; text-transform:uppercase; letter-spacing:0.08em; }
    .snippet-code { background:#0f172a; color:#e2e8f0; border-radius:14px; padding:16px; font-size:12px; font-family:'JetBrains Mono','Fira Code',monospace; max-height:220px; overflow:auto; white-space:pre-wrap; }
    .snippet-card-actions { display:flex; flex-wrap:wrap; gap:10px; }
    .snippet-button-copy { background:#059669; color:white; border:0; padding:10px 16px; border-radius:10px; font-weight:600; cursor:pointer; transition:background 0.2s; display:inline-flex; align-items:center; gap:6px; }
    .snippet-button-copy:hover { background:#047857; }
    .snippet-button-delete { background:white; color:#dc2626; border:1px solid rgba(220,38,38,0.4); padding:10px 16px; border-radius:10px; font-weight:600; cursor:pointer; transition:all 0.2s; }
    .snippet-button-delete:hover { background:#fee2e2; }
    .snippet-empty { border:2px dashed #d1d5db; border-radius:16px; padding:48px; text-align:center; color:#9ca3af; font-size:14px; background:white; }
    .snippet-alert { font-size:12px; color:#f97316; }
    .snippet-upload-group { display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start; }
  #snippet-paste-drop-zone { flex:1 1 220px; min-width:220px; aspect-ratio:16/9; border:2px dashed #cbd5e1; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:12px; color:#64748b; background:linear-gradient(to bottom right,#f8fafc,#f1f5f9); text-align:center; padding:8px; cursor:copy; position:relative; transition:border-color .15s, background .15s, color .15s; }
  #snippet-paste-drop-zone:hover { border-color:#94a3b8; }
  #snippet-paste-drop-zone.active { border-color:#2563eb; background:#eff6ff; color:#1e3a8a; }
  #snippet-paste-drop-zone span { pointer-events:none; line-height:1.3; }
    .snippet-upload-preview { width:220px; aspect-ratio:16/9; border-radius:14px; background:#e5e7eb; display:flex; align-items:center; justify-content:center; color:#94a3af; font-size:12px; overflow:hidden; position:relative; box-shadow:inset 0 0 0 1px rgba(148,163,184,0.4); }
    .snippet-upload-preview img { width:100%; height:100%; object-fit:cover; display:block; }
    .snippet-upload-actions { display:flex; flex-direction:column; gap:10px; min-width:200px; }
    .snippet-upload-status { font-size:12px; color:#6b7280; }
    .snippet-button-upload { background:#111827; color:white; border:0; padding:10px 18px; border-radius:9999px; font-weight:600; cursor:pointer; transition:background 0.2s; display:inline-flex; align-items:center; gap:8px; justify-content:center; }
    .snippet-button-upload:hover { background:#1f2937; }
    .snippet-button-upload[disabled] { opacity:0.65; cursor:default; }
    .snippet-button-ghost { background:white; color:#4b5563; border:1px solid #d1d5db; padding:8px 16px; border-radius:9999px; font-weight:500; cursor:pointer; transition:all 0.2s; }
    .snippet-button-ghost:hover { background:#f3f4f6; }
    @keyframes calendarPulse {
      0% { box-shadow:0 0 0 0 rgba(99,102,241,0.45); }
      50% { box-shadow:0 0 0 6px rgba(99,102,241,0.15); }
      100% { box-shadow:0 0 0 0 rgba(99,102,241,0); }
    }
  /* ================= Palette gradients (was inline) ================= */
  .palette-blue { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); }
  .palette-purple { background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%); }
  .palette-green { background: linear-gradient(135deg, #f1f8e9 0%, #aed581 100%); }
  .palette-orange { background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%); }
  .palette-pink { background: linear-gradient(135deg, #fce4ec 0%, #f48fb1 100%); }
  /* ================= Drag preview (was inline) ================= */
  #drag-preview { position:absolute; top:-1000px; background:#3b82f6; color:#fff; padding:8px 12px; border-radius:8px; font-size:14px; font-weight:500; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:9999; }
    .super-modul-view { display:none; margin-left:300px; padding:12px 24px; }
    body.view-super-modul .super-modul-view { display:block; }
    body.view-super-modul #grid-container,
    body.view-super-modul #calendar-view,
    body.view-super-modul .assets-view-wrapper,
    body.view-super-modul .gallery-view-wrapper,
    body.view-super-modul .snippet-view-wrapper,
    body.view-super-modul .plan-view-wrapper { display:none; }
    .super-modul-header { display:flex; flex-direction:column; gap:8px; margin-bottom:24px; }
    .super-modul-header h2 { font-size:28px; font-weight:700; color:#111827; margin:0; }
    .super-modul-header p { color:#4b5563; font-size:14px; margin:0; max-width:640px; }
    .super-modul-stage { border:2px dashed #cbd5e1; border-radius:20px; min-height:320px; background:linear-gradient(135deg,#f8fafc,#eef2ff); display:flex; align-items:center; justify-content:center; color:#64748b; font-size:13px; text-align:center; padding:48px 24px; }
  </style>
</head>
<body>
  <div id="auth-gate" class="auth-gate hidden" role="dialog" aria-modal="true" aria-labelledby="auth-gate-title">
    <div class="auth-card">
      <h2 id="auth-gate-title">Přihlášení požadováno</h2>
      <p>Přihlaste se Google účtem, abyste mohli pracovat s projektem Project_73.</p>
      <button id="auth-signin-btn" class="auth-btn" type="button">
        <span>Pokračovat přes Google</span>
      </button>
      <div id="auth-error" class="auth-error" role="alert"></div>
    </div>
  </div>
  <!-- Top navigation bar (inline for this standalone file) -->
  <header id="p73-topbar" class="p73-topbar">
    <div class="p73-topbar-brand">
      <span class="p73-topbar-brand-dot">●</span>Project_73
    </div>
    <nav class="p73-topbar-nav">
      <a href="?view=grid" data-toplink="grid" class="p73-topbar-link">Grid</a>
      <a href="?view=links" data-toplink="links" class="p73-topbar-link">Odkazy</a>
      <a href="?view=plan" data-toplink="plan" class="p73-topbar-link">Plán</a>
      <a href="?view=elektrocz" data-toplink="elektrocz" class="p73-topbar-link">elektrocz.com</a>
  <a href="?view=pokus" data-toplink="pokus" class="p73-topbar-link">pokus</a>
      <a href="?view=calendar#calendar" data-toplink="calendar" class="p73-topbar-link">Kalendář</a>
      <a href="?view=assets" data-toplink="assets" class="p73-topbar-link">Assets</a>
      <a href="?view=gallery" data-toplink="gallery" class="p73-topbar-link">Galerie</a>
  <a href="?view=snippets" data-toplink="snippets" class="p73-topbar-link">Kódy</a>
      <a href="?view=super-modul" data-toplink="super-modul" class="p73-topbar-link">Super Modul</a>
      <a href="#" id="quick-deploy-btn" class="p73-topbar-link" title="Zobrazit rychlé deploy příkazy">Deploy</a>
    </nav>
    <div id="p73-topbar-status" class="p73-topbar-status"></div>
  </header>
  <!-- Fallback script: pokud by některé odkazy v topbaru chyběly (např. cache staré verze), dynamicky je doplníme -->
  <script>
    (function ensureTopbarLinks(){
      try {
        const nav = document.querySelector('.p73-topbar-nav');
        if(!nav) return;
        const deployLink = nav.querySelector('#quick-deploy-btn');
        const anchorOrder = [
          { view:'grid', label:'Grid' },
          { view:'links', label:'Odkazy' },
          { view:'plan', label:'Plán' },
          { view:'elektrocz', label:'elektrocz.com' },
          { view:'pokus', label:'pokus' },
          { view:'calendar', label:'Kalendář', href:'?view=calendar#calendar' },
          { view:'assets', label:'Assets' },
          { view:'gallery', label:'Galerie' },
          { view:'snippets', label:'Kódy' },
          { view:'super-modul', label:'Super Modul' }
        ];
        // Vloží chybějící odkazy PŘED Deploy tlačítko zachováním původního pořadí
        anchorOrder.forEach(item => {
          if(!nav.querySelector(`[data-toplink="${item.view}"]`)){
            const a = document.createElement('a');
            a.className = 'p73-topbar-link';
            a.dataset.toplink = item.view;
            a.href = item.href || `?view=${item.view}`;
            a.textContent = item.label;
            nav.insertBefore(a, deployLink);
          }
        });
      } catch(err){
        console.warn('ensureTopbarLinks fallback selhal:', err);
      }
    })();
  </script>
  <div id="p73-status-banner"></div>
  
  <button id="sidebar-toggle" aria-label="Otevřít/zavřít menu">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
  </button>
  
  <div id="sidebar">
    <div class="sidebar-header">Project_73 Menu</div>
    
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Pracovní plochy</h3>
      <p class="text-xs text-gray-500 mb-2">Klikni na plochu a pak na box v mřížce</p>
      <div class="workspace-panels">
        <!-- Panely budou dynamicky generovány JavaScriptem -->
      </div>
      <button id="add-workspace-btn" class="mt-4 w-full px-3 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition">Přidat nový projekt</button>
    </div>
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Barevné plochy</h3>
      <p class="text-xs text-gray-500 mb-2">Klikni na barvu a pak na box v mřížce</p>
      <div class="color-palettes">
  <div class="color-palette palette-blue" data-color="blue" title="Modrý gradient"><span class="color-palette-name">Modrá</span></div>
  <div class="color-palette palette-purple" data-color="purple" title="Fialový gradient"><span class="color-palette-name">Fialová</span></div>
  <div class="color-palette palette-green" data-color="green" title="Zelený gradient"><span class="color-palette-name">Zelená</span></div>
  <div class="color-palette palette-orange" data-color="orange" title="Oranžový gradient"><span class="color-palette-name">Oranžová</span></div>
  <div class="color-palette palette-pink" data-color="pink" title="Růžový gradient"><span class="color-palette-name">Růžová</span></div>
      </div>
    </div>
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Nastavení mřížky</h3>
      <div class="flex flex-col gap-2">
  <button id="clear-workspace-btn" class="px-3 py-2 bg-blue-100 hover:bg-blue-200 rounded text-sm">Vyčistit všechny boxy</button>
        <button class="px-3 py-2 bg-blue-100 hover:bg-blue-200 rounded text-sm">Export dat</button>
      </div>
    </div>
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Informace o projektu</h3>
      <div class="text-sm">
        <p>Session ID: <span id="session-id-display">načítání...</span></p>
        <p>Stav: <span id="firebase-status">načítání...</span></p>
        <p>Čas načtení: <span id="load-time-display">- ms</span></p>
      </div>
    </div>
    <div class="sidebar-section">
      <h3 class="font-medium mb-2">Statistiky</h3>
      <div class="text-sm"><p>Celkem boxů: <span id="total-boxes">105</span></p><p>Vyplněno: <span id="filled-boxes">0</span></p></div>
    </div>
    <div class="sidebar-section" id="archive-section">
      <h3 class="font-medium mb-2 flex items-center justify-between">
        <span>Smazané (archiv)</span>
        <button id="archive-refresh" class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded">↻</button>
      </h3>
      <div class="text-xs text-gray-500 mb-2">Poslední smazané položky (3 dny)</div>
      <div id="archive-list" class="flex flex-col gap-2 max-h-48 overflow-auto text-xs"></div>
    </div>
    <div class="sidebar-section" id="deferred-section">
      <h3 class="font-medium mb-2 flex items-center justify-between">
        <span>Odložené úkoly</span>
        <button id="deferred-add" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">+</button>
      </h3>
      <div class="text-xs text-gray-500 mb-2">Rychlé poznámky k pozdějšímu řešení</div>
      <div class="flex gap-2 mb-2">
        <input id="deferred-title" type="text" placeholder="Nový úkol..." class="flex-1 px-2 py-1 border rounded text-sm" />
        <button id="deferred-save" class="text-xs px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Uložit</button>
      </div>
      <div id="deferred-list" class="flex flex-col gap-2 max-h-56 overflow-auto text-xs"></div>
    </div>
  <div class="sidebar-section" id="calendar-section" data-anchor="calendar">
      <h3 class="font-medium mb-2 flex items-center justify-between">
        <span>Kalendář</span>
        <a href="#calendar" class="text-[10px] px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded" title="Srolovat dolů na kalendář" id="calendar-jump">⇣</a>
      </h3>
      <div class="text-xs text-gray-500 mb-2">Jednoduché plánování pro aktuální projekt</div>
      <div class="flex flex-col gap-2 mb-2">
  <input id="calendar-title" type="text" placeholder="Název události" class="px-2 py-1 border rounded text-sm" />
  <label for="calendar-date" class="sr-only">Datum události</label>
  <input id="calendar-date" type="date" aria-label="Datum události" class="px-2 py-1 border rounded text-sm" />
        <button id="calendar-add" class="text-xs px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600">Přidat událost</button>
      </div>
      <div id="calendar-list" class="flex flex-col gap-2 max-h-56 overflow-auto text-xs"></div>
    </div>
  </div>
  
  <div id="detail-panel">
    <div class="detail-panel-header">
      <h2>Detail boxu <span id="box-position"></span></h2>
      <button class="detail-panel-close" aria-label="Zavřít detail"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
    </div>
    <div class="detail-section"><div class="detail-preview" id="box-preview"></div></div>
    <div class="detail-section">
      <h3 class="font-medium mb-2">Popis</h3>
      <textarea id="box-description" class="w-full p-3 border border-gray-300 rounded-lg" rows="4" placeholder="Zadejte popis tohoto boxu..."></textarea>
      <button id="save-description" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Uložit popis</button>
    </div>
    <div class="detail-section">
      <h3 class="font-medium mb-2">Vlastnosti</h3>
      <div class="grid grid-cols-2 gap-2">
        <div class="p-3 bg-gray-100 rounded-lg"><div class="text-xs text-gray-500">Typ</div><div id="box-type">Standardní</div></div>
        <div class="p-3 bg-gray-100 rounded-lg"><div class="text-xs text-gray-500">Vytvořeno</div><div id="box-created">-</div></div>
        <div class="p-3 bg-gray-100 rounded-lg"><div class="text-xs text-gray-500">Poslední úprava</div><div id="box-updated">-</div></div>
        <div class="p-3 bg-gray-100 rounded-lg"><div class="text-xs text-gray-500">Autor</div><div id="box-author">-</div></div>
      </div>
    </div>
  </div>
  
  <div class="nav-icons" id="nav-icons">
    <div class="nav-icon" data-action="rename" title="Přejmenovat text">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
    </div>
    <div class="nav-icon" data-action="link" title="Přidat odkaz">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
    </div>
    <div class="nav-icon" data-action="color" title="Změnit barvu">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg>
    </div>
    <div class="nav-icon" data-action="delete" title="Smazat obsah (nebo klávesa Del)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
    </div>
  </div>
  
  <div class="workspace-loading" id="workspace-loading"><div class="workspace-loading-spinner"></div></div>

  <!-- Vlastní (rychlý) náhled pro přetahování -->
  <div id="drag-preview">Přesunuji...</div>

  <!-- NOVÝ KONTEJNER PRO MŘÍŽKU -->
  <div id="grid-container"></div>
  <div id="calendar-view" class="calendar-view-wrapper">
    <div class="calendar-view-header">
      <div class="calendar-view-title">Kalendář událostí</div>
    </div>
    <div id="calendar-view-list" class="calendar-view-list"></div>
  </div>
  <div id="assets-view" class="assets-view-wrapper">
    <div class="assets-view-header">
      <div class="assets-view-title">Firebase Storage – Assets</div>
      <button id="assets-refresh" class="assets-view-refresh">Obnovit</button>
    </div>
    <div id="assets-view-content" class="assets-view-grid"></div>
    <div id="assets-view-empty" class="text-sm text-gray-400"></div>
  </div>
  <div id="gallery-view" class="gallery-view-wrapper">
    <div class="gallery-view-header">
      <div class="gallery-view-title">Galerie – všechny obrázky</div>
      <div class="gallery-view-controls">
        <select id="gallery-filter" class="gallery-view-select">
          <option value="all">Všechny složky</option>
        </select>
        <select id="gallery-sort" class="gallery-view-select">
          <option value="desc">Největší → Nejmenší</option>
          <option value="asc">Nejmenší → Největší</option>
        </select>
        <button id="gallery-refresh" class="gallery-view-refresh">Obnovit</button>
      </div>
    </div>
    <div id="gallery-view-grid" class="gallery-view-grid"></div>
    <div id="gallery-view-empty" class="text-sm text-gray-400"></div>
  </div>
  <div id="plan-view" class="plan-view-wrapper">
    <div class="plan-view-header">
      <h2>📋 Strategický plán</h2>
      <p>Sdílený přehled priorit pro Project_73. Najdeš zde prompty pro AI asistenty, klíčovou dokumentaci a rychlé úkoly k rozpracování s jednotlivými nástroji.</p>
    </div>
    <div class="plan-cards">
      <section class="plan-card">
        <h3>🤖 AI asistenti</h3>
        <p>Preferovaný prompt pro rychlé nastavení Firebase projektů. Zkopíruj do Copilota, Geminia nebo CodeXu podle potřeby.</p>
        <pre class="plan-snippet">Potřebuji nastavit Firebase v novém projektu s těmito požadavky:

ZÁKLADNÍ KONFIGURACE:
- Firebase v10+ modular SDK
- Anonymous authentication
- Firestore database pro [popis dat]
- Firebase Storage pro [typ souborů]
- Real-time synchronizace

KRITICKÉ POŽADAVKY (z Project_73 zkušeností):
1. Implementuj BROWSER FINGERPRINT systém pro stabilní session ID
2. Vytvoř FALLBACK strategie pro nalezení existujících dat
3. Vyvaž se composite indexům - používej JavaScript sorting
4. Správně nastav Storage bucket bez manual URL
5. Implementuj localStorage cache pro rychlejší startup
6. Ujisti se že real-time listenery skutečně updateují UI

STRUKTURA DATABÁZE:
- Kolekce: [název]-sessions
- Document ID: session_[timestamp]_[userID]
- Povinná pole: userId, browserFingerprint, [tvoje data], created, lastModified

POVINNÉ FUNKCE:
- getBrowserFingerprint() - stable browser ID
- findSessionByFingerprint() - najdi session podle browseru
- findAnySessionWithData() - fallback na jakákoliv data
- updateSessionUser() - propoj data s current user
- setupRealtimeListener() - real-time sync

DEBUGGING TOOLS:
- Vytvoř diagnostic page pro testování připojení
- Přidej console debugging funkce
- Implementuj manual session loading pro testing

Chci že aplikace funguje SPOLEHLIVĚ napříč page reloads bez ztráty dat.</pre>
        <div class="plan-meta">
          <span>Zdroj: <a href="../1-FIREBASE_SOLUTION_GUIDE.md" target="_blank" rel="noopener">1-FIREBASE_SOLUTION_GUIDE.md</a></span>
          <span>Tip: Ulož si prompt do dokumentu asistenta pro rychlé vložení.</span>
        </div>
      </section>
      <section class="plan-card">
        <h3>📚 Dokumentace</h3>
        <p>Klíčové podklady pro nové spolupracovníky a AI asistenty. Klikni na odkaz, otevře se v nové záložce.</p>
        <ul class="plan-links">
          <li>
            <a href="../GRID-SETUP-COMPLETE.md" target="_blank" rel="noopener">GRID-SETUP-COMPLETE.md</a>
            <span>Postup nasazení grid aplikace od inicializace po produkci.</span>
          </li>
          <li>
            <a href="../DAY73/manuál_copilot_GRIDapp" target="_blank" rel="noopener">manuál_copilot_GRIDapp</a>
            <span>Krok za krokem průvodce pro GitHub Copilot.</span>
          </li>
          <li>
            <a href="../Projects-Overview.md" target="_blank" rel="noopener">Projects-Overview.md</a>
            <span>Rychlý přehled aktivních modulů a navázaných promptů.</span>
          </li>
        </ul>
      </section>
      <section class="plan-card">
        <h3>✅ Rychlé úkoly</h3>
        <p>Aktuální priority z interního seznamu úkolů. Vhodné pro rychlé předání do jednotlivých vláken.</p>
        <ul class="plan-links">
          <li>
            <span><strong>Menu „Plán“:</strong> rozšiř obsah o nové články a sekce podle potřeb týmu.</span>
          </li>
          <li>
            <span><strong>Rozdělení kódu:</strong> připrav samostatné moduly pro Copilot (menu), Gemini (analytika) a CodeX (Firebase).</span>
          </li>
          <li>
            <span><strong>Integrace GitHub & doména:</strong> dokonči napojení repozitáře a nastav vlastní doménu s Google přihlášením.</span>
          </li>
        </ul>
      </section>
    </div>
  </div>
  <div id="snippet-library-view" class="snippet-view-wrapper">
    <div class="snippet-header">
      <h2>🧠 Knihovna kódů</h2>
      <p>Ukládejte si často používané části kódu s náhledovým obrázkem a popisem. Všechno se ukládá přímo do Firebase a máte k tomu přístup z jakéhokoli zařízení po přihlášení.</p>
    </div>
    <form id="snippet-form" class="snippet-form">
      <div class="snippet-form-grid">
        <div class="snippet-form-field">
          <label for="snippet-title">Název</label>
          <input id="snippet-title" name="title" type="text" placeholder="Landing page hero, formulář..." required />
        </div>
        <div class="snippet-form-field full">
          <label for="snippet-thumbnail">Náhled (URL obrázku)</label>
          <input id="snippet-thumbnail" name="thumbnailUrl" type="text" placeholder="https://.../preview.png nebo vlož (Ctrl+V)" />
        </div>
        <div class="snippet-form-field full">
          <label for="snippet-thumbnail-file">Nahrát printscreen</label>
          <div class="snippet-upload-group">
            <div id="snippet-upload-preview" class="snippet-upload-preview">Bez náhledu</div>
            <div id="snippet-paste-drop-zone"><span>Vlož sem printscreen (Ctrl/⌘+V)<br/>nebo přetáhni obrázek</span></div>
            <div class="snippet-upload-actions">
              <input id="snippet-thumbnail-file" type="file" accept="image/*" hidden />
              <div class="flex gap-2">
                <button type="button" id="snippet-upload-select" class="snippet-button-upload">Vybrat obrázek</button>
                <button type="button" id="snippet-upload-clear" class="snippet-button-ghost">Odebrat</button>
              </div>
              <div class="snippet-upload-status" id="snippet-upload-status">Soubor nevybrán</div>
              <div class="text-xs text-gray-400">Po nahrání se URL vyplní automaticky.</div>
            </div>
          </div>
        </div>
        <div class="snippet-form-field full">
          <label for="snippet-description">Popis</label>
          <textarea id="snippet-description" name="description" rows="3" placeholder="Krátké poznámky k použití..."></textarea>
        </div>
        <div class="snippet-form-field full">
          <label for="snippet-code">Kód</label>
          <textarea id="snippet-code" name="code" rows="8" placeholder="Sem vlož kód" required></textarea>
        </div>
      </div>
      <div class="snippet-alert">Tip: Vlož printscreen (Ctrl/⌘+V), přetáhni obrázek nebo vyplň URL – po nahrání se doplní automaticky.</div>
      <div class="snippet-form-actions">
        <button type="button" id="snippet-reset" class="snippet-button-secondary">Vymazat formulář</button>
        <button type="submit" class="snippet-button-primary">Uložit kód</button>
      </div>
    </form>
    <div class="snippet-list-header">
      <div class="snippet-list-header-top">
        <h3 class="snippet-list-title">Uložené kódy</h3>
        <div class="snippet-list-count">Celkem: <span id="snippet-count">0</span></div>
      </div>
      <input id="snippet-search" type="search" class="snippet-search" placeholder="Filtrovat podle názvu nebo popisu" />
    </div>
  <div id="snippet-empty" class="snippet-empty">Žádné kódy zatím nejsou uložené. Přidej první pomocí formuláře výše.</div>
    <div id="snippet-list" class="snippet-list"></div>
  </div>
  <div id="assets-modal-backdrop" class="assets-modal-backdrop">
    <div class="assets-modal">
      <div class="assets-modal-header">
        <h3 id="assets-modal-title">Assets</h3>
        <button id="assets-modal-close" class="assets-modal-close" aria-label="Zavřít">×</button>
      </div>
      <div class="assets-modal-body">
        <div id="assets-modal-summary" class="text-sm text-gray-500 mb-4"></div>
        <div id="assets-modal-grid" class="assets-modal-grid"></div>
        <div id="assets-modal-empty" class="text-sm text-gray-400"></div>
      </div>
    </div>
  </div>
  
  <!-- ✅ Quick Deploy Panel -->
  <div id="deploy-panel" style="position:fixed; bottom:16px; right:16px; width:360px; background:#111827; color:#f1f5f9; font:12px/1.45 'Inter',sans-serif; padding:14px 16px; border-radius:12px; box-shadow:0 12px 32px rgba(0,0,0,.35); display:none; z-index:3000;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px;">
      <strong style="font-size:13px;">⚡ Quick Deploy</strong>
      <div style="display:flex; gap:4px;">
        <button id="deploy-mode" style="background:#1e293b;border:0;color:#cbd5e1;cursor:pointer;font-size:11px;padding:4px 10px;border-radius:8px;">Deploy</button>
        <button id="debug-mode" style="background:#374151;border:0;color:#9ca3af;cursor:pointer;font-size:11px;padding:4px 10px;border-radius:8px;">Debug</button>
        <button id="deploy-close" style="background:none;border:0;color:#94a3b8;cursor:pointer;font-size:16px;line-height:1;">×</button>
      </div>
    </div>
    <pre style="margin:0; white-space:pre; overflow:auto; max-height:170px;"><code id="deploy-commands">npm run sync:grid
npm run build
firebase deploy --only hosting:onlineday73
# +functions (pokud změny ve functions/)
firebase deploy --only hosting:onlineday73,functions
# Preview (např. PR 123)
firebase hosting:channel:deploy pr-123 --expires 7d --only hosting:onlineday73
# Pozn: npm install spouštěj jen při změně závislostí
</code></pre>
    <pre id="debug-commands" style="margin:0; white-space:pre; overflow:auto; max-height:170px; display:none;"><code># 🐛 TROUBLESHOOTING: Změny se nezobrazují v browseru

## 1. Cache problém (nejčastější)
# Hard refresh (vynucený reload):
Cmd+Shift+R (Mac) nebo Ctrl+Shift+R (PC)

# DevTools disable cache:
F12 → Network tab → ☑ "Disable cache" → reload

## 2. Dev server cache
# Restart Vite serveru:
Ctrl+C
npm run dev

## 3. Diagnostika v konzoli
# Zkontroluj element v DOM:
document.querySelector('[data-toplink="super-modul"]')

# Ověř načtený soubor:
location.pathname
fetch(location.href.split('?')[0]).then(r=>r.text()).then(t=>console.log(t.includes('Super Modul')))

## 4. Duplicitní soubory
# Ujisti se, že upravuješ správný soubor:
# ✅ DAY73/grid-app-test.html
# ❌ DAY73/grid-app-test (kopie).html

## 5. URL parametry pro cache-bust:
?v=1234567890&cache=false

# 💡 TIP: Vždy jako první zkus hard refresh!
</code></pre>
    <div style="display:flex; gap:6px; margin-top:10px;">
      <button id="deploy-copy" style="flex:1; background:#2563eb; border:0; color:#fff; font-weight:600; padding:6px 10px; border-radius:8px; cursor:pointer;">Copy</button>
      <button id="deploy-min" style="background:#1e293b; border:0; color:#cbd5e1; padding:6px 10px; border-radius:8px; cursor:pointer;">Min</button>
    </div>
  </div>

  <div id="super-modul-view" class="super-modul-view">
    <div class="super-modul-header">
      <h2>🧩 Super Modul</h2>
      <p>Tato scéna je připravená na budoucí agregaci modulů. Zatím je prázdná, takže můžeš začít tvořit od nuly.</p>
    </div>
    <div class="super-modul-stage" aria-hidden="true">Přidej sem první komponentu nebo sekci podle potřeby.</div>
  </div>

  <script>
    // --- Topbar active link highlight (works when this file is standalone) ---
    (function(){
      function focusCalendarSection(){
        requestAnimationFrame(() => {
          const section = document.getElementById('calendar-section');
          if (!section) return;
          section.classList.add('calendar-focus');
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
          setTimeout(() => section.classList.remove('calendar-focus'), 1200);
        });
      }

      function handleViewChange({ shouldScroll = false } = {}){
        const params = new URLSearchParams(window.location.search);
        const view = params.get('view') || 'grid';
        document.querySelectorAll('[data-toplink]').forEach(link => {
          const target = link.getAttribute('data-toplink');
          link.classList.toggle('active', target === view);
        });
        document.body.classList.remove(
          'view-grid','view-snippets','view-calendar','view-deferred','view-assets','view-gallery','view-super-modul','view-plan'
        );
        if(view === 'snippets') document.body.classList.add('view-snippets');
        else if(view === 'calendar') document.body.classList.add('view-calendar');
        else if(view === 'deferred') document.body.classList.add('view-deferred');
        else if(view === 'assets') document.body.classList.add('view-assets');
        else if(view === 'gallery') document.body.classList.add('view-gallery');
        else if(view === 'plan') document.body.classList.add('view-plan');
        else if(view === 'super-modul') document.body.classList.add('view-super-modul');
        else document.body.classList.add('view-grid');
        if(shouldScroll){ window.scrollTo({ top:0, behavior:'smooth'}); }
      }

      window.addEventListener('popstate', () => handleViewChange({ shouldScroll: true }));
      handleViewChange({ shouldScroll: true });

      const calendarNav = document.querySelector('[data-toplink="calendar"]');
      if (calendarNav){
        calendarNav.addEventListener('click', (event) => {
          event.preventDefault();
          const url = new URL(window.location.href);
          url.searchParams.set('view', 'calendar');
          const nextUrl = `${url.pathname}?${url.searchParams.toString()}#calendar`;
          window.history.pushState({}, '', nextUrl);
          handleViewChange({ shouldScroll: true });
        });
      }
    })();

    const SNIPPET_COLLECTION_ROOT = 'project73-snippets';
    const SNIPPET_SUBCOLLECTION = 'items';
    let snippetLibraryData = [];
    let snippetFilterQuery = '';
    let snippetLibraryInitialized = false;
    let snippetLibraryLoading = false;
    let snippetLibraryUnsubscribe = null;
    let snippetLibraryError = null;

    function detachSnippetLibraryListener() {
      if (typeof snippetLibraryUnsubscribe === 'function') {
        try { snippetLibraryUnsubscribe(); } catch (_) {}
      }
      snippetLibraryUnsubscribe = null;
    }

    function getUserSnippetCollection() {
      if (!isFirebaseReady || !currentUser) return null;
      const { db, collection } = window.firebase;
      return collection(db, SNIPPET_COLLECTION_ROOT, currentUser.uid, SNIPPET_SUBCOLLECTION);
    }

    function sanitizeFileName(name = '') {
      return name.toLowerCase().replace(/[^a-z0-9._-]+/gi, '-').replace(/^-+|-+$/g, '') || 'screenshot.png';
    }

    function uploadSnippetThumbnailFile(file, onProgress) {
      return new Promise((resolve, reject) => {
        if (!file) {
          reject(new Error('Soubor nebyl vybrán'));
          return;
        }
        if (!window.firebase || !window.firebase.storage) {
          reject(new Error('Firebase není inicializováno'));
          return;
        }
        if (!currentUser || !currentUser.uid) {
          reject(new Error('Pro nahrání se přihlaste')); 
          return;
        }

        const { storage, ref, uploadBytesResumable, getDownloadURL } = window.firebase;
        const uid = currentUser.uid;
        const extension = (file.type && file.type.includes('/')) ? file.type.split('/')[1] : 'png';
        const baseName = sanitizeFileName(file.name || `printscreen.${extension}`);
        const storagePath = `project73-snippet-thumbnails/${uid}/${Date.now()}-${baseName}`;
        const storageRef = ref(storage, storagePath);
        const metadata = { contentType: file.type || 'image/png' };
        const uploadTask = uploadBytesResumable(storageRef, file, metadata);

        uploadTask.on('state_changed', (snapshot) => {
          if (typeof onProgress === 'function' && snapshot.totalBytes > 0) {
            const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            onProgress(progress);
          }
        }, (error) => {
          reject(error);
        }, async () => {
          try {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            resolve({ url: downloadURL, storagePath });
          } catch (error) {
            reject(error);
          }
        });
      });
    }

    function renderSnippetLibrary() {
      const listEl = document.getElementById('snippet-list');
      const emptyEl = document.getElementById('snippet-empty');
      const countEl = document.getElementById('snippet-count');
      if (!listEl || !emptyEl || !countEl) return;

      if (!isFirebaseReady || !currentUser) {
        countEl.textContent = '0';
        listEl.innerHTML = '';
        listEl.style.display = 'none';
        emptyEl.textContent = 'Přihlaste se pro ukládání kódů.';
        emptyEl.style.display = 'block';
        return;
      }

      if (snippetLibraryLoading) {
        countEl.textContent = snippetLibraryData.length.toString();
        listEl.innerHTML = '';
        listEl.style.display = 'none';
        emptyEl.textContent = 'Načítám kódy z databáze...';
        emptyEl.style.display = 'block';
        return;
      }

      if (snippetLibraryError) {
        countEl.textContent = snippetLibraryData.length.toString();
        listEl.innerHTML = '';
        listEl.style.display = 'none';
        emptyEl.textContent = 'Nepodařilo se načíst kódy. Zkuste to prosím znovu.';
        emptyEl.style.display = 'block';
        return;
      }

      const query = snippetFilterQuery.trim().toLowerCase();
      const filtered = query
        ? snippetLibraryData.filter((snippet) => {
            const haystack = `${snippet.title} ${snippet.description || ''}`.toLowerCase();
            return haystack.includes(query);
          })
        : [...snippetLibraryData];

      countEl.textContent = snippetLibraryData.length.toString();
      listEl.innerHTML = '';

      if (filtered.length === 0) {
        emptyEl.textContent = snippetLibraryData.length === 0
          ? 'Žádné kódy zatím nejsou uložené. Přidej první pomocí formuláře výše.'
          : 'Žádný kód neodpovídá filtru. Změň hledání nebo přidej nový.';
        emptyEl.style.display = 'block';
        listEl.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      listEl.style.display = 'grid';

      filtered.forEach((snippet) => {
        const card = document.createElement('article');
        card.className = 'snippet-card';
        card.dataset.snippetId = snippet.id;

        const thumb = document.createElement('div');
        thumb.className = 'snippet-card-thumb';
        if (snippet.thumbnailUrl) {
          const img = document.createElement('img');
          img.src = snippet.thumbnailUrl;
          img.alt = snippet.title;
          thumb.appendChild(img);
        } else {
          thumb.textContent = '🧩';
        }
        card.appendChild(thumb);

        const body = document.createElement('div');
        body.className = 'snippet-card-body';

        const title = document.createElement('h4');
        title.className = 'snippet-card-title';
        title.textContent = snippet.title;
        body.appendChild(title);

        if (snippet.description) {
          const desc = document.createElement('p');
          desc.className = 'snippet-card-description';
          desc.textContent = snippet.description;
          body.appendChild(desc);
        }

        const meta = document.createElement('div');
        meta.className = 'snippet-card-meta';
        if (snippet.createdAt instanceof Date && !Number.isNaN(snippet.createdAt.valueOf())) {
          meta.textContent = `Uloženo ${snippet.createdAt.toLocaleString('cs-CZ')}`;
        } else if (typeof snippet.createdAt === 'string' && snippet.createdAt) {
          meta.textContent = `Uloženo ${snippet.createdAt}`;
        } else {
          meta.textContent = 'Uloženo —';
        }
        body.appendChild(meta);

        const code = document.createElement('pre');
        code.className = 'snippet-code';
        code.textContent = snippet.code;
        body.appendChild(code);

        const actions = document.createElement('div');
        actions.className = 'snippet-card-actions';

        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'snippet-button-copy';
        copyBtn.dataset.snippetAction = 'copy';
        copyBtn.textContent = 'Kopírovat kód';
        actions.appendChild(copyBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'snippet-button-delete';
        deleteBtn.dataset.snippetAction = 'delete';
        deleteBtn.textContent = 'Smazat';
        actions.appendChild(deleteBtn);

        body.appendChild(actions);
        card.appendChild(body);

        listEl.appendChild(card);
      });
    }

    function attachSnippetRealtimeListener() {
      const collectionRef = getUserSnippetCollection();
      if (!collectionRef) {
        detachSnippetLibraryListener();
        snippetLibraryData = [];
        snippetLibraryLoading = false;
        snippetLibraryError = null;
        renderSnippetLibrary();
        return;
      }

      const { query, orderBy, onSnapshot } = window.firebase;
      detachSnippetLibraryListener();
      snippetLibraryLoading = true;
      snippetLibraryError = null;
      renderSnippetLibrary();

      try {
        const q = query(collectionRef, orderBy('createdAt', 'desc'));
        snippetLibraryUnsubscribe = onSnapshot(q, (snapshot) => {
          snippetLibraryLoading = false;
          snippetLibraryError = null;
          snippetLibraryData = snapshot.docs.map((docSnap) => {
            const data = docSnap.data() || {};
            let createdAt = null;
            const rawCreated = data.createdAt;
            if (rawCreated && typeof rawCreated.toDate === 'function') {
              createdAt = rawCreated.toDate();
            } else if (rawCreated) {
              createdAt = new Date(rawCreated);
            }
            return {
              id: docSnap.id,
              title: data.title || '',
              description: data.description || '',
              code: data.code || '',
              thumbnailUrl: data.thumbnailUrl || '',
              thumbnailStoragePath: data.thumbnailStoragePath || '',
              createdAt,
              authorId: data.authorId || currentUser?.uid || ''
            };
          });
          if (snippetLibraryData.length > 1) {
            snippetLibraryData.sort((a, b) => {
              const aTime = a.createdAt instanceof Date ? a.createdAt.getTime() : 0;
              const bTime = b.createdAt instanceof Date ? b.createdAt.getTime() : 0;
              return bTime - aTime;
            });
          }
          renderSnippetLibrary();
        }, (error) => {
          console.error('SnippetLibrary: realtime listener error', error);
          snippetLibraryLoading = false;
          snippetLibraryError = error || new Error('Neznámá chyba');
          renderSnippetLibrary();
        });
      } catch (error) {
        console.error('SnippetLibrary: failed to attach listener', error);
        snippetLibraryLoading = false;
        snippetLibraryError = error;
        renderSnippetLibrary();
      }
    }

    function initSnippetLibrary() {
      if (snippetLibraryInitialized) {
        attachSnippetRealtimeListener();
        renderSnippetLibrary();
        return;
      }

      snippetLibraryInitialized = true;

      const form = document.getElementById('snippet-form');
      const resetBtn = document.getElementById('snippet-reset');
      const searchInput = document.getElementById('snippet-search');
      const listEl = document.getElementById('snippet-list');
      const thumbnailUrlInput = document.getElementById('snippet-thumbnail');
      const fileInput = document.getElementById('snippet-thumbnail-file');
      const selectBtn = document.getElementById('snippet-upload-select');
      const clearBtn = document.getElementById('snippet-upload-clear');
      const statusEl = document.getElementById('snippet-upload-status');
      const previewEl = document.getElementById('snippet-upload-preview');

      if (!form || !listEl || !searchInput || !thumbnailUrlInput || !fileInput || !selectBtn || !clearBtn || !statusEl || !previewEl) {
        console.warn('SnippetLibrary: UI elements missing, initialization skipped.');
        return;
      }

      let snippetThumbnailUploadInfo = null;
      let snippetThumbnailPreviewUrl = null;
      let snippetThumbnailUploading = false;

      const updateStatus = (text, color = '#6b7280') => {
        statusEl.textContent = text;
        statusEl.style.color = color;
      };

      const resetThumbnailPreview = () => {
        snippetThumbnailUploadInfo = null;
        if (snippetThumbnailPreviewUrl) {
          URL.revokeObjectURL(snippetThumbnailPreviewUrl);
          snippetThumbnailPreviewUrl = null;
        }
        previewEl.innerHTML = 'Bez náhledu';
        updateStatus('Soubor nevybrán');
        fileInput.value = '';
      };

      const setPreviewImage = (file) => {
        if (!file) {
          resetThumbnailPreview();
          return;
        }
        if (snippetThumbnailPreviewUrl) {
          URL.revokeObjectURL(snippetThumbnailPreviewUrl);
        }
        snippetThumbnailPreviewUrl = URL.createObjectURL(file);
        previewEl.innerHTML = '';
        const img = document.createElement('img');
        img.src = snippetThumbnailPreviewUrl;
        img.alt = 'Náhled snippetu';
        previewEl.appendChild(img);
      };

      const showPreviewFromUrl = (url) => {
        if (snippetThumbnailPreviewUrl) {
          URL.revokeObjectURL(snippetThumbnailPreviewUrl);
          snippetThumbnailPreviewUrl = null;
        }
        if (!url) {
          resetThumbnailPreview();
          return;
        }
        snippetThumbnailUploadInfo = null;
        previewEl.innerHTML = '';
        const img = document.createElement('img');
        img.alt = 'Náhled snippetu';
        img.src = url;
        img.onload = () => updateStatus('Náhled z URL', '#6b7280');
        img.onerror = () => {
          updateStatus('URL náhledu se nepodařilo načíst.', '#dc2626');
          previewEl.innerHTML = 'Bez náhledu';
        };
        previewEl.appendChild(img);
      };

      const handleThumbnailFile = async (file) => {
        if (!file) {
          return;
        }
        if (!isFirebaseReady || !currentUser) {
          updateStatus('Přihlas se pro nahrání náhledu.', '#dc2626');
          showBanner('Pro nahrání printscreenů je nutné být přihlášen.', 'error');
          return;
        }

        setPreviewImage(file);
        snippetThumbnailUploading = true;
        selectBtn.disabled = true;
        clearBtn.disabled = true;
        updateStatus('Nahrávání... 0%', '#2563eb');

        try {
          const result = await uploadSnippetThumbnailFile(file, (progress) => {
            updateStatus(`Nahrávání... ${progress}%`, '#2563eb');
          });
          snippetThumbnailUploadInfo = result;
          thumbnailUrlInput.value = result.url;
          updateStatus('Náhled úspěšně nahrán ✓', '#047857');
        } catch (error) {
          console.error('SnippetLibrary: upload failed', error);
          updateStatus('Chyba při nahrávání.', '#dc2626');
          showBanner('Nahrání obrázku se nezdařilo.', 'error');
          resetThumbnailPreview();
        } finally {
          snippetThumbnailUploading = false;
          selectBtn.disabled = false;
          clearBtn.disabled = false;
        }
      };

      selectBtn.addEventListener('click', () => {
        if (snippetThumbnailUploading) return;
        fileInput.click();
      });

      clearBtn.addEventListener('click', () => {
        resetThumbnailPreview();
        thumbnailUrlInput.value = '';
      });

      fileInput.addEventListener('change', () => {
        const file = fileInput.files && fileInput.files[0];
        if (file) {
          handleThumbnailFile(file);
        } else {
          resetThumbnailPreview();
        }
      });

      const handleThumbnailUrlChange = () => {
        if (snippetThumbnailUploading) return;
        const url = thumbnailUrlInput.value.trim();
        if (!url) {
          resetThumbnailPreview();
          return;
        }
        showPreviewFromUrl(url);
      };

      thumbnailUrlInput.addEventListener('change', handleThumbnailUrlChange);
      thumbnailUrlInput.addEventListener('blur', handleThumbnailUrlChange);

      resetThumbnailPreview();

      const submitBtn = form.querySelector('button[type="submit"]');

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const title = form.elements.title?.value?.trim() || '';
        const description = form.elements.description?.value?.trim() || '';
        const code = form.elements.code?.value?.trim() || '';
        const thumbnailUrl = form.elements.thumbnailUrl?.value?.trim() || '';

        if (!title || !code) {
          alert('Vyplň název i kód.');
          return;
        }
        if (snippetThumbnailUploading) {
          alert('Počkej, než se dokončí nahrávání náhledu.');
          return;
        }
        if (!isFirebaseReady || !currentUser) {
          showBanner('Pro ukládání kódů se nejprve přihlaste.', 'error');
          return;
        }

        const collectionRef = getUserSnippetCollection();
        if (!collectionRef) {
          showBanner('Databáze není připravena. Zkuste to prosím znovu.', 'error');
          return;
        }

        const { addDoc, serverTimestamp } = window.firebase;
        const payload = {
          title,
          description,
          code,
          thumbnailUrl,
          thumbnailStoragePath: snippetThumbnailUploadInfo?.storagePath || '',
          authorId: currentUser.uid,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        snippetFilterQuery = '';
        searchInput.value = '';

        let prevText = null;
        if (submitBtn) {
          prevText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = 'Ukládám...';
        }

        try {
          await addDoc(collectionRef, payload);
          form.reset();
          resetThumbnailPreview();
          showBanner('Kód byl uložen.', 'info');
        } catch (error) {
          console.error('SnippetLibrary: save failed', error);
          showBanner('Kód se nepodařilo uložit.', 'error');
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = prevText || 'Uložit kód';
          }
        }
      });

      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          form.reset();
          const titleInput = document.getElementById('snippet-title');
          if (titleInput) titleInput.focus();
          resetThumbnailPreview();
        });
      }

      searchInput.addEventListener('input', (event) => {
        snippetFilterQuery = event.target.value || '';
        renderSnippetLibrary();
      });

      listEl.addEventListener('click', async (event) => {
        const actionBtn = event.target.closest('[data-snippet-action]');
        if (!actionBtn) return;
        const card = actionBtn.closest('[data-snippet-id]');
        if (!card) return;
        const snippetId = card.dataset.snippetId;
        const snippet = snippetLibraryData.find((item) => item.id === snippetId);
        if (!snippet) return;

        const action = actionBtn.dataset.snippetAction;
        if (action === 'copy') {
          try {
            await navigator.clipboard.writeText(snippet.code);
            const original = actionBtn.textContent;
            actionBtn.textContent = '✓ Zkopírováno';
            actionBtn.disabled = true;
            setTimeout(() => {
              if (!actionBtn.isConnected) return;
              actionBtn.textContent = original;
              actionBtn.disabled = false;
            }, 2000);
          } catch (error) {
            console.error('SnippetLibrary: copy failed', error);
            alert('Nepodařilo se zkopírovat kód.');
          }
        }

        if (action === 'delete') {
          if (!isFirebaseReady || !currentUser) {
            showBanner('Pro mazání kódů se nejprve přihlaste.', 'error');
            return;
          }
          const confirmed = confirm('Opravdu odstranit tento kód?');
          if (!confirmed) return;
          try {
            const { db, doc, deleteDoc, ref, deleteObject } = window.firebase;
            const docRef = doc(db, SNIPPET_COLLECTION_ROOT, currentUser.uid, SNIPPET_SUBCOLLECTION, snippetId);
            await deleteDoc(docRef);
            if (snippet.thumbnailStoragePath) {
              try {
                await deleteObject(ref(window.firebase.storage, snippet.thumbnailStoragePath));
              } catch (storageErr) {
                console.debug('SnippetLibrary: storage delete skipped', storageErr);
              }
            }
            showBanner('Kód byl odebrán.', 'info');
          } catch (error) {
            console.error('SnippetLibrary: delete failed', error);
            showBanner('Kód se nepodařilo odstranit.', 'error');
          }
        }
      });
      // ================================================
      // Clipboard Paste (image -> dataURL preview + storage)
      // ================================================
      const pasteAllowedTags = new Set(['INPUT','TEXTAREA']);
      document.addEventListener('paste', async (e) => {
        const wrapper = document.getElementById('snippet-library-view');
        if (!wrapper) return;
        // Viditelnost: kontrolujeme display / offsetParent místo pouze class.
        const isVisible = wrapper.offsetParent !== null || document.body.classList.contains('view-snippets');
        if (!isVisible) return;
        if (!e.clipboardData) return;
        console.debug('[PasteHandler] Paste event detected, analyzing clipboard items...');
        // Informativní status, pokud ještě nic neprobíhá
        if (!snippetThumbnailUploading) {
          updateStatus('Analyzuji clipboard…', '#6b7280');
        }
        const active = document.activeElement;
        // Pokud fokus není ve formuláři ani inputu, ale jsme ve viditelné sekci, dovolíme vložení.
        if (active && active !== document.body) {
          // pass – neblokujeme, jen info
        } else {
          // Auto-focus title field for convenience
          const titleInput = document.getElementById('snippet-title');
          if (titleInput) titleInput.focus();
        }
        const items = Array.from(e.clipboardData.items || []);
        let imgItem = items.find(i => i.type && i.type.startsWith('image/'));
        // Fallback: některé aplikace vkládají image jako image/png; to už pokrývá startsWith
        // Pokud nic nenalezeno, zkusíme asynchronous clipboard API (Chromium-based)
        if (!imgItem && navigator.clipboard && navigator.clipboard.read) {
          try {
            console.debug('[PasteHandler] Trying navigator.clipboard.read() fallback');
            const clipboardItems = await navigator.clipboard.read();
            for (const ci of clipboardItems) {
              for (const type of ci.types) {
                if (type.startsWith('image/')) {
                  const blob = await ci.getType(type);
                  imgItem = { getAsFile: () => blob, type };
                  break;
                }
              }
              if (imgItem) break;
            }
          } catch (err) {
            console.debug('[PasteHandler] navigator.clipboard.read() failed', err);
          }
        }
        if (!imgItem) {
          updateStatus('Clipboard neobsahuje obrázek. (Použij PrintScreen nebo zkopíruj obrázek)', '#dc2626');
          const zoneNF = document.getElementById('snippet-paste-drop-zone');
          if (zoneNF){
            zoneNF.classList.add('active');
            setTimeout(()=> zoneNF.classList.remove('active'), 800);
          }
          return;
        }
        const file = imgItem.getAsFile();
        if (!file) return;
        // Pokud už probíhá upload do cloudu, nechceme zasahovat
        if (snippetThumbnailUploading) return;
        // Pokud je uživatel přihlášen a Firebase připravené -> rovnou upload jako u file inputu
        if (isFirebaseReady && currentUser) {
          updateStatus('Uploaduji vložený printscreen...', '#2563eb');
          handleThumbnailFile(file); // využije existující workflow (progress, preview, URL)
        } else {
          const reader = new FileReader();
          updateStatus('Zpracovávám vložený obrázek (lokálně)...', '#2563eb');
          reader.onload = () => {
            snippetThumbnailUploadInfo = null; // dataURL lokální
            const dataUrl = reader.result;
            thumbnailUrlInput.value = dataUrl;
            if (snippetThumbnailPreviewUrl) {
              URL.revokeObjectURL(snippetThumbnailPreviewUrl);
              snippetThumbnailPreviewUrl = null;
            }
            previewEl.innerHTML = '';
            const img = document.createElement('img');
            img.alt = 'Náhled (vložený)';
            img.src = dataUrl;
            previewEl.appendChild(img);
            updateStatus('Náhled vložen lokálně ✓ (přihlas se pro upload)', '#047857');
            console.debug('[PasteHandler] Image pasted (local), data URL length:', (dataUrl||'').length);
            const zone = document.getElementById('snippet-paste-drop-zone');
            if (zone){
              zone.classList.add('active');
              setTimeout(()=> zone.classList.remove('active'), 1200);
            }
          };
          reader.onerror = () => updateStatus('Chyba při čtení vloženého obrázku.', '#dc2626');
          reader.readAsDataURL(file);
        }
      });

      // Drag & Drop support for paste/drop zone
      const pasteZone = document.getElementById('snippet-paste-drop-zone');
      if (pasteZone){
        ['dragenter','dragover'].forEach(evt => pasteZone.addEventListener(evt, (e)=>{
          e.preventDefault(); e.stopPropagation();
          pasteZone.classList.add('active');
        }));
        ['dragleave','dragend','drop'].forEach(evt => pasteZone.addEventListener(evt, (e)=>{
          if (evt !== 'drop'){ pasteZone.classList.remove('active'); }
        }));
        pasteZone.addEventListener('drop',(e)=>{
          e.preventDefault();
          pasteZone.classList.remove('active');
          const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (file && file.type.startsWith('image/')){
            handleThumbnailFile(file); // využijeme stávající upload + preview logiku
          }
        });
        pasteZone.addEventListener('click', () => {
          const titleInput = document.getElementById('snippet-title');
          if (titleInput) titleInput.focus();
        });
      }

      attachSnippetRealtimeListener();
      renderSnippetLibrary();
    }
    // =================================================================================
    // --- 1. KONFIGURACE A GLOBÁLNÍ STAV ---
    // =================================================================================
    let activeBox = null;
    let currentUser = null;
    let isEditingText = false;
    let isFirebaseReady = false;
    let uploadQueue = [];
    let currentBoxDetails = null;
    let unsubscribeListener = null; 
    let dragSource = null;
  let lastDragOverEl = null; // pro čištění .dragover
  let lastDragSwapPositions = null; // uchování posledních swapovaných pozic pro integritu
  // Cache aktuálního stavu gridu pro diff rendering
  let gridDataCache = {}; // { 'r-c': { ..boxData } }
  let googleAuthProviderInstance = null;
  function resetGridState(){
    console.log('[resetGridState] Clearing grid UI and cache');
    gridDataCache = {};
    // Vyčistit všechny boxy v UI
    document.querySelectorAll('.box').forEach(box => {
      box.style.backgroundImage = '';
      box.style.background = '';
      box.removeAttribute('data-link-url');
      box.removeAttribute('data-link-text');
      const span = box.querySelector('span');
      if (span) span.remove();
    });
  }
  function getGoogleAuthProvider(){
    if (!googleAuthProviderInstance){
      const { GoogleAuthProvider } = window.firebase;
      googleAuthProviderInstance = new GoogleAuthProvider();
      googleAuthProviderInstance.setCustomParameters({ prompt: 'select_account' });
    }
    return googleAuthProviderInstance;
  }

  function toggleAuthGate(show, message = ''){
    const gate = document.getElementById('auth-gate');
    const errorEl = document.getElementById('auth-error');
    if (!gate) return;
    if (show){
      gate.classList.remove('hidden');
      document.body.classList.add('auth-locked');
    } else {
      gate.classList.add('hidden');
      document.body.classList.remove('auth-locked');
    }
    if (errorEl !== null){
      errorEl.textContent = message || '';
    }
  }

  function setAuthErrorMessage(message = ''){
    const errorEl = document.getElementById('auth-error');
    if (!errorEl) return;
    errorEl.textContent = message || '';
  }

  function escapeHtml(value){
    if (value === null || value === undefined) return '';
    return String(value).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function cleanupRealtimeListeners(){
    if (_rtUnsub) { _rtUnsub(); _rtUnsub = null; }
    if (unsubscribeDeferred) { unsubscribeDeferred(); unsubscribeDeferred = null; }
    if (unsubscribeCalendar) { unsubscribeCalendar(); unsubscribeCalendar = null; }
    if (typeof unsubscribeListener === 'function') {
      try { unsubscribeListener(); } catch (_) {}
    }
    unsubscribeListener = null;
  }

  function cleanupAfterSignOut(){
    cleanupRealtimeListeners();
    gridDocRef = null;
    sessionId = null;
    currentWorkspace = null;
    userWorkspacesDocRef = null;
    workspaceConfigs = {};
    isFirebaseReady = false;
    currentUser = null;
    uploadQueue = [];
    currentBoxDetails = null;
    dragSource = null;
    lastDragOverEl = null;
   lastDragSwapPositions = null;
   assetsLoadedOnce = false;
    assetsSummaryCache = null;
    galleryLoadedOnce = false;
    galleryCache = null;
    detachSnippetLibraryListener();
    snippetLibraryInitialized = false;
    snippetLibraryData = [];
    snippetFilterQuery = '';
    snippetLibraryLoading = false;
    snippetLibraryError = null;
    const snippetListEl = document.getElementById('snippet-list');
    if (snippetListEl) snippetListEl.innerHTML = '';
    const snippetEmptyEl = document.getElementById('snippet-empty');
    if (snippetEmptyEl) snippetEmptyEl.textContent = 'Přihlaste se pro ukládání kódů.';
    resetGridState();
    const sessionEl = document.getElementById('session-id-display');
    if (sessionEl) sessionEl.textContent = 'N/A';
    updateFirebaseStatus('Odhlášeno');
    const archiveList = document.getElementById('archive-list');
    if (archiveList) archiveList.innerHTML = '<div class="text-xs text-gray-400">Přihlaste se pro zobrazení archivu.</div>';
    const deferredList = document.getElementById('deferred-list');
    if (deferredList) deferredList.innerHTML = '<div class="text-xs text-gray-400">Přihlaste se pro odložené úkoly.</div>';
    const calendarList = document.getElementById('calendar-list');
    if (calendarList) calendarList.innerHTML = '<div class="text-xs text-gray-400">Přihlaste se pro kalendář.</div>';
    const calendarViewList = document.getElementById('calendar-view-list');
    if (calendarViewList) calendarViewList.innerHTML = '';
    const panelsContainer = document.querySelector('.workspace-panels');
    if (panelsContainer) panelsContainer.innerHTML = '';
    const loadingEl = document.getElementById('workspace-loading');
    if (loadingEl) loadingEl.classList.remove('active');
    closeDetailPanel();
  }

  function renderAuthTopbar(user){
    const statusEl = document.getElementById('p73-topbar-status');
    if (!statusEl) return;
    if (user){
      const name = user.displayName || user.email || 'Přihlášený uživatel';
      const email = user.email || '';
      const safeName = escapeHtml(name);
      const safeEmail = escapeHtml(email);
      statusEl.innerHTML = `
        <div class="auth-user-chip">
          <span class="auth-user-name">${safeName}</span>
          ${safeEmail ? `<span class="auth-user-email">${safeEmail}</span>` : ''}
        </div>
        <button id="auth-signout-btn" class="auth-signout-btn" type="button">Odhlásit se</button>
      `;
      const btn = document.getElementById('auth-signout-btn');
      if (btn){
        const { auth, signOut } = window.firebase;
        btn.addEventListener('click', () => {
          btn.disabled = true;
          btn.textContent = 'Odhlášení...';
          signOut(auth).catch(err => {
            console.error('❌ Sign-out failed:', err);
            showBanner('Odhlášení se nezdařilo.', 'error');
            btn.disabled = false;
            btn.textContent = 'Odhlásit se';
          });
        }, { once: true });
      }
    } else {
      statusEl.innerHTML = '<span>Přihlaste se Google účtem</span>';
    }
  }
  // Debug přepínač pro logování diff operací
  const DEBUG_DIFF = false;
  let _rtUnsub = null; // realtime subscription reference (pauza během drag)
  let assetsLoading = false;
  let assetsLoadedOnce = false;
  let assetsSummaryCache = null;
  let galleryLoading = false;
  let galleryLoadedOnce = false;
  let galleryCache = null;
  let galleryFilterPrefix = 'all';
  let gallerySortOrder = 'desc';

    let currentWorkspace = 'workspace1';
    let sessionId = null;
    let gridDocRef = null;
    let userWorkspacesDocRef = null;

    let workspaceConfigs = {};
    // --- Auto-hide konfigurace pro plovoucí lištu nástrojů (nav-icons) ---
    const NAV_ICONS_AUTOHIDE_MS = 4000; // čas neaktivity (ms), po kterém se lišta skryje
    let navIconsHideTimer = null;

  // --- Archivace (soft-delete) konfigurace ---
  const ARCHIVE_COLLECTION = 'project73_archives';
  const ARCHIVE_RETENTION_DAYS = 3; // Počet dní pro obnovu (změněno z 7)

    function cancelNavIconsAutohide(){
      if (navIconsHideTimer){
        clearTimeout(navIconsHideTimer);
        navIconsHideTimer = null;
      }
    }

    function startNavIconsAutohide(){
      cancelNavIconsAutohide();
      const el = document.getElementById('nav-icons');
      if (!el || !el.classList.contains('active')) return;
      navIconsHideTimer = setTimeout(() => {
        el.classList.remove('active');
        navIconsHideTimer = null;
      }, NAV_ICONS_AUTOHIDE_MS);
    }
    // Pomocná funkce: zjištění zda box má nějaký obsah (obrázek, text, barvu, odkaz)
    function boxHasContent(box){
      if(!box) return false;
      const hasBgImage = box.style.backgroundImage && box.style.backgroundImage !== 'none';
      const hasSpanText = !!box.querySelector('span');
      const hasLink = !!box.dataset.linkUrl;
      const hasColorBg = box.style.background && box.style.background !== '' && !box.style.background.includes('rgba(0, 0, 0, 0)');
      return hasBgImage || hasSpanText || hasLink || hasColorBg;
    }

    // =================================================================================
    // --- 2. DATOVÉ OPERACE (FIREBASE & STORAGE) ---
    // =================================================================================
    function getDefaultWorkspaces() {
      return {
        workspace1: { collection: 'project73-sessions', name: "Plocha 1" },
        workspace2: { collection: 'project73-workspace2', name: "Plocha 2" },
        workspace3: { collection: 'project73-workspace3', name: "Plocha 3" },
        workspace4: { collection: 'project73-workspace4', name: "Plocha 4" },
        workspace5: { collection: 'project73-workspace5', name: "Vlastní plocha" },
        elektrocz: { collection: 'project73-elektrocz', name: "elektrocz.com" },
        pokus: { collection: 'project73-pokus', name: "pokus" }
      };
    }

    function normalizeWorkspaceConfigs(rawConfigs = {}) {
      const defaults = getDefaultWorkspaces();
      const normalized = {};

      const addEntry = (id, source) => {
        const base = defaults[id] || {};
        const src = source && typeof source === 'object' ? source : {};
        const collection = src.collection || base.collection;
        if (!collection) return;
        normalized[id] = {
          name: src.name || base.name || id,
          collection,
          sessionId: null,
          gridDocRef: null
        };
      };

      for (const [id, defaultCfg] of Object.entries(defaults)) {
        addEntry(id, rawConfigs[id] || defaultCfg);
      }

      for (const [id, sourceCfg] of Object.entries(rawConfigs)) {
        if (!normalized[id]) {
          addEntry(id, sourceCfg);
        }
      }

      return normalized;
    }

    function prepareWorkspacePayload(configs = {}) {
      const payload = {};
      for (const [id, cfg] of Object.entries(configs)) {
        if (!cfg || typeof cfg !== 'object') continue;
        const entry = {};
        for (const [key, value] of Object.entries(cfg)) {
          if (key === 'sessionId' || key === 'gridDocRef') continue;
          if (value === undefined) continue;
          const valType = typeof value;
          if (valType === 'string' || valType === 'number' || valType === 'boolean' || value === null) {
            entry[key] = value;
          }
        }
        if (!entry.collection) continue;
        if (!entry.name) entry.name = id;
        payload[id] = entry;
      }
      return payload;
    }

    function workspaceConfigNeedsMigration(rawConfigs = {}) {
      for (const cfg of Object.values(rawConfigs || {})) {
        if (!cfg || typeof cfg !== 'object') return true;
        if (!cfg.collection || typeof cfg.collection !== 'string') return true;
        if (Object.prototype.hasOwnProperty.call(cfg, 'gridDocRef')) return true;
        if (Object.prototype.hasOwnProperty.call(cfg, 'sessionId')) return true;
      }
      return false;
    }

    async function loadUserWorkspaceConfig(user) {
      const { db, doc, getDoc, setDoc, updateDoc } = window.firebase;
      userWorkspacesDocRef = doc(db, 'project73_users', user.uid);
      try {
        const snap = await getDoc(userWorkspacesDocRef);
        if (snap.exists()) {
          const raw = snap.data()?.workspaces || {};
          workspaceConfigs = normalizeWorkspaceConfigs(raw);
          if (workspaceConfigNeedsMigration(raw)) {
            await updateDoc(userWorkspacesDocRef, { workspaces: prepareWorkspacePayload(workspaceConfigs) });
          }
        } else {
          workspaceConfigs = normalizeWorkspaceConfigs(getDefaultWorkspaces());
          await setDoc(userWorkspacesDocRef, { workspaces: prepareWorkspacePayload(workspaceConfigs) });
        }
      } catch (error) {
        console.error('❌ loadUserWorkspaceConfig error', error);
        workspaceConfigs = normalizeWorkspaceConfigs(getDefaultWorkspaces());
        try {
          await setDoc(userWorkspacesDocRef, { workspaces: prepareWorkspacePayload(workspaceConfigs) });
        } catch (_) {}
      }

      renderWorkspacePanels();
      Promise.allSettled(Object.keys(workspaceConfigs).map((id) => ensureWorkspaceCollectionExists(id))).catch(() => {});
    }

    // Zajistí že kolekce pro workspace existuje tím, že vytvoří placeholder dokument pokud je kolekce prázdná
    async function ensureWorkspaceCollectionExists(workspaceId) {
      try {
        const cfg = workspaceConfigs[workspaceId];
        if(!cfg || !cfg.collection) return;
        const { db, collection, query, limit, getDocs, doc, setDoc } = window.firebase;
        const q = query(collection(db, cfg.collection), limit(1));
        const snap = await getDocs(q);
        if (snap.empty) {
          const placeholderRef = doc(collection(db, cfg.collection));
            await setDoc(placeholderRef, {
              _init: true,
              createdAt: Date.now(),
              info: 'Placeholder dokument automaticky vytvořen pro inicializaci kolekce.'
            });
            console.log(`📁 Kolekce ${cfg.collection} inicializována placeholder dokumentem.`);
        }
      } catch (e) {
        console.warn('Nepodařilo se inicializovat kolekci pro workspace', workspaceId, e);
      }
    }

    function getBrowserFingerprint() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Browser fingerprint', 2, 2);
      
      const components = [
        navigator.userAgent || '', navigator.language || '',
        screen.width + 'x' + screen.height, screen.colorDepth || '',
        new Date().getTimezoneOffset(), canvas.toDataURL(),
        navigator.platform || '', navigator.cookieEnabled,
        typeof window.localStorage !== 'undefined', typeof window.sessionStorage !== 'undefined'
      ];
      
      const fingerprint = btoa(components.join('|')).replace(/[+=\/]/g, '').substring(0, 16);
      return fingerprint;
    }

    async function findSessionByFingerprint(fingerprint, collectionName) {
      const { db, collection, query, where, limit, getDocs } = window.firebase;
      try {
        const q = query(collection(db, collectionName), where('browserFingerprint', '==', fingerprint), limit(5));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) return null;

        const sessions = querySnapshot.docs.map(d => ({ id: d.id, data: d.data() }));
        let bestSession = null;
        let maxData = -1;

        for (const session of sessions) {
          const dataCount = session.data.gridData ? Object.keys(session.data.gridData).length : 0;
          if (dataCount > maxData) {
            maxData = dataCount;
            bestSession = session;
          }
        }
        return bestSession;
      } catch (error) {
        console.error(`❌ Error finding session by fingerprint in ${collectionName}:`, error);
        return null;
      }
    }

    async function createNewSession(workspaceId) {
        const config = workspaceConfigs[workspaceId];
        const { db, doc, setDoc, serverTimestamp } = window.firebase;
        const fingerprint = getBrowserFingerprint();
        const userId = currentUser.uid;
        
        const newSessionId = `${workspaceId}_${Date.now()}_${userId.slice(0, 8)}`;
        config.sessionId = newSessionId;
        config.gridDocRef = doc(db, config.collection, config.sessionId);

        const sessionData = {
            userId, sessionId: newSessionId, workspaceId, browserFingerprint: fingerprint,
            gridData: {},
            stats: { totalBoxes: 105, filledBoxes: 0, emptyBoxes: 105, isActive: true },
            metadata: { version: "2.0", project: "Project_73", workspace: workspaceId, gridSize: "15x7" },
            created: serverTimestamp(),
            lastModified: serverTimestamp(),
            lastAccessed: serverTimestamp()
        };

        await setDoc(config.gridDocRef, sessionData);
        console.log(`✅ Created new session for ${workspaceId}:`, newSessionId);
        return { sessionId: newSessionId, gridDocRef: config.gridDocRef };
    }

    async function updateBoxDataInFirestore(position, dataToSave) {
        if (!gridDocRef) return;
        const { updateDoc, getDoc, serverTimestamp, doc: fbDoc } = window.firebase;

        if (dataToSave === null) {
            const docSnap = await getDoc(gridDocRef);
            if (docSnap.exists()) {
                const updatedGridData = { ...docSnap.data().gridData };
                delete updatedGridData[position];
                await updateDoc(gridDocRef, {
                    gridData: updatedGridData,
                    'lastModified': serverTimestamp()
                });
            }
            return;
        }

        const docSnap = await getDoc(gridDocRef);
        if (!docSnap.exists()) return;

        const gridData = docSnap.data().gridData || {};
        const existingData = gridData[position] || {};
        const mergedData = { ...existingData, ...dataToSave, updatedAt: serverTimestamp() };
        
        await updateDoc(gridDocRef, {
            [`gridData.${position}`]: mergedData,
            'lastModified': serverTimestamp()
        });
    }

    async function swapBoxDataInFirestore(pos1, pos2) {
        if (!gridDocRef) return false;
        const { getDoc, updateDoc, serverTimestamp } = window.firebase;
        const docSnap = await getDoc(gridDocRef);
        if (!docSnap.exists()) return false;
        
        const gridData = docSnap.data().gridData || {};
        const data1 = gridData[pos1] ? { ...gridData[pos1] } : null;
        const data2 = gridData[pos2] ? { ...gridData[pos2] } : null;

        const updates = {};
        updates[`gridData.${pos1}`] = data2;
        updates[`gridData.${pos2}`] = data1;
        if(updates[`gridData.${pos1}`]) updates[`gridData.${pos1}`].updatedAt = serverTimestamp();
        if(updates[`gridData.${pos2}`]) updates[`gridData.${pos2}`].updatedAt = serverTimestamp();
        updates.lastModified = serverTimestamp();

        await updateDoc(gridDocRef, updates);
        console.log(`✅ Swapped data in Firestore: ${pos1} ↔ ${pos2}`);
        return true;
    }

  async function archiveAndDeleteBox(position){
    if(!gridDocRef) return;
    const { getDoc, addDoc, collection, serverTimestamp } = window.firebase;
    try {
      const snap = await getDoc(gridDocRef);
      if(!snap.exists()) return;
      const gridData = snap.data().gridData || {};
      const boxData = gridData[position];
      // Pokud není co archivovat, jen smažeme (bude řešit updateBoxDataInFirestore)
      if(!boxData){
        await updateBoxDataInFirestore(position, null);
        return;
      }
      const retentionMs = ARCHIVE_RETENTION_DAYS * 24 * 60 * 60 * 1000;
      try {
        await addDoc(collection(window.firebase.db, ARCHIVE_COLLECTION), {
          userId: currentUser?.uid || null,
          workspaceId: currentWorkspace,
          sessionId,
          position,
          deletedAt: serverTimestamp(),
          expiresAt: new Date(Date.now() + retentionMs), // Pro Firestore TTL (nutno povolit)
          data: boxData,
          version: '2.0'
        });
      } catch(archiveErr){
        console.error('❌ Archivace selhala (proběhne jen přímé smazání):', archiveErr);
      }
      await updateBoxDataInFirestore(position, null);
      console.log(`🗑️ Box ${position} archivován a odstraněn.`);
    } catch(e){
      console.error('❌ archiveAndDeleteBox error:', e);
    }
  }

  async function loadArchiveList(limitCount = 20) {
    const listEl = document.getElementById('archive-list');
    if (!listEl || !currentWorkspace || !sessionId) return;
    listEl.innerHTML = '<div class="text-gray-400 animate-pulse">Načítám...</div>';
    try {
      const { db, collection, query, where, limit, getDocs } = window.firebase;
      const col = collection(db, ARCHIVE_COLLECTION);
      // Odstraněno orderBy('deletedAt', 'desc') z dotazu, aby se předešlo chybě indexu
      const q = query(
        col,
        where('workspaceId', '==', currentWorkspace),
        where('sessionId', '==', sessionId),
        limit(limitCount)
      );
      const snap = await getDocs(q);
      if (snap.empty) {
        listEl.innerHTML = '<div class="text-gray-400 italic">Žádné záznamy</div>';
        return;
      }
      
      // Seřazení dokumentů na straně klienta
      const sortedDocs = snap.docs.sort((a, b) => {
        const timeA = a.data().deletedAt?.toDate() || 0;
        const timeB = b.data().deletedAt?.toDate() || 0;
        return timeB - timeA; // Sestupné řazení
      });

      listEl.innerHTML = '';
      sortedDocs.forEach(docSnap => {
        const d = docSnap.data();
        const item = document.createElement('div');
        item.className = 'flex items-start gap-2 p-2 border rounded hover:bg-gray-50';
        const label = d.data?.text || (d.data?.colorStyle ? 'Barevný blok' : (d.data?.imageUrl ? 'Obrázek' : 'Obsah'));
        item.innerHTML = `
          <div class='flex-1'>
            <div class='font-medium text-[11px] leading-tight'>${d.position} – ${label}</div>
            <div class='text-[10px] text-gray-500'>Smazáno: ${d.deletedAt?.toDate ? d.deletedAt.toDate().toLocaleString() : '-'}</div>
          </div>
          <div class='flex flex-col gap-1'>
            <button data-doc='${docSnap.id}' data-pos='${d.position}' class='restore-btn text-[10px] px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600'>Obnovit</button>
          </div>`;
        listEl.appendChild(item);
      });
    } catch (e) {
      console.error('❌ loadArchiveList error', e);
      listEl.innerHTML = '<div class="text-red-500 text-xs">Chyba při načítání archivu.</div>';
    }
  }

  // (Removed corrupted duplicate calendar block – real implementation lives later in file)

  function formatBytes(bytes){
    if (bytes === undefined || bytes === null) return '—';
    if (bytes === 0) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    const index = Math.floor(Math.log(bytes) / Math.log(1024));
    return `${(bytes / Math.pow(1024, index)).toFixed(index === 0 ? 0 : 1)} ${units[index]}`;
  }

  async function fetchStorageTopLevelSummary(){
    const { storage, ref, listAll, getMetadata, getDownloadURL } = window.firebase;
    const rootRef = ref(storage);
    const rootList = await listAll(rootRef);

    const folders = await Promise.all(rootList.prefixes.map(async (prefix) => {
      let childList;
      try {
        childList = await listAll(prefix);
      } catch (err) {
        console.warn('⚠️ listAll failed for', prefix.fullPath, err);
        childList = { prefixes: [], items: [] };
      }
      const sampleItems = await Promise.all(childList.items.slice(0, 6).map(async (itemRef) => {
        let size = null;
        let contentType = null;
        let previewUrl = null;
        try {
          const metadata = await getMetadata(itemRef);
          size = metadata?.size ?? null;
          contentType = metadata?.contentType ?? null;
          if (contentType && contentType.startsWith('image/')) {
            try {
              previewUrl = await getDownloadURL(itemRef);
            } catch (previewErr) {
              console.warn('⚠️ getDownloadURL failed for', itemRef.fullPath, previewErr);
            }
          }
        } catch (metaErr) {
          console.warn('⚠️ getMetadata failed for', itemRef.fullPath, metaErr);
        }
        return {
          name: itemRef.name,
          path: itemRef.fullPath,
          size,
          contentType,
          previewUrl
        };
      }));
      let approxSize = 0;
      await Promise.all(childList.items.slice(0, 25).map(async (itemRef) => {
        try {
          const metadata = await getMetadata(itemRef);
          approxSize += metadata?.size || 0;
        } catch (metaErr) {
          console.warn('⚠️ getMetadata failed for', itemRef.fullPath, metaErr);
        }
      }));
      return {
        name: prefix.name,
        path: prefix.fullPath,
        folderCount: childList.prefixes.length,
        fileCount: childList.items.length,
        sampleItems,
        approxSize
      };
    }));

    const files = await Promise.all(rootList.items.map(async (itemRef) => {
      let size = null;
      let contentType = null;
      try {
        const metadata = await getMetadata(itemRef);
        size = metadata?.size ?? null;
        contentType = metadata?.contentType ?? null;
      } catch (err) {
        console.warn('⚠️ getMetadata failed for', itemRef.fullPath, err);
      }
      return {
        name: itemRef.name,
        path: itemRef.fullPath,
        size,
        contentType
      };
    }));

    return { folders, files };
  }

  function renderAssetsOverview(summary){
    const contentEl = document.getElementById('assets-view-content');
    const emptyEl = document.getElementById('assets-view-empty');
    if (!contentEl || !emptyEl) return;

    if (!summary || (!summary.folders.length && !summary.files.length)) {
      contentEl.innerHTML = '';
      emptyEl.textContent = 'V kořenovém adresáři Firebase Storage nejsou žádná data.';
      return;
    }

    emptyEl.textContent = '';
    contentEl.innerHTML = '';

    summary.folders.forEach(folder => {
      const card = document.createElement('div');
      card.className = 'assets-view-card';
      card.dataset.assetPath = folder.path;
      card.dataset.assetType = 'folder';
      card.innerHTML = `
        <h4>📁 ${folder.name}</h4>
        <dl>
          <dt>Cesta</dt><dd>${folder.path}</dd>
          <dt>Složky</dt><dd>${folder.folderCount}</dd>
          <dt>Soubory</dt><dd>${folder.fileCount}</dd>
          <dt>Velikost (≈)</dt><dd>${folder.approxSize ? formatBytes(folder.approxSize) : '—'}</dd>
        </dl>
        <div class='assets-view-preview'></div>
      `;
      contentEl.appendChild(card);
      const previewEl = card.querySelector('.assets-view-preview');
      if (previewEl && folder.sampleItems.length){
        folder.sampleItems.forEach(sample => {
          const item = document.createElement('div');
          item.className = 'assets-preview-item';
          const nameEl = document.createElement('div');
          nameEl.className = 'assets-preview-name';
          nameEl.textContent = sample.name;
          const sizeEl = document.createElement('div');
          sizeEl.textContent = sample.size ? formatBytes(sample.size) : '';
          if (sample.previewUrl){
            const thumb = document.createElement('img');
            thumb.className = 'assets-preview-thumb';
            thumb.alt = sample.name;
            thumb.loading = 'lazy';
            thumb.src = sample.previewUrl;
            item.appendChild(thumb);
          }
          item.appendChild(nameEl);
          if (sizeEl.textContent) item.appendChild(sizeEl);
          previewEl.appendChild(item);
        });
      }
    });

    summary.files.forEach(file => {
      const card = document.createElement('div');
      card.className = 'assets-view-card';
      card.dataset.assetPath = file.path;
      card.dataset.assetType = 'file';
      card.innerHTML = `
        <h4>📄 ${file.name}</h4>
        <dl>
          <dt>Cesta</dt><dd>${file.path}</dd>
          <dt>Typ</dt><dd>${file.contentType || '—'}</dd>
          <dt>Velikost</dt><dd>${file.size ? formatBytes(file.size) : '—'}</dd>
        </dl>
      `;
      contentEl.appendChild(card);
    });
  }

  async function loadAssetsOverview(force = false){
    const contentEl = document.getElementById('assets-view-content');
    const emptyEl = document.getElementById('assets-view-empty');
    if (!contentEl || !emptyEl) return;

    if (!isFirebaseReady || !currentUser) {
      contentEl.innerHTML = '';
      emptyEl.textContent = 'Pro zobrazení obsahu Storage se přihlaste.';
      return;
    }

    if (assetsLoading) return;
    if (assetsLoadedOnce && !force) return;

    assetsLoading = true;
    emptyEl.textContent = '';
    contentEl.innerHTML = '<div class="text-sm text-gray-500">Načítám obsah Firebase Storage...</div>';

    try {
    const summary = await fetchStorageTopLevelSummary();
    renderAssetsOverview(summary);
    assetsSummaryCache = summary;
    assetsLoadedOnce = true;
  } catch (err) {
      console.error('❌ loadAssetsOverview error', err);
      contentEl.innerHTML = '';
      emptyEl.textContent = 'Obsah se nepodařilo načíst. Zkuste to prosím znovu.';
    } finally {
      assetsLoading = false;
    }
  }

  function renderGalleryView(files){
    const gridEl = document.getElementById('gallery-view-grid');
    const emptyEl = document.getElementById('gallery-view-empty');
    if (!gridEl || !emptyEl) return;
    if (!files || !files.length){
      gridEl.innerHTML = '';
      emptyEl.textContent = 'Žádné obrázky se nepodařilo najít.';
      return;
    }
    emptyEl.textContent = '';
    gridEl.innerHTML = '';
    files.forEach(file => {
      const card = document.createElement('div');
      card.className = 'gallery-item';
      const img = document.createElement('img');
      img.loading = 'lazy';
      img.alt = file.name;
      img.src = file.url || '';
      if (!file.url) img.style.display = 'none';
      card.appendChild(img);
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        <strong>${file.name}</strong>
        <span>${file.contentType || '—'}</span>
        <span>${file.size ? formatBytes(file.size) : '—'}</span>
        <span>${file.path}</span>
      `;
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'gallery-delete-btn';
      deleteBtn.textContent = 'Smazat';
      deleteBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        deleteGalleryFile(file);
      });
      meta.appendChild(deleteBtn);
      card.appendChild(meta);
      gridEl.appendChild(card);
    });
  }

  function updateGalleryFilterOptions(files){
    const filterSelect = document.getElementById('gallery-filter');
    if (!filterSelect) return;
    const options = new Set(['all']);
    (files || []).forEach(file => {
      const key = file.topLevel || GALLERY_ROOT_LABEL;
      options.add(key);
    });
    const previous = galleryFilterPrefix;
    filterSelect.innerHTML = '';
    options.forEach(value => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value === 'all' ? 'Všechny složky' : (value === GALLERY_ROOT_LABEL ? 'Kořen (root)' : value);
      filterSelect.appendChild(option);
    });
    if (!options.has(previous)) {
      galleryFilterPrefix = 'all';
    }
    filterSelect.value = galleryFilterPrefix;
  }

  function applyGalleryFilters(){
    if (!galleryCache) return [];
    let filtered = galleryCache;
    if (galleryFilterPrefix !== 'all'){
      filtered = filtered.filter(file => (file.topLevel || GALLERY_ROOT_LABEL) === galleryFilterPrefix);
    }
    filtered = [...filtered].sort((a, b) => {
      const sizeA = a.size || 0;
      const sizeB = b.size || 0;
      return gallerySortOrder === 'asc' ? sizeA - sizeB : sizeB - sizeA;
    });
    return filtered;
  }

  async function loadGalleryOverview(force = false){
    const gridEl = document.getElementById('gallery-view-grid');
    const emptyEl = document.getElementById('gallery-view-empty');
    if (!gridEl || !emptyEl) return;

    if (!isFirebaseReady || !currentUser) {
      gridEl.innerHTML = '';
      emptyEl.textContent = 'Pro zobrazení galerie se přihlaste.';
      return;
    }

    if (galleryLoading) return;
    if (galleryLoadedOnce && !force && galleryCache) {
      updateGalleryFilterOptions(galleryCache);
      renderGalleryView(applyGalleryFilters());
      return;
    }

    galleryLoading = true;
    emptyEl.textContent = 'Načítám obrázky z Firebase Storage...';
    gridEl.innerHTML = '';

    try {
      const { storage, ref } = window.firebase;
      const rootRef = ref(storage);
      const files = await collectFilesRecursively(rootRef, { limit: 300, imagesOnly: true });
      galleryCache = files;
      galleryLoadedOnce = true;
      updateGalleryFilterOptions(files);
      renderGalleryView(applyGalleryFilters());
    } catch (err) {
      console.error('❌ loadGalleryOverview error', err);
      gridEl.innerHTML = '';
      emptyEl.textContent = 'Galerii se nepodařilo načíst. Zkuste to prosím znovu.';
    } finally {
      galleryLoading = false;
    }
  }

  async function deleteGalleryFile(file){
    if (!file || !file.path) return;
    if (!confirm(`Opravdu odstranit soubor "${file.name}"?`)) return;
    try {
      const { storage, ref, deleteObject } = window.firebase;
      await deleteObject(ref(storage, file.path));
      galleryCache = (galleryCache || []).filter(item => item.path !== file.path);
      galleryLoadedOnce = true;
      updateGalleryFilterOptions(galleryCache);
      renderGalleryView(applyGalleryFilters());
      assetsLoadedOnce = false;
      loadAssetsOverview(true);
      showBanner('Soubor byl odstraněn ze Storage.', 'info');
    } catch (err) {
      console.error('❌ deleteGalleryFile error', err);
      showBanner('Smazání souboru se nezdařilo.', 'error');
    }
  }

  function closeAssetsModal(){
    const backdrop = document.getElementById('assets-modal-backdrop');
    if (!backdrop) return;
    backdrop.classList.remove('active');
    document.body.classList.remove('assets-modal-open');
  }

  const GALLERY_ROOT_LABEL = '[root]';

  async function collectFilesRecursively(rootRef, { limit = 200, imagesOnly = false, initialTopLevel = null } = {}){
    const { listAll, getMetadata, getDownloadURL } = window.firebase;
    const queue = [{ ref: rootRef, topLevel: initialTopLevel }];
    const files = [];

    while (queue.length && files.length < limit){
      const { ref: currentRef, topLevel: currentTop } = queue.shift();
      try {
        const { prefixes, items } = await listAll(currentRef);
        prefixes.forEach(prefix => {
          const nextTop = currentTop ?? (prefix.fullPath ? prefix.fullPath.split('/')[0] : prefix.name || GALLERY_ROOT_LABEL);
          queue.push({ ref: prefix, topLevel: nextTop });
        });
        for (const itemRef of items){
          if (files.length >= limit) break;
          try {
            const metadata = await getMetadata(itemRef);
            const isImage = metadata?.contentType?.startsWith('image/');
            if (imagesOnly && !isImage) continue;
            const url = isImage ? await getDownloadURL(itemRef) : null;
            const topLevel = currentTop ?? (itemRef.fullPath.includes('/') ? itemRef.fullPath.split('/')[0] : GALLERY_ROOT_LABEL);
            files.push({
              name: itemRef.name,
              path: itemRef.fullPath,
              size: metadata?.size ?? null,
              contentType: metadata?.contentType ?? null,
              url,
              topLevel
            });
          } catch (err) {
            console.warn('⚠️ Unable to load metadata for', itemRef.fullPath, err);
          }
        }
      } catch (err) {
        console.warn('⚠️ listAll failed for', currentRef.fullPath, err);
      }
    }
    return files;
  }

  async function openAssetsModalForFolder(folderPath){
    const { storage, ref } = window.firebase;
    const backdrop = document.getElementById('assets-modal-backdrop');
    const titleEl = document.getElementById('assets-modal-title');
    const summaryEl = document.getElementById('assets-modal-summary');
    const gridEl = document.getElementById('assets-modal-grid');
    const emptyEl = document.getElementById('assets-modal-empty');
    if (!backdrop || !titleEl || !summaryEl || !gridEl || !emptyEl) return;

    backdrop.classList.add('active');
    document.body.classList.add('assets-modal-open');
    titleEl.textContent = `Složka: ${folderPath}`;
    summaryEl.textContent = 'Načítám obsah složky…';
    gridEl.innerHTML = '';
    emptyEl.textContent = '';

    const folderRef = ref(storage, folderPath);

    try {
      const files = await collectFilesRecursively(folderRef, { initialTopLevel: folderPath.split('/')[0] || folderPath });
      summaryEl.textContent = files.length ? `Zobrazuji ${files.length} položek (max. 200).` : 'Složka je prázdná.';
      if (!files.length){
        emptyEl.textContent = 'Žádné soubory k zobrazení.';
        return;
      }
      files.forEach(file => {
        const item = document.createElement('div');
        item.className = 'assets-modal-item';
        if (file.url){
          const img = document.createElement('img');
          img.className = 'assets-modal-thumb';
          img.src = file.url;
          img.alt = file.name;
          img.loading = 'lazy';
          item.appendChild(img);
        }
        const meta = document.createElement('div');
        meta.className = 'assets-modal-meta';
        meta.innerHTML = `
          <strong>${file.name}</strong><br>
          <span>${file.contentType || '—'}</span><br>
          <span>${file.size ? formatBytes(file.size) : '—'}</span><br>
          <span>${file.path}</span>
        `;
        item.appendChild(meta);
        gridEl.appendChild(item);
      });
    } catch (err) {
      console.error('❌ openAssetsModalForFolder error', err);
      summaryEl.textContent = 'Načítání složky selhalo.';
    }
  }

  async function openAssetsModalForFile(filePath){
    const { storage, ref, getMetadata, getDownloadURL } = window.firebase;
    const backdrop = document.getElementById('assets-modal-backdrop');
    const titleEl = document.getElementById('assets-modal-title');
    const summaryEl = document.getElementById('assets-modal-summary');
    const gridEl = document.getElementById('assets-modal-grid');
    const emptyEl = document.getElementById('assets-modal-empty');
    if (!backdrop || !titleEl || !summaryEl || !gridEl || !emptyEl) return;

    backdrop.classList.add('active');
    document.body.classList.add('assets-modal-open');
    titleEl.textContent = `Soubor: ${filePath}`;
    gridEl.innerHTML = '';
    emptyEl.textContent = '';

    const fileRef = ref(storage, filePath);
    try {
      const metadata = await getMetadata(fileRef);
      const isImage = metadata?.contentType?.startsWith('image/');
      let url = null;
      if (isImage) {
        try {
          url = await getDownloadURL(fileRef);
        } catch (err) {
          console.warn('⚠️ getDownloadURL failed for', filePath, err);
        }
      }
      summaryEl.textContent = 'Detail souboru';
      if (!url){
        emptyEl.textContent = 'Soubor není obrázek nebo nelze načíst náhled.';
      } else {
        const img = document.createElement('img');
        img.className = 'assets-modal-thumb';
        img.src = url;
        img.alt = metadata.name || 'image';
        img.style.maxWidth = '100%';
        gridEl.appendChild(img);
      }
      const meta = document.createElement('div');
      meta.className = 'assets-modal-meta';
      meta.innerHTML = `
        <strong>${metadata.name}</strong><br>
        <span>${metadata.contentType || '—'}</span><br>
        <span>${metadata.size ? formatBytes(metadata.size) : '—'}</span><br>
        <span>${filePath}</span>
      `;
      gridEl.appendChild(meta);
    } catch (err) {
      console.error('❌ openAssetsModalForFile error', err);
      summaryEl.textContent = 'Načítání souboru selhalo.';
    }
  }

  async function restoreArchivedBox(docId, position){
    try {
      const { db, doc, getDoc, updateDoc } = window.firebase;
      const archiveDocRef = doc(db, ARCHIVE_COLLECTION, docId);
      const snap = await getDoc(archiveDocRef);
      if(!snap.exists()) return;
      const archived = snap.data();
      const data = archived.data || {};
      await updateBoxDataInFirestore(position, data);
      await updateDoc(archiveDocRef, { restored: true, restoredAt: new Date() });
      showBanner(`Obnoveno ${position}.`, 'info');
    } catch(e){
      console.error('❌ restoreArchivedBox error', e);
      showBanner('Chyba při obnově.', 'error');
    } finally {
      loadArchiveList();
    }
  }

    async function uploadImageToStorage(fileOrBlob, position) {
        const { storage, ref, uploadBytesResumable, getDownloadURL } = window.firebase;
        
        const mime = (fileOrBlob.type && fileOrBlob.type.startsWith('image/')) ? fileOrBlob.type : 'image/png';
        const imageId = `img_${Date.now()}_${position}`;
        const fileExtension = mime.split('/')[1] || 'png';
        const fileName = `${imageId}.${fileExtension}`;
        const storagePath = `project73-images/${sessionId}/${fileName}`;
        const storageRef = ref(storage, storagePath);
        const metadata = { contentType: mime };

        const uploadTask = uploadBytesResumable(storageRef, fileOrBlob, metadata);
        
        return new Promise((resolve, reject) => {
            let progressStarted = false;
            const timeoutDuration = 15000; 

            const timeoutId = setTimeout(() => {
                if (!progressStarted) {
                    uploadTask.cancel(); 
                    console.error(`❌ Upload pro ${position} vypršel po ${timeoutDuration}ms.`);
                    reject(new Error('Upload timed out'));
                }
            }, timeoutDuration);

            uploadTask.on('state_changed',
                (snapshot) => {
                  const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                  if (snapshot.bytesTransferred > 0 && !progressStarted) {
                      progressStarted = true;
                      clearTimeout(timeoutId); 
                  }
                }, 
                (error) => { 
                    clearTimeout(timeoutId); 
                    console.error(`❌ Upload pro ${position} selhal:`, error.code, error.message);
                    
                    switch (error.code) {
                        case 'storage/unauthorized':
                            showBanner("Chyba: Nedostatečná oprávnění pro nahrání souboru.", "error");
                            break;
                        case 'storage/canceled':
                            if (!progressStarted) showBanner("Nahrávání trvá příliš dlouho.", "error");
                            break;
                        default:
                            showBanner("Neznámá chyba při nahrávání.", "error");
                            break;
                    }
                    reject(error); 
                },
                async () => {
                    clearTimeout(timeoutId); 
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        console.log(`✅ Soubor pro ${position} nahrán:`, downloadURL);
                        resolve({ url: downloadURL, id: imageId, fileName });
                    } catch(e) {
                        console.error(`❌ Chyba při získávání URL pro ${position}:`, e);
                        reject(e);
                    }
                }
            );
        });
    }

    async function processUploadQueue() {
        if (!isFirebaseReady || uploadQueue.length === 0) return;
        
        while (uploadQueue.length > 0) {
            const { blob, position, localUrl } = uploadQueue.shift();
            try {
                const imageData = await uploadImageToStorage(blob, position);

                const box = document.querySelector(`[data-position="${position}"]`);
                if (box && box.style.backgroundImage.includes(localUrl)) {
                    box.style.backgroundImage = `url(${imageData.url})`;
                }

                await updateBoxDataInFirestore(position, {
                    hasImage: true, imageUrl: imageData.url, imageId: imageData.id,
                    hasText: false, text: '', hasColor: false
                });
                console.log(`✅ Queued image uploaded and saved for ${position}`);
            } catch (error) {
                console.error(`❌ Failed to process upload queue for ${position}:`, error);
                const box = document.querySelector(`[data-position="${position}"]`);
                if (box) box.style.outline = '2px solid red';
            }
        }
    }

  // ================================================================
  // Helper: Komprese / resize obrázku na klientu před uploadem
  // - Zachová typ JPEG/PNG, ale větší PNG převádí na JPEG kvůli úspoře
  // - maxWidth / maxHeight: omezení delší hrany
  // - quality: 0..1 (použito jen pro JPEG/WebP)
  // Vrací Promise<Blob>
  async function compressImageIfNeeded(file, { maxWidth = 1600, maxHeight = 1600, quality = 0.85 } = {}) {
    if (!(file instanceof Blob)) return file;
    // Pokud je soubor menší než ~600KB, neřešíme (rychlejší)
    if (file.size < 600 * 1024) return file;
    const originalType = file.type || 'image/jpeg';
    const convertToJpeg = !/\b(jpeg|jpg|webp)\b/i.test(originalType);

    const arrayBuf = await file.arrayBuffer();
    const blobUrl = URL.createObjectURL(new Blob([arrayBuf]));
    const img = await new Promise((res, rej) => {
      const i = new Image();
      i.onload = () => res(i);
      i.onerror = rej;
      i.src = blobUrl;
    });
    URL.revokeObjectURL(blobUrl);

    let { width, height } = img;
    const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
    if (ratio < 1) { width = Math.round(width * ratio); height = Math.round(height * ratio); }

    const canvas = document.createElement('canvas');
    canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);

    const mime = convertToJpeg ? 'image/jpeg' : (originalType === 'image/png' && file.size > 2*1024*1024 ? 'image/jpeg' : originalType);

    const blobCompressed = await new Promise(resolve => canvas.toBlob(b => resolve(b || file), mime, quality));
    // Pokud komprese nepomohla (větší než originál), vrať originál
    if (blobCompressed.size >= file.size) return file;
    return blobCompressed;
  }
    
    // =================================================================================
    // --- 3. MANIPULACE S UI (DOM) ---
    // =================================================================================
    function swapBoxElementsInDOM(box1, box2) {
    const pos1 = box1.dataset.position;
    const pos2 = box2.dataset.position;

    const content1 = {
      innerHTML: box1.innerHTML,
      backgroundImage: box1.style.backgroundImage,
      background: box1.style.background,
      linkUrl: box1.dataset.linkUrl,
      linkText: box1.dataset.linkText
    };
    const content2 = {
      innerHTML: box2.innerHTML,
      backgroundImage: box2.style.backgroundImage,
      background: box2.style.background,
      linkUrl: box2.dataset.linkUrl,
      linkText: box2.dataset.linkText
    };

    // Vyčistit původní obsah (neztrácíme referenci na elementy)
    box1.innerHTML = ''; box1.style.backgroundImage = 'none'; box1.style.background = '';
    box2.innerHTML = ''; box2.style.backgroundImage = 'none'; box2.style.background = '';

    // Aplikace prohozeného obsahu
    box1.innerHTML = content2.innerHTML;
    box1.style.backgroundImage = content2.backgroundImage;
    box2.dataset.linkUrl = content1.linkUrl || '';
    box2.dataset.linkText = content1.linkText || '';

    // Optimistická aktualizace cache (aby diff re-render nesmazal lokální swap)
    const cache1 = gridDataCache[pos1];
    const cache2 = gridDataCache[pos2];
    gridDataCache[pos1] = cache2 ? { ...cache2 } : undefined;
    gridDataCache[pos2] = cache1 ? { ...cache1 } : undefined;
    if (DEBUG_DIFF) console.log('⚡ Optimistický lokální swap (cache)', pos1, '<->', pos2);
    }

    // --- RYCHLÉ LOKÁLNÍ SWAP DAT (bez innerHTML kopírování) ---
    function swapBoxDataLocal(p1, p2, gridData){
      const a = gridData[p1] ? { ...gridData[p1] } : null;
      const b = gridData[p2] ? { ...gridData[p2] } : null;
      gridData[p1] = b; gridData[p2] = a;
    }

    // Bezpečné naplnění jednoho boxu (subset render používá)
    function applySingleBoxData(box, data){
      box.innerHTML = '';
      box.style.backgroundImage = 'none';
      box.style.background = '';
      box.dataset.linkUrl = '';
      box.dataset.linkText = '';
      if (!data) return;
      if (data.hasImage && data.imageUrl){
        box.style.backgroundImage = `url(${data.imageUrl})`;
      } else if (data.hasColor && data.colorStyle){
        box.style.background = data.colorStyle;
      } else if (data.hasText && data.text){
        const span = document.createElement('span');
        span.textContent = data.text; // XSS safe
        span.style.cssText = 'color:#333; font-weight:500; font-size:14px;';
        box.appendChild(span);
        if(!data.colorStyle) box.style.background = 'linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%)';
      }
      if (data.linkUrl){
        const badge = document.createElement('div');
        badge.className = 'box-link-badge';
        badge.textContent = data.linkText || data.linkUrl;
        badge.dataset.linkUrl = data.linkUrl;
        box.dataset.linkUrl = data.linkUrl;
        box.dataset.linkText = data.linkText || data.linkUrl;
        box.appendChild(badge);
      }
    }

    function renderBoxesSubset(subset){ // subset: { 'r-c': data, ... }
      Object.entries(subset).forEach(([pos, data]) => {
        const box = document.querySelector(`.box[data-position="${pos}"]`);
        if (!box) return;
        applySingleBoxData(box, data);
        if (data) gridDataCache[pos] = { ...data }; else delete gridDataCache[pos];
      });
    }

    // Post-drag integritní kontrola – ověří, že lokální cache odpovídá serveru (řeší závodní stavy)
    function schedulePostDragIntegrityCheck(positions){
      if(!gridDocRef) return;
      // Krátké zpoždění – dá prostor Firestore listeneru dodat případný pending snapshot
      setTimeout(async () => {
        try {
          const snap = await window.firebase.getDoc(gridDocRef);
          if(!snap.exists()) return;
          const serverGrid = snap.data().gridData || {};
          const diffs = {};
          const keys = new Set([...Object.keys(serverGrid), ...Object.keys(gridDataCache)]);
          for (const k of keys){
            const a = gridDataCache[k];
            const b = serverGrid[k];
            const aStr = a ? JSON.stringify(a) : '';
            const bStr = b ? JSON.stringify(b) : '';
            if (aStr !== bStr){
              diffs[k] = b || null;
            }
          }
          const diffCount = Object.keys(diffs).length;
          if(diffCount){
            if (DEBUG_DIFF) console.log(`🛠️ Integrity diff (${diffCount}) – korekce`);
            if (diffCount <= 8){
              renderBoxesSubset(diffs);
            } else {
              renderGridData(serverGrid);
            }
          } else if (DEBUG_DIFF){
            console.log('✅ Integrity OK');
          }
        } catch(e){
          console.warn('⚠️ Integrity check selhala', e);
        }
      }, 120);
    }

    // Throttle dragover pomocí rAF
    // (rAF throttle odstraněn – přechod na dragenter/dragleave)

    function renderWorkspacePanels() {
      const container = document.querySelector('.workspace-panels');
      if (!container) return;
      container.innerHTML = '';
      for (const [id, config] of Object.entries(workspaceConfigs)) {
        const panel = document.createElement('div');
        panel.className = 'workspace-panel';
        panel.dataset.workspace = id;
        panel.title = config.name;
        panel.innerHTML = `
          <div class="workspace-panel-preview">
            ${Array.from({length: 8}).map(() => `<div class="preview-box"></div>`).join('')}
          </div>
          <div class="workspace-panel-name">${config.name}</div>
        `;
        panel.addEventListener('click', () => switchWorkspace(id));
        container.appendChild(panel);
      }
    }

    function handleGridInteraction(event) {
      const targetBox = event.target.closest('.box');
      if (!targetBox) return;

      switch (event.type) {
        case 'mouseenter':
          activeBox = targetBox;
          break;
        case 'mouseleave':
          activeBox = null;
          break;
        case 'dblclick':
          showBoxDetails(targetBox);
          break;
        case 'dragstart':
          dragSource = targetBox;
          targetBox.classList.add('dragging');
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', targetBox.dataset.position);
          break;
        case 'dragover':
          event.preventDefault();
          targetBox.classList.add('dragover');
          break;
        case 'dragleave':
          targetBox.classList.remove('dragover');
          break;
        case 'drop':
          event.preventDefault();
          targetBox.classList.remove('dragover');
          if (dragSource && dragSource !== targetBox) {
            swapBoxDataInFirestore(dragSource.dataset.position, targetBox.dataset.position);
          }
          break;
        case 'dragend':
          document.querySelectorAll('.box').forEach((box) => box.classList.remove('dragging', 'dragover'));
          dragSource = null;
          break;
        default:
          break;
      }
    }

    function initializeEventListeners() {
      const gridContainer = document.getElementById('grid-container');
      if (gridContainer) {
        ['mouseenter', 'mouseleave', 'dblclick', 'dragstart', 'dragover', 'dragleave', 'drop', 'dragend'].forEach((eventType) => {
          const useCapture = eventType === 'mouseenter' || eventType === 'mouseleave';
          gridContainer.addEventListener(eventType, handleGridInteraction, useCapture);
        });
        console.log('✅ Event delegation for grid initialized.');
      }

      const sidebarToggle = document.getElementById('sidebar-toggle');
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
          document.getElementById('sidebar')?.classList.toggle('active');
          sidebarToggle.classList.toggle('active');
        });
      }

      document.querySelectorAll('.workspace-panel').forEach((panel) => {
        panel.addEventListener('click', () => switchWorkspace(panel.dataset.workspace));
      });

      const detailClose = document.querySelector('.detail-panel-close');
      if (detailClose) {
        detailClose.addEventListener('click', () => {
          document.getElementById('detail-panel')?.classList.remove('active');
        });
      }

      const saveDescriptionBtn = document.getElementById('save-description');
      if (saveDescriptionBtn) {
        saveDescriptionBtn.addEventListener('click', async () => {
          if (!currentBoxDetails) return;
          const description = document.getElementById('box-description').value;
          await updateBoxDataInFirestore(currentBoxDetails.position, { description });
          showBanner('Popis uložen.', 'info');
        });
      }

      document.addEventListener('paste', async (event) => {
        if (!activeBox) return;
        const items = (event.clipboardData || window.clipboardData)?.items || [];
        for (const item of items) {
          if (item.type.includes('image')) {
            event.preventDefault();
            const blob = item.getAsFile();
            const position = activeBox.dataset.position;
            activeBox.classList.add('loading');
            activeBox.innerHTML = '';
            activeBox.style.backgroundImage = 'none';
            uploadQueue.push({ blob, position, box: activeBox });
            processUploadQueue();
            break;
          }
        }
      });
    }

    async function switchWorkspace(workspaceId) {
      if (workspaceId === currentWorkspace || !isFirebaseReady) return;

      console.log(`🔄 Switching to workspace ${workspaceId}`);
      document.getElementById('workspace-loading')?.classList.add('active');

      currentWorkspace = workspaceId;
      const config = workspaceConfigs[currentWorkspace];

      if (!config?.gridDocRef) {
        await initializeWorkspace(currentWorkspace);
      }

      sessionId = config.sessionId;
      gridDocRef = config.gridDocRef;

      const snap = gridDocRef ? await window.firebase.getDoc(gridDocRef) : null;
      if (snap?.exists()) {
        renderGridData(snap.data().gridData);
      }

      document.querySelectorAll('.workspace-panel').forEach((panel) => panel.classList.remove('active'));
      document.querySelector(`.workspace-panel[data-workspace="${workspaceId}"]`)?.classList.add('active');

      setupRealtimeListener();
      showBanner(`Přepnuto na ${config?.name || workspaceId}`, 'info');
      document.getElementById('workspace-loading')?.classList.remove('active');
    }

    function setupRealtimeListener() {
      if (unsubscribeListener) unsubscribeListener();
      if (!gridDocRef) return;

      console.log('[setupRealtimeListener] listening on', gridDocRef.path);
      unsubscribeListener = window.firebase.onSnapshot(
        gridDocRef,
        (snap) => {
          if (snap.exists()) {
            renderGridData(snap.data().gridData);
          }
        },
        (error) => console.error('❌ onSnapshot error:', error)
      );
    }

    async function onUserSignedIn(user) {
      currentUser = user;
      console.log('✅ User signed in:', user.uid);

      await loadUserWorkspaceConfig(user);
      if (!currentWorkspace || !workspaceConfigs[currentWorkspace]) {
        currentWorkspace = Object.keys(workspaceConfigs)[0] || 'workspace1';
      }

      await initializeWorkspace(currentWorkspace);

      const config = workspaceConfigs[currentWorkspace];
      sessionId = config.sessionId;
      gridDocRef = config.gridDocRef;

      const snap = gridDocRef ? await window.firebase.getDoc(gridDocRef) : null;
      if (snap?.exists()) {
        renderGridData(snap.data().gridData);
      }

      setupRealtimeListener();
      isFirebaseReady = true;
      updateFirebaseStatus(`Ready (${sessionId?.substring(0, 12) || 'N/A'}...)`);
      processUploadQueue();

      document.querySelector(`.workspace-panel[data-workspace="${currentWorkspace}"]`)?.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('🚀 DOM loaded, initializing app...');
      generateGrid();
      initializeEventListeners();

      const { auth, onAuthStateChanged, signInAnonymously } = window.firebase;
      onAuthStateChanged(auth, (user) => {
        if (user) {
          onUserSignedIn(user);
        } else {
          signInAnonymously(auth).catch((err) => console.error('Anonymous sign-in failed:', err));
        }
      });
    });

    async function clearCurrentWorkspace() {
      if (!gridDocRef) return;
      try {
        const snap = await window.firebase.getDoc(gridDocRef);
        if (!snap.exists()) return;
        const data = snap.data();
        const currentGrid = data.gridData || {};
        if (Object.keys(currentGrid).length === 0) {
          showBanner('Pracovní plocha je už prázdná.', 'info');
          return;
        }
        await window.firebase.updateDoc(gridDocRef, {
          gridData: {},
          'stats.filledBoxes': 0,
          'stats.emptyBoxes': 105,
          lastModified: window.firebase.serverTimestamp()
        });
        renderGridData({});
        showBanner('Plocha vyčištěna.', 'info');
      } catch (error) {
        console.error('❌ clearCurrentWorkspace error', error);
        showBanner('Chyba při čištění.', 'error');
      }
    }

    const clearWorkspaceBtn = document.getElementById('clear-workspace-btn');
    if (clearWorkspaceBtn) {
      clearWorkspaceBtn.addEventListener('click', async () => {
        if (!isFirebaseReady || !gridDocRef) {
          showBanner('Firebase ještě není připraven.', 'error');
          return;
        }
        if (confirm('Opravdu vyčistit všechny boxy této pracovní plochy?')) {
          await clearCurrentWorkspace();
        }
      });
    }

    function showBanner(message, type = 'info', timeout = 3000) {
        const container = document.getElementById('p73-status-banner');
        if (!container) return;
        const div = document.createElement('div');
        div.className = 'p73-banner' + (type === 'error' ? ' error' : '');
        div.textContent = message;
        container.innerHTML = '';
        container.appendChild(div);
        setTimeout(() => {
            if (container.contains(div)) container.removeChild(div);
        }, timeout);
    }

    function updateFirebaseStatus(status, loadTime = null) {
        const statusEl = document.getElementById('firebase-status');
        if (statusEl) statusEl.textContent = status;
        const loadTimeEl = document.getElementById('load-time-display');
        if(loadTimeEl && loadTime !== null){
            loadTimeEl.textContent = `${loadTime} ms`;
        }
    }
    
    function sameBox(a, b){
      if (!a && !b) return true;
      if (!a || !b) return false;
      return (
        !!a.hasImage === !!b.hasImage && (a.imageUrl||'') === (b.imageUrl||'') &&
        !!a.hasText  === !!b.hasText  && (a.text||'')     === (b.text||'') &&
        !!a.hasColor === !!b.hasColor && (a.colorStyle||'')=== (b.colorStyle||'') &&
        (a.linkUrl||'') === (b.linkUrl||'') && (a.linkText||'') === (b.linkText||'')
      );
    }
    function renderGridData(gridData = {}){
      let changed = 0;
      document.querySelectorAll('.box').forEach(box => {
        const pos = box.dataset.position;
        const newData = gridData[pos];
        const oldData = gridDataCache[pos];
        if (sameBox(oldData, newData)) return;
        applySingleBoxData(box, newData);
        if (newData) gridDataCache[pos] = { ...newData }; else delete gridDataCache[pos];
        changed++;
      });
      if (DEBUG_DIFF) console.log('diff changed:', changed);
    }

    function closeDetailPanel() {
        const detailPanel = document.getElementById('detail-panel');
        if (detailPanel.classList.contains('active')) {
            detailPanel.classList.remove('active');
            currentBoxDetails = null;
        }
    }

    async function showBoxDetails(box) {
        const position = box.dataset.position;
        if (!gridDocRef) return;
        
        const snap = await window.firebase.getDoc(gridDocRef);
        if (!snap.exists()) return;

        const gridData = snap.data().gridData || {};
        const boxData = gridData[position] || {};
        currentBoxDetails = { position, data: boxData };

        document.getElementById('box-position').textContent = position;
        const boxPreviewEl = document.getElementById('box-preview');
        // ... (logika pro vyplnění detailů zůstává stejná)
        document.getElementById('box-description').value = boxData.description || '';
        document.getElementById('detail-panel').classList.add('active');
    }

    function generateGrid() {
        const gridContainer = document.getElementById('grid-container');
        if (!gridContainer) return;

        for (let r = 1; r <= 7; r++) {
            const row = document.createElement('div');
            row.className = 'row';
            for (let c = 1; c <= 15; c++) {
                const box = document.createElement('div');
                box.className = 'box';
                box.dataset.position = `${r}-${c}`;
                box.setAttribute("draggable", "true");
                row.appendChild(box);
            }
            gridContainer.appendChild(row);
        }
        console.log('✅ Grid HTML generated.');
    }
    
    // =================================================================================
    // --- 4. APLIKAČNÍ LOGIKA (WORKFLOWS) ---
    // =================================================================================

    function startTextEdit(box) {
        if (isEditingText) return;

        const docSnapPromise = window.firebase.getDoc(gridDocRef);
        docSnapPromise.then(docSnap => {
            if (!docSnap.exists()) return;
            const gridData = docSnap.data().gridData || {};
            const boxData = gridData[box.dataset.position] || {};
            if (boxData.hasImage) {
                showBanner('Obrázek nelze přejmenovat, pouze text.', 'error');
                return;
            }

            isEditingText = true;
            const currentText = box.querySelector('span')?.textContent || '';
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'w-full h-full border-none outline-none bg-white/90 text-center font-sans text-sm p-2 rounded-lg ring-2 ring-blue-500';
            
            box.innerHTML = '';
            box.appendChild(input);
            input.focus();
            input.select();

            const save = async () => {
                if (!isEditingText) return;
                const newText = input.value.trim();
                box.innerHTML = `<span style="color: #333; font-weight: 500; font-size: 14px;">${newText}</span>`;
                isEditingText = false;

                if (newText !== currentText) {
                    await updateBoxDataInFirestore(box.dataset.position, { hasText: true, text: newText, hasImage: false });
                }
            };
            
            input.addEventListener('blur', save);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') {
                    isEditingText = false;
                    box.innerHTML = `<span style="color: #333; font-weight: 500; font-size: 14px;">${currentText}</span>`;
                }
            });
        });
    }

    async function handleNavAction(action, position) {
        const box = document.querySelector(`[data-position="${position}"]`);
        if (!box) return;

        switch(action) {
            case 'rename':
                startTextEdit(box);
                break;
            case 'link':
                const url = prompt('Zadejte URL adresu:', 'https://');
                if (url) {
                    await updateBoxDataInFirestore(position, { linkUrl: url, linkText: url.split('/')[2] });
                }
                break;
            case 'color':
                const colors = ['#e0f2fe', '#fce7f3', '#dcfce7', '#fef3c7'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                await updateBoxDataInFirestore(position, { hasColor: true, colorStyle: randomColor, hasImage: false, hasText: false });
                break;
            case 'delete':
        // Okamžité smazání bez potvrzení + archivace pro obnovu
        await archiveAndDeleteBox(position);
                break;
        }
    }


    async function handleAddNewProject() {
      const projectName = prompt("Zadejte název nového projektu:", "Nový projekt");
      if (!projectName || projectName.trim() === '') {
        showBanner("Název projektu nemůže být prázdný.", "error");
        return;
      }

      document.getElementById('workspace-loading').classList.add('active');
      
      const newWorkspaceId = `ws_${Date.now()}`;
      const newCollectionName = `project73_${newWorkspaceId}`;

      workspaceConfigs[newWorkspaceId] = {
        name: projectName,
        collection: newCollectionName,
        sessionId: null,
        gridDocRef: null
      };

      try {
        await window.firebase.updateDoc(userWorkspacesDocRef, {
          workspaces: prepareWorkspacePayload(workspaceConfigs)
        });
        
        renderWorkspacePanels();
        await switchWorkspace(newWorkspaceId);

        showBanner(`Projekt "${projectName}" byl úspěšně vytvořen.`, 'info');

      } catch (error) {
        console.error("❌ Error creating new project:", error);
        showBanner("Nepodařilo se vytvořit nový projekt.", "error");
        delete workspaceConfigs[newWorkspaceId];
      } finally {
        document.getElementById('workspace-loading').classList.remove('active');
      }
    }

    async function initializeWorkspace(workspaceId) {
        const config = workspaceConfigs[workspaceId];
        const { db, doc, setDoc, serverTimestamp } = window.firebase;
        const fingerprint = getBrowserFingerprint();
        const userId = currentUser.uid;
        
        const newSessionId = `${workspaceId}_${Date.now()}_${userId.slice(0, 8)}`;
        config.sessionId = newSessionId;
        config.gridDocRef = doc(db, config.collection, config.sessionId);

        const sessionData = {
            userId, sessionId: newSessionId, workspaceId, browserFingerprint: fingerprint,
            gridData: {},
            stats: { totalBoxes: 105, filledBoxes: 0, emptyBoxes: 105, isActive: true },
            metadata: { version: "2.0", project: "Project_73", workspace: workspaceId, gridSize: "15x7" },
            created: serverTimestamp(),
            lastModified: serverTimestamp(),
            lastAccessed: serverTimestamp()
        };

        await setDoc(config.gridDocRef, sessionData);
        console.log(`✅ Created new session for ${workspaceId}:`, newSessionId);
        return { sessionId: newSessionId, gridDocRef: config.gridDocRef };
    }

    async function updateBoxDataInFirestore(position, dataToSave) {
        if (!gridDocRef) return;
        const { updateDoc, getDoc, serverTimestamp, doc: fbDoc } = window.firebase;

        if (dataToSave === null) {
            const docSnap = await getDoc(gridDocRef);
            if (docSnap.exists()) {
                const updatedGridData = { ...docSnap.data().gridData };
                delete updatedGridData[position];
                await updateDoc(gridDocRef, {
                    gridData: updatedGridData,
                    'lastModified': serverTimestamp()
                });
            }
            return;
        }

        const docSnap = await getDoc(gridDocRef);
        if (!docSnap.exists()) return;

        const gridData = docSnap.data().gridData || {};
        const existingData = gridData[position] || {};
        const mergedData = { ...existingData, ...dataToSave, updatedAt: serverTimestamp() };
        
        await updateDoc(gridDocRef, {
            [`gridData.${position}`]: mergedData,
            'lastModified': serverTimestamp()
        });
    }

    async function swapBoxDataInFirestore(pos1, pos2) {
        if (!gridDocRef) return false;
        const { getDoc, updateDoc, serverTimestamp } = window.firebase;
        const docSnap = await getDoc(gridDocRef);
        if (!docSnap.exists()) return false;
        
        const gridData = docSnap.data().gridData || {};
        const data1 = gridData[pos1] ? { ...gridData[pos1] } : null;
        const data2 = gridData[pos2] ? { ...gridData[pos2] } : null;

        const updates = {};
        updates[`gridData.${pos1}`] = data2;
        updates[`gridData.${pos2}`] = data1;
        if(updates[`gridData.${pos1}`]) updates[`gridData.${pos1}`].updatedAt = serverTimestamp();
        if(updates[`gridData.${pos2}`]) updates[`gridData.${pos2}`].updatedAt = serverTimestamp();
        updates.lastModified = serverTimestamp();

        await updateDoc(gridDocRef, updates);
        console.log(`✅ Swapped data in Firestore: ${pos1} ↔ ${pos2}`);
        return true;
    }

  async function archiveAndDeleteBox(position){
    if(!gridDocRef) return;
    const { getDoc, addDoc, collection, serverTimestamp } = window.firebase;
    try {
      const snap = await getDoc(gridDocRef);
      if(!snap.exists()) return;
      const gridData = snap.data().gridData || {};
      const boxData = gridData[position];
      // Pokud není co archivovat, jen smažeme (bude řešit updateBoxDataInFirestore)
      if(!boxData){
        await updateBoxDataInFirestore(position, null);
        return;
      }
      const retentionMs = ARCHIVE_RETENTION_DAYS * 24 * 60 * 60 * 1000;
      try {
        await addDoc(collection(window.firebase.db, ARCHIVE_COLLECTION), {
          userId: currentUser?.uid || null,
          workspaceId: currentWorkspace,
          sessionId,
          position,
          deletedAt: serverTimestamp(),
          expiresAt: new Date(Date.now() + retentionMs), // Pro Firestore TTL (nutno povolit)
          data: boxData,
          version: '2.0'
        });
      } catch(archiveErr){
        console.error('❌ Archivace selhala (proběhne jen přímé smazání):', archiveErr);
      }
      await updateBoxDataInFirestore(position, null);
      console.log(`🗑️ Box ${position} archivován a odstraněn.`);
    } catch(e){
      console.error('❌ archiveAndDeleteBox error:', e);
    }
  }

  async function loadArchiveList(limitCount = 20) {
    const listEl = document.getElementById('archive-list');
    if (!listEl || !currentWorkspace || !sessionId) return;
    listEl.innerHTML = '<div class="text-gray-400 animate-pulse">Načítám...</div>';
    try {
      const { db, collection, query, where, limit, getDocs } = window.firebase;
      const col = collection(db, ARCHIVE_COLLECTION);
      // Odstraněno orderBy('deletedAt', 'desc') z dotazu, aby se předešlo chybě indexu
      const q = query(
        col,
        where('workspaceId', '==', currentWorkspace),
        where('sessionId', '==', sessionId),
        limit(limitCount)
      );
      const snap = await getDocs(q);
      if (snap.empty) {
        listEl.innerHTML = '<div class="text-gray-400 italic">Žádné záznamy</div>';
        return;
      }
      
      // Seřazení dokumentů na straně klienta
      const sortedDocs = snap.docs.sort((a, b) => {
        const timeA = a.data().deletedAt?.toDate() || 0;
        const timeB = b.data().deletedAt?.toDate() || 0;
        return timeB - timeA; // Sestupné řazení
      });

      listEl.innerHTML = '';
      sortedDocs.forEach(docSnap => {
        const d = docSnap.data();
        const item = document.createElement('div');
        item.className = 'flex items-start gap-2 p-2 border rounded hover:bg-gray-50';
        const label = d.data?.text || (d.data?.colorStyle ? 'Barevný blok' : (d.data?.imageUrl ? 'Obrázek' : 'Obsah'));
        item.innerHTML = `
          <div class='flex-1'>
            <div class='font-medium text-[11px] leading-tight'>${d.position} – ${label}</div>
            <div class='text-[10px] text-gray-500'>Smazáno: ${d.deletedAt?.toDate ? d.deletedAt.toDate().toLocaleString() : '-'}</div>
          </div>
          <div class='flex flex-col gap-1'>
            <button data-doc='${docSnap.id}' data-pos='${d.position}' class='restore-btn text-[10px] px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600'>Obnovit</button>
          </div>`;
        listEl.appendChild(item);
      });
    } catch (e) {
      console.error('❌ loadArchiveList error', e);
      listEl.innerHTML = '<div class="text-red-500 text-xs">Chyba při načítání archivu.</div>';
    }
  }

  // ================= Odložené úkoly =================
  const DEFERRED_COLLECTION = 'project73_deferredTasks';
  let unsubscribeDeferred = null;

  async function addDeferredTask(title){
    if(!title || !currentWorkspace || !sessionId) return;
    try {
      const { db, collection, addDoc, serverTimestamp } = window.firebase;
      await addDoc(collection(db, DEFERRED_COLLECTION), {
        userId: currentUser?.uid || null,
        workspaceId: currentWorkspace,
        sessionId,
        title: title.trim(),
        status: 'open',
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        version: '1.0'
      });
    } catch(e){
      console.error('❌ addDeferredTask error', e);
      showBanner('Chyba při ukládání úkolu', 'error');
    }
  }

  async function toggleDeferredTask(docId, currentStatus){
    try {
      const { db, doc, updateDoc, serverTimestamp } = window.firebase;
      const ref = doc(db, DEFERRED_COLLECTION, docId);
      await updateDoc(ref, { status: currentStatus === 'open' ? 'done' : 'open', updatedAt: serverTimestamp() });
    } catch(e){
      console.error('❌ toggleDeferredTask error', e);
    }
  }

  async function dropDeferredTask(docId){
    try {
      const { db, doc, updateDoc, serverTimestamp } = window.firebase;
      const ref = doc(db, DEFERRED_COLLECTION, docId);
      await updateDoc(ref, { status: 'dropped', updatedAt: serverTimestamp() });
    } catch(e){
      console.error('❌ dropDeferredTask error', e);
    }
  }

  function renderDeferredTaskList(snapshot){
    const listEl = document.getElementById('deferred-list');
    if(!listEl) return;
    if (snapshot.empty){
      listEl.innerHTML = '<div class="text-gray-400 italic">Žádné úkoly</div>';
      return;
    }

    // Seřazení dokumentů na straně klienta, abychom se vyhnuli potřebě indexu
    const sortedDocs = snapshot.docs.sort((a, b) => {
        const timeA = a.data().createdAt?.toDate() || 0;
        const timeB = b.data().createdAt?.toDate() || 0;
        return timeB - timeA; // Sestupné řazení
    });

    listEl.innerHTML = '';
    sortedDocs.forEach(docSnap => {
      const d = docSnap.data();
      if (d.status === 'dropped') return; // skryjeme odložené definitivně
      const item = document.createElement('div');
      const statusColor = d.status === 'done' ? 'bg-green-500' : 'bg-amber-500';
      item.className = 'flex items-center gap-2 p-2 border rounded hover:bg-gray-50';
      item.innerHTML = `
        <button data-task-toggle='${docSnap.id}' class='w-4 h-4 rounded-full ${statusColor} focus:outline-none'></button>
        <div class='flex-1 text-[12px] ${d.status === 'done' ? 'line-through text-gray-400' : ''}'>${d.title}</div>
        <button data-task-drop='${docSnap.id}' class='text-[10px] px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded'>×</button>
      `;
      listEl.appendChild(item);
    });
  }

  function initDeferredTasksListener(){
    if (unsubscribeDeferred) { unsubscribeDeferred(); unsubscribeDeferred = null; }
    if(!currentWorkspace || !sessionId) return;
    try {
      const { db, collection, query, where, onSnapshot, limit } = window.firebase;
      const col = collection(db, DEFERRED_COLLECTION);
      const q = query(
        col,
        where('workspaceId', '==', currentWorkspace),
        where('sessionId', '==', sessionId),
        limit(50)
      );
      unsubscribeDeferred = onSnapshot(q, (snap) => {
        renderDeferredTaskList(snap);
      }, (err) => {
        console.error('❌ deferredTasks listener error', err);
      });
    } catch(e){
      console.error('❌ initDeferredTasksListener error', e);
    }
  }

  // ================= Kalendářové události =================
  const CALENDAR_COLLECTION = 'project73_calendarEvents';
  let unsubscribeCalendar = null;

  async function addCalendarEvent(title, dateValue){
    if (!title || !dateValue || !currentWorkspace || !sessionId || !currentUser?.uid) {
      showBanner('Vyplň název i datum události.', 'error');
      return false;
    }
    try {
      const parsedDate = new Date(`${dateValue}T00:00:00`);
      if (Number.isNaN(parsedDate.getTime())) {
        showBanner('Datum události není platné.', 'error');
        return false;
      }
      // Použijeme Timestamp pro správné uložení data
      const { db, collection, addDoc, serverTimestamp, Timestamp } = window.firebase;
      const dayKey = parsedDate.toISOString().slice(0,10).replace(/-/g,''); // YYYYMMDD
      await addDoc(collection(db, CALENDAR_COLLECTION), {
        userId: currentUser.uid,
        workspaceId: currentWorkspace,
        sessionId,
        title: title.trim(),
        eventDate: Timestamp.fromDate(parsedDate), // Převod JS Date na Firestore Timestamp
        dayKey,
        allDay: true,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      return true;
    } catch (e) {
      console.error('❌ addCalendarEvent error', e);
      showBanner('Událost se nepodařilo uložit.', 'error');
      return false;
    }
  }

  async function removeCalendarEvent(docId){
    if (!docId) return;
    try {
      const { db, doc, deleteDoc } = window.firebase;
      await deleteDoc(doc(db, CALENDAR_COLLECTION, docId));
    } catch (e) {
      console.error('❌ removeCalendarEvent error', e);
      showBanner('Událost se nepodařilo odstranit.', 'error');
    }
  }

  function renderCalendarList(snapshot){
    const listEl = document.getElementById('calendar-list');
    const viewListEl = document.getElementById('calendar-view-list');
    if (!listEl) return;
    if (!snapshot || snapshot.empty){
      listEl.innerHTML = '<div class="text-gray-400 italic">Žádné události</div>';
      if (viewListEl) viewListEl.innerHTML = '<div class="text-gray-400 italic">Žádné události</div>';
      return;
    }
    const docs = snapshot.docs
      .map(docSnap => ({ id: docSnap.id, data: docSnap.data() }))
      .filter(item => item.data && item.data.title);
    docs.sort((a, b) => {
      const timeA = a.data.eventDate?.toDate ? a.data.eventDate.toDate().getTime() : 0;
      const timeB = b.data.eventDate?.toDate ? b.data.eventDate.toDate().getTime() : 0;
      return timeA - timeB;
    });

    if (!docs.length){
      listEl.innerHTML = '<div class="text-gray-400 italic">Žádné události</div>';
      if (viewListEl) viewListEl.innerHTML = '<div class="text-gray-400 italic">Žádné události</div>';
      return;
    }

    listEl.innerHTML = '';
    if (viewListEl) viewListEl.innerHTML = '';
    docs.forEach(({ id, data }) => {
      const dateLabel = data.eventDate?.toDate ? data.eventDate.toDate().toLocaleDateString() : '-';

      const container = document.createElement('div');
      container.className = 'flex items-center justify-between p-2 border rounded hover:bg-gray-50';
      container.innerHTML = `
        <div class='flex flex-col text-[11px] leading-tight'>
          <span class='font-semibold text-gray-700'>${data.title}</span>
          <span class='text-gray-500'>${dateLabel}</span>
        </div>
        <button data-calendar-remove='${id}' class='text-[10px] px-2 py-1 bg-rose-500 text-white rounded hover:bg-rose-600'>Smazat</button>
      `;
      listEl.appendChild(container);

      if (viewListEl){
        const card = document.createElement('div');
        card.className = 'calendar-view-card';
        card.innerHTML = `
          <h4>${data.title}</h4>
          <time>${dateLabel}</time>
          <button data-calendar-remove='${id}' class='text-[11px] self-start px-3 py-1 bg-rose-500 text-white rounded hover:bg-rose-600'>Smazat</button>
        `;
        viewListEl.appendChild(card);
      }
    });
  }

  function initCalendarListener(){
    if (unsubscribeCalendar) { unsubscribeCalendar(); unsubscribeCalendar = null; }
    const listEl = document.getElementById('calendar-list');
    const viewListEl = document.getElementById('calendar-view-list');
    if (listEl) listEl.innerHTML = '<div class="text-gray-400 italic">Načítám...</div>';
    if (viewListEl) viewListEl.innerHTML = '<div class="text-gray-400 italic">Načítám...</div>';
    if (!currentWorkspace || !sessionId || !currentUser?.uid) {
      if (viewListEl) viewListEl.innerHTML = '<div class="text-gray-400 italic">Pro zobrazení kalendáře se přihlaste.</div>';
      return;
    }
    try {
      const { db, collection, query, where, onSnapshot, limit } = window.firebase;
      const col = collection(db, CALENDAR_COLLECTION);
      const q = query(
        col,
        where('userId', '==', currentUser.uid),
        where('workspaceId', '==', currentWorkspace),
        limit(100)
      );
      unsubscribeCalendar = onSnapshot(q, (snap) => {
        renderCalendarList(snap);
      }, (err) => {
        console.error('❌ calendar listener error', err);
        if (listEl) listEl.innerHTML = '<div class="text-red-500 text-xs">Chyba při načítání kalendáře.</div>';
      });
    } catch (e) {
      console.error('❌ initCalendarListener error', e);
      if (listEl) listEl.innerHTML = '<div class="text-red-500 text-xs">Kalendář nelze načíst.</div>';
    }
  }

  function formatBytes(bytes){
    if (bytes === undefined || bytes === null) return '—';
    if (bytes === 0) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    const index = Math.floor(Math.log(bytes) / Math.log(1024));
    return `${(bytes / Math.pow(1024, index)).toFixed(index === 0 ? 0 : 1)} ${units[index]}`;
  }

  async function fetchStorageTopLevelSummary(){
    const { storage, ref, listAll, getMetadata, getDownloadURL } = window.firebase;
    const rootRef = ref(storage);
    const rootList = await listAll(rootRef);

    const folders = await Promise.all(rootList.prefixes.map(async (prefix) => {
      let childList;
      try {
        childList = await listAll(prefix);
      } catch (err) {
        console.warn('⚠️ listAll failed for', prefix.fullPath, err);
        childList = { prefixes: [], items: [] };
      }
      const sampleItems = await Promise.all(childList.items.slice(0, 6).map(async (itemRef) => {
        let size = null;
        let contentType = null;
        let previewUrl = null;
        try {
          const metadata = await getMetadata(itemRef);
          size = metadata?.size ?? null;
          contentType = metadata?.contentType ?? null;
          if (contentType && contentType.startsWith('image/')) {
            try {
              previewUrl = await getDownloadURL(itemRef);
            } catch (previewErr) {
              console.warn('⚠️ getDownloadURL failed for', itemRef.fullPath, previewErr);
            }
          }
        } catch (metaErr) {
          console.warn('⚠️ getMetadata failed for', itemRef.fullPath, metaErr);
        }
        return {
          name: itemRef.name,
          path: itemRef.fullPath,
          size,
          contentType,
          previewUrl
        };
      }));
      let approxSize = 0;
      await Promise.all(childList.items.slice(0, 25).map(async (itemRef) => {
        try {
          const metadata = await getMetadata(itemRef);
          approxSize += metadata?.size || 0;
        } catch (metaErr) {
          console.warn('⚠️ getMetadata failed for', itemRef.fullPath, metaErr);
        }
      }));
      return {
        name: prefix.name,
        path: prefix.fullPath,
        folderCount: childList.prefixes.length,
        fileCount: childList.items.length,
        sampleItems,
        approxSize
      };
    }));

    const files = await Promise.all(rootList.items.map(async (itemRef) => {
      let size = null;
      let contentType = null;
      try {
        const metadata = await getMetadata(itemRef);
        size = metadata?.size ?? null;
        contentType = metadata?.contentType ?? null;
      } catch (err) {
        console.warn('⚠️ getMetadata failed for', itemRef.fullPath, err);
      }
      return {
        name: itemRef.name,
        path: itemRef.fullPath,
        size,
        contentType
      };
    }));

    return { folders, files };
  }

  function renderAssetsOverview(summary){
    const contentEl = document.getElementById('assets-view-content');
    const emptyEl = document.getElementById('assets-view-empty');
    if (!contentEl || !emptyEl) return;

    if (!summary || (!summary.folders.length && !summary.files.length)) {
      contentEl.innerHTML = '';
      emptyEl.textContent = 'V kořenovém adresáři Firebase Storage nejsou žádná data.';
      return;
    }

    emptyEl.textContent = '';
    contentEl.innerHTML = '';

    summary.folders.forEach(folder => {
      const card = document.createElement('div');
      card.className = 'assets-view-card';
      card.dataset.assetPath = folder.path;
      card.dataset.assetType = 'folder';
      card.innerHTML = `
        <h4>📁 ${folder.name}</h4>
        <dl>
          <dt>Cesta</dt><dd>${folder.path}</dd>
          <dt>Složky</dt><dd>${folder.folderCount}</dd>
          <dt>Soubory</dt><dd>${folder.fileCount}</dd>
          <dt>Velikost (≈)</dt><dd>${folder.approxSize ? formatBytes(folder.approxSize) : '—'}</dd>
        </dl>
        <div class='assets-view-preview'></div>
      `;
      contentEl.appendChild(card);
      const previewEl = card.querySelector('.assets-view-preview');
      if (previewEl && folder.sampleItems.length){
        folder.sampleItems.forEach(sample => {
          const item = document.createElement('div');
          item.className = 'assets-preview-item';
          const nameEl = document.createElement('div');
          nameEl.className = 'assets-preview-name';
          nameEl.textContent = sample.name;
          const sizeEl = document.createElement('div');
          sizeEl.textContent = sample.size ? formatBytes(sample.size) : '';
          if (sample.previewUrl){
            const thumb = document.createElement('img');
            thumb.className = 'assets-preview-thumb';
            thumb.alt = sample.name;
            thumb.loading = 'lazy';
            thumb.src = sample.previewUrl;
            item.appendChild(thumb);
          }
          item.appendChild(nameEl);
          if (sizeEl.textContent) item.appendChild(sizeEl);
          previewEl.appendChild(item);
        });
      }
    });

    summary.files.forEach(file => {
      const card = document.createElement('div');
      card.className = 'assets-view-card';
      card.dataset.assetPath = file.path;
      card.dataset.assetType = 'file';
      card.innerHTML = `
        <h4>📄 ${file.name}</h4>
        <dl>
          <dt>Cesta</dt><dd>${file.path}</dd>
          <dt>Typ</dt><dd>${file.contentType || '—'}</dd>
          <dt>Velikost</dt><dd>${file.size ? formatBytes(file.size) : '—'}</dd>
        </dl>
      `;
      contentEl.appendChild(card);
    });
  }

  async function loadAssetsOverview(force = false){
    const contentEl = document.getElementById('assets-view-content');
    const emptyEl = document.getElementById('assets-view-empty');
    if (!contentEl || !emptyEl) return;

    if (!isFirebaseReady || !currentUser) {
      contentEl.innerHTML = '';
      emptyEl.textContent = 'Pro zobrazení obsahu Storage se přihlaste.';
      return;
    }

    if (assetsLoading) return;
    if (assetsLoadedOnce && !force) return;

    assetsLoading = true;
    emptyEl.textContent = '';
    contentEl.innerHTML = '<div class="text-sm text-gray-500">Načítám obsah Firebase Storage...</div>';

    try {
    const summary = await fetchStorageTopLevelSummary();
    renderAssetsOverview(summary);
    assetsSummaryCache = summary;
    assetsLoadedOnce = true;
  } catch (err) {
      console.error('❌ loadAssetsOverview error', err);
      contentEl.innerHTML = '';
      emptyEl.textContent = 'Obsah se nepodařilo načíst. Zkuste to prosím znovu.';
    } finally {
      assetsLoading = false;
    }
  }

  function renderGalleryView(files){
    const gridEl = document.getElementById('gallery-view-grid');
    const emptyEl = document.getElementById('gallery-view-empty');
    if (!gridEl || !emptyEl) return;
    if (!files || !files.length){
      gridEl.innerHTML = '';
      emptyEl.textContent = 'Žádné obrázky se nepodařilo najít.';
      return;
    }
    emptyEl.textContent = '';
    gridEl.innerHTML = '';
    files.forEach(file => {
      const card = document.createElement('div');
      card.className = 'gallery-item';
      const img = document.createElement('img');
      img.loading = 'lazy';
      img.alt = file.name;
      img.src = file.url || '';
      if (!file.url) img.style.display = 'none';
      card.appendChild(img);
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        <strong>${file.name}</strong>
        <span>${file.contentType || '—'}</span>
        <span>${file.size ? formatBytes(file.size) : '—'}</span>
        <span>${file.path}</span>
      `;
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'gallery-delete-btn';
      deleteBtn.textContent = 'Smazat';
      deleteBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        deleteGalleryFile(file);
      });
      meta.appendChild(deleteBtn);
      card.appendChild(meta);
      gridEl.appendChild(card);
    });
  }

  function updateGalleryFilterOptions(files){
    const filterSelect = document.getElementById('gallery-filter');
    if (!filterSelect) return;
    const options = new Set(['all']);
    (files || []).forEach(file => {
      const key = file.topLevel || GALLERY_ROOT_LABEL;
      options.add(key);
    });
    const previous = galleryFilterPrefix;
    filterSelect.innerHTML = '';
    options.forEach(value => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value === 'all' ? 'Všechny složky' : (value === GALLERY_ROOT_LABEL ? 'Kořen (root)' : value);
      filterSelect.appendChild(option);
    });
    if (!options.has(previous)) {
      galleryFilterPrefix = 'all';
    }
    filterSelect.value = galleryFilterPrefix;
  }

  function applyGalleryFilters(){
    if (!galleryCache) return [];
    let filtered = galleryCache;
    if (galleryFilterPrefix !== 'all'){
      filtered = filtered.filter(file => (file.topLevel || GALLERY_ROOT_LABEL) === galleryFilterPrefix);
    }
    filtered = [...filtered].sort((a, b) => {
      const sizeA = a.size || 0;
      const sizeB = b.size || 0;
      return gallerySortOrder === 'asc' ? sizeA - sizeB : sizeB - sizeA;
    });
    return filtered;
  }

  async function loadGalleryOverview(force = false){
    const gridEl = document.getElementById('gallery-view-grid');
    const emptyEl = document.getElementById('gallery-view-empty');
    if (!gridEl || !emptyEl) return;

    if (!isFirebaseReady || !currentUser) {
      gridEl.innerHTML = '';
      emptyEl.textContent = 'Pro zobrazení galerie se přihlaste.';
      return;
    }

    if (galleryLoading) return;
    if (galleryLoadedOnce && !force && galleryCache) {
      updateGalleryFilterOptions(galleryCache);
      renderGalleryView(applyGalleryFilters());
      return;
    }

    galleryLoading = true;
    emptyEl.textContent = 'Načítám obrázky z Firebase Storage...';
    gridEl.innerHTML = '';

    try {
      const { storage, ref } = window.firebase;
      const rootRef = ref(storage);
      const files = await collectFilesRecursively(rootRef, { limit: 300, imagesOnly: true });
      galleryCache = files;
      galleryLoadedOnce = true;
      updateGalleryFilterOptions(files);
      renderGalleryView(applyGalleryFilters());
    } catch (err) {
      console.error('❌ loadGalleryOverview error', err);
      gridEl.innerHTML = '';
      emptyEl.textContent = 'Galerii se nepodařilo načíst. Zkuste to prosím znovu.';
    } finally {
      galleryLoading = false;
    }
  }

  async function deleteGalleryFile(file){
    if (!file || !file.path) return;
    if (!confirm(`Opravdu odstranit soubor "${file.name}"?`)) return;
    try {
      const { storage, ref, deleteObject } = window.firebase;
      await deleteObject(ref(storage, file.path));
      galleryCache = (galleryCache || []).filter(item => item.path !== file.path);
      galleryLoadedOnce = true;
      updateGalleryFilterOptions(galleryCache);
      renderGalleryView(applyGalleryFilters());
      assetsLoadedOnce = false;
      loadAssetsOverview(true);
      showBanner('Soubor byl odstraněn ze Storage.', 'info');
    } catch (err) {
      console.error('❌ deleteGalleryFile error', err);
      showBanner('Smazání souboru se nezdařilo.', 'error');
    }
  }

  function closeAssetsModal(){
    const backdrop = document.getElementById('assets-modal-backdrop');
    if (!backdrop) return;
    backdrop.classList.remove('active');
    document.body.classList.remove('assets-modal-open');
  }

  // (moved GALLERY_ROOT_LABEL declaration earlier to avoid duplication)

  async function collectFilesRecursively(rootRef, { limit = 200, imagesOnly = false, initialTopLevel = null } = {}){
    const { listAll, getMetadata, getDownloadURL } = window.firebase;
    const queue = [{ ref: rootRef, topLevel: initialTopLevel }];
    const files = [];

    while (queue.length && files.length < limit){
      const { ref: currentRef, topLevel: currentTop } = queue.shift();
      try {
        const { prefixes, items } = await listAll(currentRef);
        prefixes.forEach(prefix => {
          const nextTop = currentTop ?? (prefix.fullPath ? prefix.fullPath.split('/')[0] : prefix.name || GALLERY_ROOT_LABEL);
          queue.push({ ref: prefix, topLevel: nextTop });
        });
        for (const itemRef of items){
          if (files.length >= limit) break;
          try {
            const metadata = await getMetadata(itemRef);
            const isImage = metadata?.contentType?.startsWith('image/');
            if (imagesOnly && !isImage) continue;
            const url = isImage ? await getDownloadURL(itemRef) : null;
            const topLevel = currentTop ?? (itemRef.fullPath.includes('/') ? itemRef.fullPath.split('/')[0] : GALLERY_ROOT_LABEL);
            files.push({
              name: itemRef.name,
              path: itemRef.fullPath,
              size: metadata?.size ?? null,
              contentType: metadata?.contentType ?? null,
              url,
              topLevel
            });
          } catch (err) {
            console.warn('⚠️ Unable to load metadata for', itemRef.fullPath, err);
          }
        }
      } catch (err) {
        console.warn('⚠️ listAll failed for', currentRef.fullPath, err);
      }
    }
    return files;
  }

  async function openAssetsModalForFolder(folderPath){
    const { storage, ref } = window.firebase;
    const backdrop = document.getElementById('assets-modal-backdrop');
    const titleEl = document.getElementById('assets-modal-title');
    const summaryEl = document.getElementById('assets-modal-summary');
    const gridEl = document.getElementById('assets-modal-grid');
    const emptyEl = document.getElementById('assets-modal-empty');
    if (!backdrop || !titleEl || !summaryEl || !gridEl || !emptyEl) return;

    backdrop.classList.add('active');
    document.body.classList.add('assets-modal-open');
    titleEl.textContent = `Složka: ${folderPath}`;
    summaryEl.textContent = 'Načítám obsah složky…';
    gridEl.innerHTML = '';
    emptyEl.textContent = '';

    const folderRef = ref(storage, folderPath);

    try {
      const files = await collectFilesRecursively(folderRef, { initialTopLevel: folderPath.split('/')[0] || folderPath });
      summaryEl.textContent = files.length ? `Zobrazuji ${files.length} položek (max. 200).` : 'Složka je prázdná.';
      if (!files.length){
        emptyEl.textContent = 'Žádné soubory k zobrazení.';
        return;
      }
      files.forEach(file => {
        const item = document.createElement('div');
        item.className = 'assets-modal-item';
        if (file.url){
          const img = document.createElement('img');
          img.className = 'assets-modal-thumb';
          img.src = file.url;
          img.alt = file.name;
          img.loading = 'lazy';
          item.appendChild(img);
        }
        const meta = document.createElement('div');
        meta.className = 'assets-modal-meta';
        meta.innerHTML = `
          <strong>${file.name}</strong><br>
          <span>${file.contentType || '—'}</span><br>
          <span>${file.size ? formatBytes(file.size) : '—'}</span><br>
          <span>${file.path}</span>
        `;
        item.appendChild(meta);
        gridEl.appendChild(item);
      });
    } catch (err) {
      console.error('❌ openAssetsModalForFolder error', err);
      summaryEl.textContent = 'Načítání složky selhalo.';
    }
  }

  async function openAssetsModalForFile(filePath){
    const { storage, ref, getMetadata, getDownloadURL } = window.firebase;
    const backdrop = document.getElementById('assets-modal-backdrop');
    const titleEl = document.getElementById('assets-modal-title');
    const summaryEl = document.getElementById('assets-modal-summary');
    const gridEl = document.getElementById('assets-modal-grid');
    const emptyEl = document.getElementById('assets-modal-empty');
    if (!backdrop || !titleEl || !summaryEl || !gridEl || !emptyEl) return;

    backdrop.classList.add('active');
    document.body.classList.add('assets-modal-open');
    titleEl.textContent = `Soubor: ${filePath}`;
    gridEl.innerHTML = '';
    emptyEl.textContent = '';

    const fileRef = ref(storage, filePath);
    try {
      const metadata = await getMetadata(fileRef);
      const isImage = metadata?.contentType?.startsWith('image/');
      let url = null;
      if (isImage) {
        try {
          url = await getDownloadURL(fileRef);
        } catch (err) {
          console.warn('⚠️ getDownloadURL failed for', filePath, err);
        }
      }
      summaryEl.textContent = 'Detail souboru';
      if (!url){
        emptyEl.textContent = 'Soubor není obrázek nebo nelze načíst náhled.';
      } else {
        const img = document.createElement('img');
        img.className = 'assets-modal-thumb';
        img.src = url;
        img.alt = metadata.name || 'image';
        img.style.maxWidth = '100%';
        gridEl.appendChild(img);
      }
      const meta = document.createElement('div');
      meta.className = 'assets-modal-meta';
      meta.innerHTML = `
        <strong>${metadata.name}</strong><br>
        <span>${metadata.contentType || '—'}</span><br>
        <span>${metadata.size ? formatBytes(metadata.size) : '—'}</span><br>
        <span>${filePath}</span>
      `;
      gridEl.appendChild(meta);
    } catch (err) {
      console.error('❌ openAssetsModalForFile error', err);
      summaryEl.textContent = 'Načítání souboru selhalo.';
    }
  }

  async function restoreArchivedBox(docId, position){
    try {
      const { db, doc, getDoc, updateDoc } = window.firebase;
      const archiveDocRef = doc(db, ARCHIVE_COLLECTION, docId);
      const snap = await getDoc(archiveDocRef);
      if(!snap.exists()) return;
      const archived = snap.data();
      const data = archived.data || {};
      await updateBoxDataInFirestore(position, data);
      await updateDoc(archiveDocRef, { restored: true, restoredAt: new Date() });
      showBanner(`Obnoveno ${position}.`, 'info');
    } catch(e){
      console.error('❌ restoreArchivedBox error', e);
      showBanner('Chyba při obnově.', 'error');
    } finally {
      loadArchiveList();
    }
  }

    async function uploadImageToStorage(fileOrBlob, position) {
        const { storage, ref, uploadBytesResumable, getDownloadURL } = window.firebase;
        
        const mime = (fileOrBlob.type && fileOrBlob.type.startsWith('image/')) ? fileOrBlob.type : 'image/png';
        const imageId = `img_${Date.now()}_${position}`;
        const fileExtension = mime.split('/')[1] || 'png';
        const fileName = `${imageId}.${fileExtension}`;
        const storagePath = `project73-images/${sessionId}/${fileName}`;
        const storageRef = ref(storage, storagePath);
        const metadata = { contentType: mime };

        const uploadTask = uploadBytesResumable(storageRef, fileOrBlob, metadata);
        
        return new Promise((resolve, reject) => {
            let progressStarted = false;
            const timeoutDuration = 15000; 

            const timeoutId = setTimeout(() => {
                if (!progressStarted) {
                    uploadTask.cancel(); 
                    console.error(`❌ Upload pro ${position} vypršel po ${timeoutDuration}ms.`);
                    reject(new Error('Upload timed out'));
                }
            }, timeoutDuration);

            uploadTask.on('state_changed',
                (snapshot) => {
                  const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                  if (snapshot.bytesTransferred > 0 && !progressStarted) {
                      progressStarted = true;
                      clearTimeout(timeoutId); 
                  }
                }, 
                (error) => { 
                    clearTimeout(timeoutId); 
                    console.error(`❌ Upload pro ${position} selhal:`, error.code, error.message);
                    
                    switch (error.code) {
                        case 'storage/unauthorized':
                            showBanner("Chyba: Nedostatečná oprávnění pro nahrání souboru.", "error");
                            break;
                        case 'storage/canceled':
                            if (!progressStarted) showBanner("Nahrávání trvá příliš dlouho.", "error");
                            break;
                        default:
                            showBanner("Neznámá chyba při nahrávání.", "error");
                            break;
                    }
                    reject(error); 
                },
                async () => {
                    clearTimeout(timeoutId); 
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        console.log(`✅ Soubor pro ${position} nahrán:`, downloadURL);
                        resolve({ url: downloadURL, id: imageId, fileName });
                    } catch(e) {
                        console.error(`❌ Chyba při získávání URL pro ${position}:`, e);
                        reject(e);
                    }
                }
            );
        });
    }

    async function processUploadQueue() {
        if (!isFirebaseReady || uploadQueue.length === 0) return;
        
        while (uploadQueue.length > 0) {
            const { blob, position, localUrl } = uploadQueue.shift();
            try {
                const imageData = await uploadImageToStorage(blob, position);

                const box = document.querySelector(`[data-position="${position}"]`);
                if (box && box.style.backgroundImage.includes(localUrl)) {
                    box.style.backgroundImage = `url(${imageData.url})`;
                }

                await updateBoxDataInFirestore(position, {
                    hasImage: true, imageUrl: imageData.url, imageId: imageData.id,
                    hasText: false, text: '', hasColor: false
                });
                console.log(`✅ Queued image uploaded and saved for ${position}`);
            } catch (error) {
                console.error(`❌ Failed to process upload queue for ${position}:`, error);
                const box = document.querySelector(`[data-position="${position}"]`);
                if (box) box.style.outline = '2px solid red';
            }
        }
    }

  // ================================================================
  // Helper: Komprese / resize obrázku na klientu před uploadem
  // - Zachová typ JPEG/PNG, ale větší PNG převádí na JPEG kvůli úspoře
  // - maxWidth / maxHeight: omezení delší hrany
  // - quality: 0..1 (použito jen pro JPEG/WebP)
  // Vrací Promise<Blob>
  async function compressImageIfNeeded(file, { maxWidth = 1600, maxHeight = 1600, quality = 0.85 } = {}) {
    if (!(file instanceof Blob)) return file;
    // Pokud je soubor menší než ~600KB, neřešíme (rychlejší)
    if (file.size < 600 * 1024) return file;
    const originalType = file.type || 'image/jpeg';
    const convertToJpeg = !/\b(jpeg|jpg|webp)\b/i.test(originalType);

    const arrayBuf = await file.arrayBuffer();
    const blobUrl = URL.createObjectURL(new Blob([arrayBuf]));
    const img = await new Promise((res, rej) => {
      const i = new Image();
      i.onload = () => res(i);
      i.onerror = rej;
      i.src = blobUrl;
    });
    URL.revokeObjectURL(blobUrl);

    let { width, height } = img;
    const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
    if (ratio < 1) { width = Math.round(width * ratio); height = Math.round(height * ratio); }

    const canvas = document.createElement('canvas');
    canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);

    const mime = convertToJpeg ? 'image/jpeg' : (originalType === 'image/png' && file.size > 2*1024*1024 ? 'image/jpeg' : originalType);

    const blobCompressed = await new Promise(resolve => canvas.toBlob(b => resolve(b || file), mime, quality));
    // Pokud komprese nepomohla (větší než originál), vrať originál
    if (blobCompressed.size >= file.size) return file;
    return blobCompressed;
  }
    
    // =================================================================================
    // --- 3. MANIPULACE S UI (DOM) ---
    // =================================================================================
    function swapBoxElementsInDOM(box1, box2) {
    const pos1 = box1.dataset.position;
    const pos2 = box2.dataset.position;

    const content1 = {
      innerHTML: box1.innerHTML,
      backgroundImage: box1.style.backgroundImage,
      background: box1.style.background,
      linkUrl: box1.dataset.linkUrl,
      linkText: box1.dataset.linkText
    };
    const content2 = {
      innerHTML: box2.innerHTML,
      backgroundImage: box2.style.backgroundImage,
      background: box2.style.background,
      linkUrl: box2.dataset.linkUrl,
      linkText: box2.dataset.linkText
    };

    // Vyčistit původní obsah (neztrácíme referenci na elementy)
    box1.innerHTML = ''; box1.style.backgroundImage = 'none'; box1.style.background = '';
    box2.innerHTML = ''; box2.style.backgroundImage = 'none'; box2.style.background = '';

    // Aplikace prohozeného obsahu
    box1.innerHTML = content2.innerHTML;
    box1.style.backgroundImage = content2.backgroundImage;
    box2.dataset.linkUrl = content1.linkUrl || '';
    box2.dataset.linkText = content1.linkText || '';

    // Optimistická aktualizace cache (aby diff re-render nesmazal lokální swap)
    const cache1 = gridDataCache[pos1];
    const cache2 = gridDataCache[pos2];
    gridDataCache[pos1] = cache2 ? { ...cache2 } : undefined;
    gridDataCache[pos2] = cache1 ? { ...cache1 } : undefined;
    if (DEBUG_DIFF) console.log('⚡ Optimistický lokální swap (cache)', pos1, '<->', pos2);
    }

    // --- RYCHLÉ LOKÁLNÍ SWAP DAT (bez innerHTML kopírování) ---
    function swapBoxDataLocal(p1, p2, gridData){
      const a = gridData[p1] ? { ...gridData[p1] } : null;
      const b = gridData[p2] ? { ...gridData[p2] } : null;
      gridData[p1] = b; gridData[p2] = a;
    }

    // Bezpečné naplnění jednoho boxu (subset render používá)
    function applySingleBoxData(box, data){
      box.innerHTML = '';
      box.style.backgroundImage = 'none';
      box.style.background = '';
      box.dataset.linkUrl = '';
      box.dataset.linkText = '';
      if (!data) return;
      if (data.hasImage && data.imageUrl){
        box.style.backgroundImage = `url(${data.imageUrl})`;
      } else if (data.hasColor && data.colorStyle){
        box.style.background = data.colorStyle;
      } else if (data.hasText && data.text){
        const span = document.createElement('span');
        span.textContent = data.text; // XSS safe
        span.style.cssText = 'color:#333; font-weight:500; font-size:14px;';
        box.appendChild(span);
        if(!data.colorStyle) box.style.background = 'linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%)';
      }
      if (data.linkUrl){
        const badge = document.createElement('div');
        badge.className = 'box-link-badge';
        badge.textContent = data.linkText || data.linkUrl;
        badge.dataset.linkUrl = data.linkUrl;
        box.dataset.linkUrl = data.linkUrl;
        box.dataset.linkText = data.linkText || data.linkUrl;
        box.appendChild(badge);
      }
    }

    function renderBoxesSubset(subset){ // subset: { 'r-c': data, ... }
      Object.entries(subset).forEach(([pos, data]) => {
        const box = document.querySelector(`.box[data-position="${pos}"]`);
        if (!box) return;
        applySingleBoxData(box, data);
        if (data) gridDataCache[pos] = { ...data }; else delete gridDataCache[pos];
      });
    }

    // Post-drag integritní kontrola – ověří, že lokální cache odpovídá serveru (řeší závodní stavy)
    function schedulePostDragIntegrityCheck(positions){
      if(!gridDocRef) return;
      // Krátké zpoždění – dá prostor Firestore listeneru dodat případný pending snapshot
      setTimeout(async () => {
        try {
          const snap = await window.firebase.getDoc(gridDocRef);
          if(!snap.exists()) return;
          const serverGrid = snap.data().gridData || {};
          const diffs = {};
          const keys = new Set([...Object.keys(serverGrid), ...Object.keys(gridDataCache)]);
          for (const k of keys){
            const a = gridDataCache[k];
            const b = serverGrid[k];
            if (!isObjectEqual(a, b)) diffs[k] = b;
          }
          if (Object.keys(diffs).length > 0){
            if (DEBUG_DIFF) console.log("🔄 Integrační oprava po drag&drop", diffs);
            renderBoxesSubset(diffs);
          }
        } catch (e) {
          console.warn("Integrační kontrola selhala:", e);
        }
      }, 800);
    }

    function isObjectEqual(a, b){
      if (a === b) return true;
      if (!a || !b) return false;
      const keysA = Object.keys(a), keysB = Object.keys(b);
      if (keysA.length !== keysB.length) return false;
      return keysA.every(k => a[k] === b[k]);
    }

    // Deploy panel handlers with Debug mode
    document.addEventListener("DOMContentLoaded", () => {
      const deployBtn = document.getElementById("quick-deploy-btn");
      const panel = document.getElementById("deploy-panel");
      const closeBtn = document.getElementById("deploy-close");
      const copyBtn = document.getElementById("deploy-copy");
      const minBtn = document.getElementById("deploy-min");
      const deployModeBtn = document.getElementById("deploy-mode");
      const debugModeBtn = document.getElementById("debug-mode");
      const deployCommands = document.getElementById("deploy-commands");
      const debugCommands = document.getElementById("debug-commands");

      let isDebugMode = false;

      function toggleMode() {
        isDebugMode = !isDebugMode;
        if (isDebugMode) {
          deployModeBtn.style.background = "#374151";
          deployModeBtn.style.color = "#9ca3af";
          debugModeBtn.style.background = "#1e293b";
          debugModeBtn.style.color = "#cbd5e1";
          deployCommands.style.display = "none";
          debugCommands.style.display = "block";
        } else {
          deployModeBtn.style.background = "#1e293b";
          deployModeBtn.style.color = "#cbd5e1";
          debugModeBtn.style.background = "#374151";
          debugModeBtn.style.color = "#9ca3af";
          deployCommands.style.display = "block";
          debugCommands.style.display = "none";
        }
      }

      deployBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        panel.style.display = panel.style.display === "block" ? "none" : "block";
      });

      closeBtn?.addEventListener("click", () => {
        panel.style.display = "none";
      });

      deployModeBtn?.addEventListener("click", () => {
        if (isDebugMode) toggleMode();
      });

      debugModeBtn?.addEventListener("click", () => {
        if (!isDebugMode) toggleMode();
      });

      copyBtn?.addEventListener("click", async () => {
        const activeCommands = isDebugMode ? debugCommands : deployCommands;
        try {
          await navigator.clipboard.writeText(activeCommands.textContent);
          copyBtn.textContent = "Copied!";
          setTimeout(() => { copyBtn.textContent = "Copy"; }, 1000);
        } catch (e) {
          console.warn("Copy failed:", e);
        }
      });

      minBtn?.addEventListener("click", () => {
        const isMinimized = panel.style.height === "60px";
        if (isMinimized) {
          panel.style.height = "auto";
          deployCommands.style.display = isDebugMode ? "none" : "block";
          debugCommands.style.display = isDebugMode ? "block" : "none";
          minBtn.textContent = "Min";
        } else {
          panel.style.height = "60px";
          deployCommands.style.display = "none";
          debugCommands.style.display = "none";
          minBtn.textContent = "Max";
        }
      });
    });

  </script>
</body>
</html>
